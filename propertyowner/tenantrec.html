<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Roomhy - Tenant Records</title>
    <script>
        // API Configuration
        const API_URL = 'https://roomhy-backend-wqwo.onrender.com';
    </script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- SheetJS for Excel Export -->
    <script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .sidebar { background-color: #111827; color: #9ca3af; }
        .sidebar-link {
            color: #9ca3af; font-weight: 500; transition: all 0.2s ease;
            display: flex; align-items: center; padding: 0.75rem 1.5rem;
            font-size: 0.9rem; border-left: 3px solid transparent; cursor: pointer;
        }
        .sidebar-link:hover { background-color: #1f2937; color: #f3f4f6; }
        .sidebar-link.active { background-color: #1f2937; color: #ffffff; border-left-color: #a855f7; }
        
        .submenu { background-color: #0f172a; overflow: hidden; transition: max-height 0.3s ease-in-out; max-height: 0; }
        .submenu.open { max-height: 500px; }
        .submenu a { padding-left: 3.5rem; font-size: 0.85rem; }

        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 4px; }

        /* Table Styling */
        .data-table th { background-color: #f9fafb; padding: 12px; font-size: 0.75rem; text-transform: uppercase; color: #6b7280; font-weight: 600; text-align: left; }
        .data-table td { border-bottom: 1px solid #e5e7eb; padding: 12px; font-size: 0.875rem; vertical-align: middle; }
    </style>
</head>
<body class="text-slate-800">
    <div class="flex h-screen overflow-hidden">
        <!-- Sidebar -->
        <aside class="sidebar w-72 flex-shrink-0 hidden md:flex flex-col z-20 overflow-y-auto custom-scrollbar">
            <div class="h-16 flex items-center px-6 border-b border-gray-800 sticky top-0 bg-[#111827] z-10">
                 <div class="flex items-center gap-3">
                     <div class="bg-purple-600 p-1.5 rounded-lg"><i data-lucide="home" class="w-5 h-5 text-white"></i></div>
                     <div><h1 class="text-xl font-bold text-white">RoomHy</h1><span class="text-[10px] text-gray-500">OWNER PANEL</span></div>
                 </div>
            </div>
            
            <nav class="flex-1 py-6 space-y-1">
                <a href="admin.html" class="sidebar-link"><i data-lucide="layout-dashboard" class="w-5 h-5 mr-3"></i> Dashboard</a>
                <a href="properties.html" class="sidebar-link"><i data-lucide="building" class="w-5 h-5 mr-3"></i> Properties</a>
                <a href="rooms.html" class="sidebar-link"><i data-lucide="bed-double" class="w-5 h-5 mr-3"></i> Rooms</a>
                <a href="tenants.html" class="sidebar-link"><i data-lucide="users" class="w-5 h-5 mr-3"></i> Tenants</a>
                <a href="tenantrec.html" class="sidebar-link active text-white"><i data-lucide="clipboard-list" class="w-5 h-5 mr-3"></i> Tenant Records</a>
                <a href="enquiry.html" class="sidebar-link"><i data-lucide="mail" class="w-5 h-5 mr-3"></i> Enquiry</a>
                <a href="bookings.html" class="sidebar-link"><i data-lucide="calendar-check" class="w-5 h-5 mr-3"></i> Bookings</a>
                <a href="documents.html" class="sidebar-link"><i data-lucide="file-text" class="w-5 h-5 mr-3"></i> Documents</a>
                <a href="review.html" class="sidebar-link"><i data-lucide="star" class="w-5 h-5 mr-3"></i> Reviews</a>
                <a href="payment.html" class="sidebar-link"><i data-lucide="credit-card" class="w-5 h-5 mr-3"></i> Payments</a>
                <a href="#" class="sidebar-link disabled" onclick="event.preventDefault();"><i data-lucide="message-square" class="w-5 h-5 mr-3"></i> Chats</a>
                <a href="complaints.html" class="sidebar-link"><i data-lucide="alert-circle" class="w-5 h-5 mr-3"></i> Complaints</a>
                <a href="location.html" class="sidebar-link"><i data-lucide="map-pin" class="w-5 h-5 mr-3"></i> Location</a>
                <a href="ownerprofile.html" class="sidebar-link"><i data-lucide="settings" class="w-5 h-5 mr-3"></i> Profile & Settings</a>
            </nav>
        </aside>

        <!-- Main Content -->
        <div class="flex-1 flex flex-col overflow-hidden bg-[#f3f4f6]">
            <!-- Header -->
            <header class="bg-white h-16 flex items-center justify-between px-6 shadow-sm z-10">
                <div class="flex items-center">
                    <button id="mobile-menu-open" class="md:hidden mr-4 text-slate-500"><i data-lucide="menu" class="w-6 h-6"></i></button>
                    <div class="flex items-center text-sm">
                        <span class="text-slate-500 font-medium">Management</span>
                        <i data-lucide="chevron-right" class="w-4 h-4 mx-2 text-slate-400"></i>
                        <span class="text-slate-800 font-semibold">Tenant Records</span>
                    </div>
                </div>
                <div class="flex items-center gap-4">
                    <!-- Search Bar -->
                    <div class="relative">
                        <input type="text" id="tenantSearch" placeholder="Search Tenant, ID, Phone..." class="pl-9 pr-4 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-purple-500 outline-none w-64" onkeyup="filterTenants()">
                        <i data-lucide="search" class="absolute left-3 top-2.5 w-4 h-4 text-gray-400"></i>
                    </div>

                    <button class="text-slate-400 hover:text-slate-600"><i data-lucide="bell" class="w-5 h-5"></i></button>
                    <div class="relative group">
                        <button class="flex items-center gap-3 hover:bg-gray-50 p-1.5 rounded-full transition-colors">
                            <div class="w-8 h-8 rounded-full bg-purple-100 flex items-center justify-center text-purple-600 font-bold text-sm border border-purple-200" id="headerAvatar">OP</div>
                            <div class="hidden sm:block text-left">
                                <p class="text-xs font-semibold text-gray-700" id="headerName">Owner</p>
                                <p class="text-[10px] text-gray-500" id="headerAccountId">Account</p>
                            </div>
                            <i data-lucide="chevron-down" class="w-4 h-4 text-gray-400 hidden sm:block"></i>
                        </button>
                        <div class="absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg py-1 ring-1 ring-black ring-opacity-5 hidden group-hover:block z-50">
                            <a href="index.html" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 flex items-center gap-2"><i data-lucide="user" class="w-4 h-4"></i> Account</a>
                            <a href="ownerprofile.html" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 flex items-center gap-2"><i data-lucide="user-circle" class="w-4 h-4"></i> My Profile</a>
                            <a href="#" id="logoutBtn" class="block px-4 py-2 text-sm text-red-600 hover:bg-gray-100 flex items-center gap-2"><i data-lucide="log-out" class="w-4 h-4"></i> Logout</a>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Mobile Sidebar -->
            <div id="mobile-menu" class="md:hidden fixed inset-0 z-50 flex hidden">
                <div class="fixed inset-0 bg-black/30 backdrop-blur-sm" id="mobile-menu-overlay"></div>
                <aside class="sidebar w-72 flex-shrink-0 text-gray-300 flex flex-col relative z-10 ml-auto">
                    <div class="h-16 flex items-center justify-between px-6 border-b border-gray-800">
                        <div class="flex items-center gap-3">
                            <div class="bg-purple-600 p-1.5 rounded-lg"><i data-lucide="home" class="w-5 h-5 text-white"></i></div>
                            <div><h1 class="text-xl font-bold text-white">RoomHy</h1><span class="text-[10px] text-gray-500">OWNER PANEL</span></div>
                        </div>
                        <button id="close-mobile-menu" class="p-2 text-gray-400 hover:text-white"><i data-lucide="x" class="w-6 h-6"></i></button>
                    </div>
                    <nav class="flex-1 py-6 space-y-1">
                        <a href="admin.html" class="sidebar-link"><i data-lucide="layout-dashboard" class="w-5 h-5 mr-3"></i> Dashboard</a>
                        <a href="properties.html" class="sidebar-link"><i data-lucide="building" class="w-5 h-5 mr-3"></i> Properties</a>
                        <a href="rooms.html" class="sidebar-link"><i data-lucide="bed-double" class="w-5 h-5 mr-3"></i> Rooms</a>
                        <a href="tenantrec.html" class="sidebar-link active"><i data-lucide="clipboard-list" class="w-5 h-5 mr-3"></i> Tenant Records</a>
                        <a href="enquiry.html" class="sidebar-link"><i data-lucide="mail" class="w-5 h-5 mr-3"></i> Enquiry</a>
                        <a href="documents.html" class="sidebar-link"><i data-lucide="file-text" class="w-5 h-5 mr-3"></i> Documents</a>
                        <a href="payment.html" class="sidebar-link"><i data-lucide="credit-card" class="w-5 h-5 mr-3"></i> Payments</a>
                        <a href="booking_request.html" class="sidebar-link"><i data-lucide="calendar-check" class="w-5 h-5 mr-3"></i> Booking Requests</a>
                        <a href="ownerchat.html" class="sidebar-link"><i data-lucide="message-circle" class="w-5 h-5 mr-3"></i> Chat</a>
                        <a href="complaints.html" class="sidebar-link"><i data-lucide="alert-circle" class="w-5 h-5 mr-3"></i> Complaints</a>
                        <a href="location.html" class="sidebar-link"><i data-lucide="map-pin" class="w-5 h-5 mr-3"></i> Location</a>
                        <a href="ownerprofile.html" class="sidebar-link"><i data-lucide="user" class="w-5 h-5 mr-3"></i> Profile</a>
                        <a href="settings.html" class="sidebar-link"><i data-lucide="settings" class="w-5 h-5 mr-3"></i> Settings</a>
                    </nav>
                </aside>
            </div>

            <!-- Content -->
            <main class="flex-1 overflow-y-auto p-8">
                <div class="max-w-[1600px] mx-auto">
                    
                    <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-6">
                        <div>
                            <h1 class="text-2xl font-bold text-slate-800">Detailed Tenant Records</h1>
                            <p class="text-sm text-slate-500 mt-1">View full history, login credentials, guardian info, and status.</p>
                        </div>
                        <button onclick="exportToExcel()" class="bg-white border border-gray-300 text-gray-700 hover:bg-gray-50 px-4 py-2 rounded-lg text-sm font-medium shadow-sm flex items-center">
                            <i data-lucide="download" class="w-4 h-4 mr-2"></i> Export List
                        </button>
                    </div>

                    <div class="bg-white rounded-lg shadow overflow-hidden border border-gray-200">
                        <div class="overflow-x-auto">
                            <table class="w-full data-table" id="tenantTable">
                                <thead>
                                    <tr>
                                        <th>Tenant Identity</th>
                                        <th>Login Credentials</th>
                                        <th>Personal Details</th>
                                        <th>Room & Rent</th>
                                        <th>Location Code</th>
                                        <th>Move In / Out</th>
                                        <th>Status</th>
                                        <th>KYC Status</th> <!-- NEW COLUMN -->
                                        <th class="text-right">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="all-tenants-body">
                                    <!-- JS populates this -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </main>
        </div>
        
        <!-- Mobile Sidebar Overlay -->
        <div id="mobile-overlay" class="fixed inset-0 bg-black/50 z-30 hidden md:hidden backdrop-blur-sm" onclick="toggleMobileMenu()"></div>
        <aside id="mobile-sidebar" class="fixed inset-y-0 left-0 w-72 bg-[#111827] z-40 transform -translate-x-full transition-transform duration-300 md:hidden flex flex-col overflow-y-auto">
            <nav class="flex-1 py-4 space-y-1 px-2">
                 <a href="admin.html" class="flex items-center px-4 py-3 text-sm font-medium rounded-md text-gray-400 hover:bg-gray-800">Dashboard</a>
                 <a href="tenantrec.html" class="flex items-center px-4 py-3 text-sm font-medium rounded-md bg-gray-800 text-white border-l-4 border-purple-500">Records</a>
            </nav>
        </aside>

    </div>

    <script src="../sessionManager.js"></script>
    <script>
        lucide.createIcons();
        
        // --- Auth Guard (prefer per-tab owner session) ---
        const _tenantRecInit = () => {
            const owner = typeof getCurrentOwner === 'function' ? getCurrentOwner() : null;
            if (!owner) {
                window.location.href = 'ownerlogin.html';
                return null;
            }
            return owner;
        };

        const user = _tenantRecInit();
        if (!user) {
            // redirected
        }
        const ownerId = user ? (user.ownerId || user.loginId) : null;
        let currentOwnerId = ownerId;
        
        // --- Header Population ---
        document.addEventListener('DOMContentLoaded', () => {
            if (!user) return;
            if (document.getElementById('headerName')) {
                document.getElementById('headerName').innerText = user.name;
            }
            if (document.getElementById('headerAvatar')) {
                document.getElementById('headerAvatar').innerText = user.name.charAt(0).toUpperCase();
            }
            if (document.getElementById('headerAccountId')) {
                document.getElementById('headerAccountId').innerText = `Account: ${user.loginId || user.ownerId}`;
            }
        });
        
        // --- Logout Handler (per-tab) ---
        document.getElementById('logoutBtn').addEventListener('click', (e) => {
            e.preventDefault();
            try { sessionStorage.removeItem('owner_session'); sessionStorage.removeItem('user'); } catch(_) {}
            try { localStorage.removeItem('user'); } catch(_) {}
            window.location.href = 'ownerlogin.html';
        });
        
        // Variable to store filtered tenants for export
        let tenantsForExport = [];

        // Sidebar & Mobile Menu Logic
        function toggleMobileMenu() {
            const sidebar = document.getElementById('mobile-sidebar');
            const overlay = document.getElementById('mobile-overlay');
            if (sidebar.classList.contains('-translate-x-full')) {
                sidebar.classList.remove('-translate-x-full');
                overlay.classList.remove('hidden');
            } else {
                sidebar.classList.add('-translate-x-full');
                overlay.classList.add('hidden');
            }
        }
        document.getElementById('mobile-menu-open').addEventListener('click', toggleMobileMenu);
        document.getElementById('mobile-overlay').addEventListener('click', toggleMobileMenu);
        document.getElementById('close-mobile-menu')?.addEventListener('click', toggleMobileMenu);

        // Main Load Function
        document.addEventListener('DOMContentLoaded', () => {
            // Get Current Owner
            loadTenantRecords();
        });

        async function loadTenantRecords() {
            const tenants = JSON.parse(localStorage.getItem('roomhy_tenants') || '[]');
            // Build a property map so we can resolve property IDs to names/location codes
            let propMap = {};
            try {
                const token = localStorage.getItem('token');
                const headers = token ? { 'Authorization': 'Bearer ' + token } : {};
                const res = await fetch(API_URL + '/api/properties', { headers });
                if (res.ok) {
                    const data = await res.json();
                    const props = (data && data.success && Array.isArray(data.properties)) ? data.properties : (data.properties || []);
                    props.forEach(p => {
                        const id = p._id || p.id || p.propertyId || p.name || p.title;
                        propMap[id] = p;
                    });
                }
            } catch (err) {
                // ignore and fallback to localStorage below
            }

            // Merge local properties as fallback
            try {
                const localProps = JSON.parse(localStorage.getItem('roomhy_properties') || '[]');
                localProps.forEach(lp => {
                    const id = lp.id || lp._id || lp.propertyId || lp.title || lp.name;
                    if (!propMap[id]) propMap[id] = lp;
                });
            } catch (err) {}
            const tbody = document.getElementById('all-tenants-body');
            tbody.innerHTML = '';

            // Filter Logic (Search Bar + Owner Filter)
            const search = document.getElementById('tenantSearch').value.toLowerCase();
            
            const filteredTenants = tenants.filter(t => {
                // 1. Filter by Owner (Assigned By)
                // If currentOwnerId is set, only show tenants assigned by them
                const isMyTenant = currentOwnerId ? t.assignedBy === currentOwnerId : true;

                // 2. Search Filter
                const matchesSearch = (t.name || '').toLowerCase().includes(search) ||
                                      (t.loginId || '').toLowerCase().includes(search) ||
                                      (t.phone || '').includes(search);
                
                return isMyTenant && matchesSearch;
            });
            
            // Update global variable for export
            // Resolve property references for display/export: if tenant.property is an id string, replace with object from propMap
            const resolved = filteredTenants.map(t => {
                const copy = Object.assign({}, t);
                if (copy.property && typeof copy.property === 'string') {
                    // Try by id first
                    if (propMap[copy.property]) {
                        copy.property = propMap[copy.property];
                    } else {
                        // Try to match by title/name
                        const byTitle = Object.values(propMap).find(p => (p.title || p.name) === copy.property);
                        if (byTitle) copy.property = byTitle;
                    }
                }
                return copy;
            });
            tenantsForExport = resolved;

            if (filteredTenants.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="px-6 py-8 text-center text-gray-500">No records found.</td></tr>';
                return;
            }

            resolved.forEach(t => {
                // Dates
                const moveIn = t.moveInDate ? new Date(t.moveInDate).toLocaleDateString() : '-';
                
                // Move Out Button Logic
                let moveOutHtml = '';
                if (t.status === 'moved_out') {
                    moveOutHtml = `<span class="text-red-600 font-bold text-xs bg-red-50 px-2 py-1 rounded">Left: ${t.moveOutDate ? new Date(t.moveOutDate).toLocaleDateString() : '-'}</span>`;
                } else {
                    moveOutHtml = `
                        <button onclick="moveOutTenant('${t.loginId}')" class="flex items-center gap-1 text-xs bg-white border border-red-200 text-red-600 hover:bg-red-50 px-2 py-1 rounded transition shadow-sm">
                            <i data-lucide="log-out" class="w-3 h-3"></i> Move Out
                        </button>`;
                }

                // Password Display (Usually hidden, but requested)
                const passwordDisplay = t.password ? 
                    `<span class="font-mono bg-gray-100 px-1 rounded text-gray-700 select-all" title="Current Password">${t.password}</span>` : 
                    `<span class="text-gray-400 italic">Blocked/Not Set</span>`;

                // Guardian Info
                const guardian = t.emergencyContact || '<span class="text-gray-400">-</span>';

                // Status Badge
                let statusBadge = '<span class="bg-green-100 text-green-800 px-2 py-1 rounded-full text-xs font-bold">Active</span>';
                if(t.status === 'moved_out') statusBadge = '<span class="bg-red-100 text-red-800 px-2 py-1 rounded-full text-xs font-bold">Inactive</span>';
                else if(t.status === 'pending') statusBadge = '<span class="bg-yellow-100 text-yellow-800 px-2 py-1 rounded-full text-xs font-bold">Onboarding</span>';

                // KYC Badge
                let kycBadge = '<span class="bg-gray-100 text-gray-600 px-2 py-1 rounded text-xs font-medium">Not Submitted</span>';
                if(t.kycStatus === 'submitted') kycBadge = '<span class="bg-yellow-100 text-yellow-700 px-2 py-1 rounded text-xs font-bold border border-yellow-200">Review Pending</span>';
                if(t.kycStatus === 'verified') kycBadge = '<span class="bg-green-100 text-green-700 px-2 py-1 rounded text-xs font-bold border border-green-200">Verified</span>';
                if(t.kycStatus === 'rejected') kycBadge = '<span class="bg-red-100 text-red-700 px-2 py-1 rounded text-xs font-bold border border-red-200">Rejected</span>';


                const address = t.address || '<span class="text-gray-400 italic">Not filled</span>';
                const dob = t.dob || '-';
                
                const row = `
                    <tr class="hover:bg-gray-50 border-b border-gray-100 last:border-0">
                        <!-- 1. Tenant Identity -->
                        <td>
                            <div class="flex items-center">
                                <div class="h-9 w-9 rounded-full bg-purple-100 text-purple-600 flex items-center justify-center font-bold mr-3 text-sm border border-purple-200">${t.name.charAt(0)}</div>
                                <div>
                                    <div class="font-semibold text-gray-900 text-sm">${t.name}</div>
                                    <div class="text-xs text-gray-500">${t.phone}</div>
                                    <div class="text-xs text-gray-400">${t.email || ''}</div>
                                </div>
                            </div>
                        </td>
                        
                        <!-- 2. Credentials -->
                        <td>
                            <div class="text-xs">
                                <div class="mb-1">ID: <span class="font-mono font-bold text-purple-700 select-all">${t.loginId}</span></div>
                                <div>Pass: ${passwordDisplay}</div>
                            </div>
                        </td>

                        <!-- 3. Personal Details -->
                        <td>
                            <div class="text-xs text-gray-600 space-y-1">
                                <div><strong>Guardian:</strong> ${guardian}</div>
                                <div><strong>DOB:</strong> ${dob}</div>
                                <div class="truncate max-w-[150px]" title="${t.address}"><strong>Addr:</strong> ${address}</div>
                            </div>
                        </td>

                        <!-- 4. Room Info -->
                        <td>
                            <div class="text-sm text-gray-800 font-medium">${
                                (typeof t.property === 'object' && t.property !== null)
                                    ? `${t.property.title || t.property.name || 'Property'}${t.property.locationCode ? ' (' + t.property.locationCode + ')' : ''}`
                                    : (t.property || 'Unknown Property')
                            }</div>
                            <div class="text-xs text-gray-500">Room ${t.roomNo}, Bed ${t.bedNo}</div>
                            <div class="text-xs font-medium text-green-600 mt-0.5">Rent: ₹${t.agreedRent}</div>
                        </td>
                        <td class="font-mono text-sm text-gray-700">${(typeof t.property === 'object' && t.property !== null) ? (t.property.locationCode || '-') : (t.locationCode || '-')}</td>

                        <!-- 5. Move In/Out -->
                        <td>
                            <div class="text-xs text-gray-600">
                                <div class="mb-2"><strong>In:</strong> ${moveIn}</div>
                                <div>${moveOutHtml}</div>
                            </div>
                        </td>

                        <!-- 6. Status -->
                        <td>${statusBadge}</td>

                         <!-- 7. KYC Status -->
                        <td>${kycBadge}</td>

                        <!-- 8. Actions (Delete) -->
                        <td class="text-right">
                             <button onclick="deleteTenant('${t.loginId}')" class="text-red-400 hover:text-red-600 p-2 hover:bg-red-50 rounded transition" title="Permanently Delete">
                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                            </button>
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
            lucide.createIcons();
        }

        function filterTenants() {
            loadTenantRecords();
        }

        // --- Move Out Logic ---
        function moveOutTenant(loginId) {
            if(!confirm("Are you sure you want to move out this tenant? \n\nThis will:\n1. Set status to 'Moved Out'\n2. Record today's date as exit date\n3. Block their login access.")) return;
            
            const tenants = JSON.parse(localStorage.getItem('roomhy_tenants') || '[]');
            const idx = tenants.findIndex(t => t.loginId === loginId);
            
            if(idx !== -1) {
                tenants[idx].status = 'moved_out';
                tenants[idx].moveOutDate = new Date().toISOString();
                // Block Login by clearing password or setting a flag
                tenants[idx].password = null; 
                
                localStorage.setItem('roomhy_tenants', JSON.stringify(tenants));
                loadTenantRecords();
                alert("Tenant moved out successfully. Login access blocked.");
            }
        }

        // --- Delete Logic ---
        function deleteTenant(loginId) {
             if(!confirm("âš ï¸ Permanently delete this record? This cannot be undone.")) return;
             
             let tenants = JSON.parse(localStorage.getItem('roomhy_tenants') || '[]');
             const newTenants = tenants.filter(t => t.loginId !== loginId);
             
             localStorage.setItem('roomhy_tenants', JSON.stringify(newTenants));
             loadTenantRecords();
        }

        // Mobile menu handlers
        document.getElementById('mobile-menu-open').addEventListener('click', () => {
            document.getElementById('mobile-menu').classList.remove('hidden');
        });

        document.getElementById('close-mobile-menu').addEventListener('click', () => {
            document.getElementById('mobile-menu').classList.add('hidden');
        });

        document.getElementById('mobile-menu-overlay').addEventListener('click', () => {
            document.getElementById('mobile-menu').classList.add('hidden');
        });

        function exportToExcel() {
            // Uses tenantsForExport which is populated by the search/filter logic
            // or falls back to loading fresh if needed. 
            // Here we reconstruct based on current filtered view to be precise.
            
            if(tenantsForExport.length === 0) return alert("No data to export.");
            
            const data = tenantsForExport.map(t => ({
                "Tenant Name": t.name,
                "Login ID": t.loginId,
                "Phone": t.phone,
                "Email": t.email || '-',
                "Guardian Contact": t.emergencyContact || '-',
                "DOB": t.dob || '-',
                "Address": t.address || '-',
                "Property": (typeof t.property === 'object' && t.property !== null) ? (t.property.title || t.property.name) : (t.property || '-'),
                "Location Code": (typeof t.property === 'object' && t.property !== null) ? (t.property.locationCode || '-') : (t.locationCode || '-'),
                "Room": t.roomNo,
                "Bed": t.bedNo,
                "Rent Amount": t.agreedRent,
                "Move In Date": t.moveInDate ? new Date(t.moveInDate).toLocaleDateString() : '-',
                "Move Out Date": t.moveOutDate ? new Date(t.moveOutDate).toLocaleDateString() : '-',
                "Status": t.status,
                "KYC Status": t.kycStatus || 'Not Submitted'
            }));
            
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Tenant_Records");
            XLSX.writeFile(wb, "Roomhy_Tenant_Records.xlsx");
        }
    </script>
</body>
</html>
