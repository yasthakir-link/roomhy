<script>
    // API base URL
    const API_URL = 'https://roomhy-backend-wqwo.onrender.com';
</script>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Roomhy - Owner Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="../sessionManager.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .sidebar { background-color: #111827; color: #9ca3af; }
        .sidebar-link { color: #9ca3af; font-weight: 500; transition: all 0.2s ease; display: flex; align-items: center; padding: 0.75rem 1.5rem; font-size: 0.9rem; border-left: 3px solid transparent; cursor: pointer; }
        .sidebar-link:hover { color: #f3f4f6; background-color: #1f2937; }
        .sidebar-link.active { background-color: #1f2937; color: #ffffff; border-left-color: #a855f7; }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 4px; }
    </style>
</head>
<body class="text-slate-800">
    <script>
        // --- SAFE REDIRECT FUNCTION ---
        // Fixes "Failed to set href" error by providing a fallback UI when direct navigation fails
        function safeRedirect(url) {
            try {
                window.location.href = url;
            } catch (e) {
                console.warn("Auto-redirect failed", e);
                document.body.innerHTML = `
                    <div class="flex items-center justify-center h-screen bg-gray-100">
                        <div class="text-center p-8 bg-white rounded-lg shadow-md max-w-sm">
                            <div class="mb-4 text-red-500">
                                <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mx-auto"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
                            </div>
                            <h2 class="text-xl font-bold text-gray-800 mb-2">Access Denied</h2>
                            <p class="mb-6 text-gray-600 text-sm">You need to login to view this page.</p>
                            <a href="${url}" class="block w-full px-4 py-2 bg-purple-600 text-white rounded hover:bg-purple-700 transition font-medium">Go to Login</a>
                        </div>
                    </div>
                `;
            }
        }

        // Role Validation
        const ownerSessionStr = sessionStorage.getItem('owner_session');
        const userStr = localStorage.getItem('user');
        
        let currentUser = null;
        if (ownerSessionStr) {
            try { currentUser = JSON.parse(ownerSessionStr); } catch(e) {}
        } else if (userStr) {
            try { currentUser = JSON.parse(userStr); } catch(e) {}
        }
        
        if (!currentUser || currentUser.role !== 'owner') {
             // Check if staff user is logged in and redirect them appropriately
             const staffUser = JSON.parse(localStorage.getItem('manager_user') || localStorage.getItem('user') || 'null');
             if (staffUser && (staffUser.role === 'areamanager' || staffUser.role === 'employee')) {
                 safeRedirect('../Areamanager/areaadmin.html');
             } else if (staffUser && staffUser.role === 'superadmin') {
                 safeRedirect('../superadmin/superadmin.html');
             } else {
                 safeRedirect('ownerlogin.html');
             }
             // Stop execution to prevent the rest of the page from loading
             // Removed 'throw new Error()' to prevent console error logs
             // Instead, we just let the page script stop execution naturally by returning early if possible,
             // or rely on safeRedirect replacing the body content which stops interaction.
        }
    </script>

    <div class="flex h-screen overflow-hidden">
        <!-- Sidebar -->
        <aside class="sidebar w-72 flex-shrink-0 hidden md:flex flex-col z-20 overflow-y-auto custom-scrollbar">
            <div class="h-16 flex items-center px-6 border-b border-gray-800 sticky top-0 bg-[#111827] z-10">
                 <div class="flex items-center gap-3">
                     <div class="bg-purple-600 p-1.5 rounded-lg"><i data-lucide="home" class="w-5 h-5 text-white"></i></div>
                     <div><h1 class="text-xl font-bold text-white">RoomHy</h1><span class="text-[10px] text-gray-500">OWNER PANEL</span></div>
                 </div>
            </div>
            <nav class="flex-1 py-6 space-y-1">
                <a href="admin.html" class="sidebar-link active"><i data-lucide="layout-dashboard" class="w-5 h-5 mr-3"></i> Dashboard</a>
                <a href="properties.html" class="sidebar-link"><i data-lucide="building" class="w-5 h-5 mr-3"></i> Properties</a>
                <a href="rooms.html" class="sidebar-link"><i data-lucide="bed-double" class="w-5 h-5 mr-3"></i> Rooms</a>
                <a href="tenantrec.html" class="sidebar-link"><i data-lucide="clipboard-list" class="w-5 h-5 mr-3"></i> Tenant Records</a>
                <a href="enquiry.html" class="sidebar-link"><i data-lucide="mail" class="w-5 h-5 mr-3"></i> Enquiry</a>
                <a href="documents.html" class="sidebar-link"><i data-lucide="file-text" class="w-5 h-5 mr-3"></i> Documents</a>
                <a href="payment.html" class="sidebar-link"><i data-lucide="credit-card" class="w-5 h-5 mr-3"></i> Payments</a>
                <a href="booking_request.html" class="sidebar-link"><i data-lucide="calendar-check" class="w-5 h-5 mr-3"></i> Booking Requests</a>
                <a href="ownerchat.html" class="sidebar-link"><i data-lucide="message-circle" class="w-5 h-5 mr-3"></i> Chat</a>
                <a href="complaints.html" class="sidebar-link"><i data-lucide="alert-circle" class="w-5 h-5 mr-3"></i> Complaints</a>
                <a href="location.html" class="sidebar-link"><i data-lucide="map-pin" class="w-5 h-5 mr-3"></i> Location</a>
                <a href="ownerprofile.html" class="sidebar-link"><i data-lucide="user" class="w-5 h-5 mr-3"></i> Profile</a>
                <a href="settings.html" class="sidebar-link"><i data-lucide="settings" class="w-5 h-5 mr-3"></i> Settings</a>
                
                <!-- Account Management Section -->
                <div class="mt-6 px-6 pb-2">
                    <div class="text-xs font-semibold text-gray-400 uppercase tracking-wider mb-3">Accounts</div>
                    <div id="accounts-list" class="space-y-2">
                        <!-- Accounts will be populated here -->
                    </div>
                    <button onclick="addNewAccount()" class="w-full mt-3 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg transition-colors flex items-center justify-center gap-2">
                        <i data-lucide="plus" class="w-4 h-4"></i> Add Account
                    </button>
                </div>
            </nav>
        </aside>

        <!-- Main Content -->
        <div class="flex-1 flex flex-col overflow-hidden bg-[#f3f4f6]">
            <!-- Header -->
            <header class="bg-white h-16 flex items-center justify-between px-6 shadow-sm z-10">
                <div class="flex items-center">
                    <button id="mobile-menu-open" class="md:hidden mr-4 text-slate-500"><i data-lucide="menu" class="w-6 h-6"></i></button>
                    <h2 class="text-lg font-semibold text-slate-800">Dashboard</h2>
                </div>
                <div class="flex items-center gap-4">
                    <button class="text-slate-400 hover:text-slate-600"><i data-lucide="bell" class="w-5 h-5"></i></button>
                    <div class="relative group">
                        <button class="flex items-center gap-3 hover:bg-gray-50 p-1.5 rounded-full transition-colors">
                            <div class="w-8 h-8 rounded-full bg-purple-100 flex items-center justify-center text-purple-600 font-bold border border-purple-200" id="headerAvatar">OP</div>
                            <div class="text-left hidden sm:block">
                                <p class="text-xs font-semibold text-gray-700" id="headerName">Owner</p>
                                <p class="text-[10px] text-gray-500" id="headerAccountId">Property Owner</p>
                            </div>
                            <i data-lucide="chevron-down" class="w-3 h-3 text-gray-400 hidden sm:block"></i>
                        </button>
                         <div class="absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg py-1 ring-1 ring-black ring-opacity-5 hidden group-hover:block z-50">
                            <a href="index.html" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 flex items-center gap-2"><i data-lucide="user" class="w-4 h-4"></i> Account</a>
                            <a href="ownerprofile.html" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 flex items-center gap-2"><i data-lucide="user-circle" class="w-4 h-4"></i> Profile</a>
                            <a href="#" id="logoutBtn" class="block px-4 py-2 text-sm text-red-600 hover:bg-gray-100 flex items-center gap-2"><i data-lucide="log-out" class="w-4 h-4"></i> Logout</a>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Mobile Sidebar -->
            <div id="mobile-menu" class="md:hidden fixed inset-0 z-50 flex hidden">
                <div class="fixed inset-0 bg-black/30 backdrop-blur-sm" id="mobile-menu-overlay"></div>
                <aside class="sidebar w-72 flex-shrink-0 text-gray-300 flex flex-col relative z-10 ml-auto">
                    <div class="h-16 flex items-center justify-between px-6 border-b border-gray-800">
                        <div class="flex items-center gap-3">
                            <div class="bg-purple-600 p-1.5 rounded-lg"><i data-lucide="home" class="w-5 h-5 text-white"></i></div>
                            <div><h1 class="text-xl font-bold text-white">RoomHy</h1><span class="text-[10px] text-gray-500">OWNER PANEL</span></div>
                        </div>
                        <button id="close-mobile-menu" class="p-2 text-gray-400 hover:text-white"><i data-lucide="x" class="w-6 h-6"></i></button>
                    </div>
                    <nav class="flex-1 py-6 space-y-1">
                        <a href="admin.html" class="sidebar-link active"><i data-lucide="layout-dashboard" class="w-5 h-5 mr-3"></i> Dashboard</a>
                        <a href="properties.html" class="sidebar-link"><i data-lucide="building" class="w-5 h-5 mr-3"></i> Properties</a>
                        <a href="rooms.html" class="sidebar-link"><i data-lucide="bed-double" class="w-5 h-5 mr-3"></i> Rooms</a>
                        <a href="tenantrec.html" class="sidebar-link"><i data-lucide="clipboard-list" class="w-5 h-5 mr-3"></i> Tenant Records</a>
                        <a href="enquiry.html" class="sidebar-link"><i data-lucide="mail" class="w-5 h-5 mr-3"></i> Enquiry</a>
                        <a href="documents.html" class="sidebar-link"><i data-lucide="file-text" class="w-5 h-5 mr-3"></i> Documents</a>
                        <a href="payment.html" class="sidebar-link"><i data-lucide="credit-card" class="w-5 h-5 mr-3"></i> Payments</a>
                        <a href="booking_request.html" class="sidebar-link"><i data-lucide="calendar-check" class="w-5 h-5 mr-3"></i> Booking Requests</a>
                        <a href="ownerchat.html" class="sidebar-link"><i data-lucide="message-circle" class="w-5 h-5 mr-3"></i> Chat</a>
                        <a href="complaints.html" class="sidebar-link"><i data-lucide="alert-circle" class="w-5 h-5 mr-3"></i> Complaints</a>
                        <a href="location.html" class="sidebar-link"><i data-lucide="map-pin" class="w-5 h-5 mr-3"></i> Location</a>
                        <a href="ownerprofile.html" class="sidebar-link"><i data-lucide="user" class="w-5 h-5 mr-3"></i> Profile</a>
                        <a href="settings.html" class="sidebar-link"><i data-lucide="settings" class="w-5 h-5 mr-3"></i> Settings</a>
                        
                        <!-- Account Management Section -->
                        <div class="mt-6 px-6 pb-2">
                            <div class="text-xs font-semibold text-gray-400 uppercase tracking-wider mb-3">Accounts</div>
                            <div id="mobile-accounts-list" class="space-y-2">
                                <!-- Accounts will be populated here -->
                            </div>
                            <button onclick="addNewAccount()" class="w-full mt-3 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg transition-colors flex items-center justify-center gap-2">
                                <i data-lucide="plus" class="w-4 h-4"></i> Add Account
                            </button>
                        </div>
                    </nav>
                </aside>
            </div>

            <!-- Content -->
            <main class="flex-1 overflow-y-auto p-6 md:p-8">
                <div class="max-w-7xl mx-auto">
                    <div class="mb-8 flex flex-col md:flex-row justify-between items-start md:items-center">
                        <div>
                            <h1 class="text-2xl font-bold text-slate-800">Welcome back, <span id="welcomeName">Owner</span>! 👋</h1>
                            <p class="text-sm text-slate-500 mt-1">Here's what's happening with your properties today.</p>
                        </div>
                        <div class="mt-4 md:mt-0 flex gap-3">
                            <button class="bg-white border border-gray-300 text-gray-700 px-4 py-2 rounded-lg text-sm font-medium hover:bg-gray-50 shadow-sm">
                                View Reports
                            </button>
                            <button onclick="window.location.href='rooms.html'" class="bg-purple-600 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-purple-700 shadow-sm flex items-center">
                                <i data-lucide="plus" class="w-4 h-4 mr-2"></i> Add Room
                            </button>
                        </div>
                    </div>

                    <!-- Stats Grid (Updated Layout: 3 Columns) -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                        <!-- Tenants -->
                        <div class="bg-gradient-to-br from-orange-500 to-orange-600 p-6 rounded-xl shadow-lg text-white relative overflow-hidden group">
                            <div class="relative z-10">
                                <p class="text-orange-100 text-sm font-medium">Tenants</p>
                                <h3 class="text-3xl font-bold mt-2" id="statTenants">0</h3>
                            </div>
                            <div class="absolute right-4 top-4 opacity-20 group-hover:scale-110 transition-transform duration-300">
                                <i data-lucide="users" class="w-12 h-12"></i>
                            </div>
                        </div>
                        <!-- Rooms -->
                        <div class="bg-gradient-to-br from-purple-500 to-purple-600 p-6 rounded-xl shadow-lg text-white relative overflow-hidden group">
                            <div class="relative z-10">
                                <p class="text-purple-100 text-sm font-medium">Rooms</p>
                                <h3 class="text-3xl font-bold mt-2" id="statRooms">0</h3>
                            </div>
                            <div class="absolute right-4 top-4 opacity-20 group-hover:scale-110 transition-transform duration-300">
                                <i data-lucide="bed-double" class="w-12 h-12"></i>
                            </div>
                        </div>
                        <!-- Rent Collected -->
                        <div class="bg-gradient-to-br from-green-500 to-green-600 p-6 rounded-xl shadow-lg text-white relative overflow-hidden group">
                            <div class="relative z-10">
                                <p class="text-green-100 text-sm font-medium">Rent Collected</p>
                                <h3 class="text-3xl font-bold mt-2" id="statRent">?0</h3>
                            </div>
                            <div class="absolute right-4 top-4 opacity-20 group-hover:scale-110 transition-transform duration-300">
                                <i data-lucide="indian-rupee" class="w-12 h-12"></i>
                            </div>
                        </div>
                    </div>

                    <!-- Recent Activity / Charts Placeholder -->
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <!-- Main Chart -->
                        <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                            <div class="flex justify-between items-center mb-6">
                                <h3 class="font-bold text-gray-800">Occupancy Overview</h3>
                                <select class="text-xs border-gray-300 rounded text-gray-600">
                                    <option>This Month</option>
                                    <option>Last Month</option>
                                </select>
                            </div>
                            <div class="h-64 w-full flex items-center justify-center bg-gray-50 rounded border border-dashed border-gray-300">
                                <p class="text-gray-400 text-sm flex items-center gap-2">
                                    <i data-lucide="bar-chart-2" class="w-5 h-5"></i> Chart Data Loading...
                                </p>
                            </div>
                        </div>

                        <!-- Quick Actions / Recent -->
                        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                            <h3 class="font-bold text-gray-800 mb-4">Recent Alerts</h3>
                            <div class="space-y-4">
                                <div class="flex items-start gap-3 p-3 bg-red-50 rounded-lg border border-red-100">
                                    <i data-lucide="alert-circle" class="w-5 h-5 text-red-500 mt-0.5"></i>
                                    <div>
                                        <p class="text-sm font-semibold text-red-700">Rent Overdue</p>
                                        <p class="text-xs text-red-600">Tenant in Room 101 pending payment.</p>
                                    </div>
                                </div>
                                 <div class="flex items-start gap-3 p-3 bg-blue-50 rounded-lg border border-blue-100">
                                    <i data-lucide="info" class="w-5 h-5 text-blue-500 mt-0.5"></i>
                                    <div>
                                        <p class="text-sm font-semibold text-blue-700">New Enquiry</p>
                                        <p class="text-xs text-blue-600">2 people interested in double sharing.</p>
                                    </div>
                                </div>
                            </div>
                            <button class="w-full mt-4 py-2 text-sm text-purple-600 font-medium hover:bg-purple-50 rounded transition-colors">View All Notifications</button>
                            <div class="mt-6">
                                <h4 class="font-semibold text-gray-700 mb-2">Enquiries <span id="enquiry-count">(0)</span></h4>
                                <div class="overflow-x-auto">
                                    <table class="min-w-full text-xs text-left text-gray-700">
                                        <thead class="bg-gray-100">
                                            <tr>
                                                <th class="px-2 py-1">Property</th>
                                                <th class="px-2 py-1">Tenant</th>
                                                <th class="px-2 py-1">Status</th>
                                                <th class="px-2 py-1">Date</th>
                                                <th class="px-2 py-1">Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="owner-enquiries-list"></tbody>
                                    </table>
                                </div>
                                <button id="refresh-enquiries" class="mt-3 w-full py-2 text-sm bg-purple-600 text-white rounded">Refresh Enquiries</button>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script>
        lucide.createIcons();

        // 1. Load User Profile & Data (with onboarding enforcement)
        document.addEventListener('DOMContentLoaded', async () => {
            const user = JSON.parse(localStorage.getItem('user') || 'null');

            if (!user || user.role !== 'owner') {
                // Should have been caught by the script in head, but as a fallback:
                console.log("Demo Mode: No owner logged in or role mismatch");
                return;
            }

            // Try to fetch owner record from backend first to use MongoDB Atlas as source-of-truth
            let ownerRecord = null;
            try {
                const res = await fetch(`${API_BASE}/api/owners/${encodeURIComponent(user.loginId)}`);
                if (res.ok) {
                    ownerRecord = await res.json();
                } else {
                    console.warn('Owner fetch returned', res.status);
                }
            } catch (err) {
                console.warn('Owner fetch failed, will fallback to localStorage', err);
            }

            // If backend didn't return owner data, fallback to localStorage
            if (!ownerRecord) {
                const db = JSON.parse(localStorage.getItem('roomhy_owners_db') || '{}');
                ownerRecord = db[user.loginId] || {};
            }

            // Polling fallback: if KYC incomplete, periodically refresh owner data
            let __dashboardPoll = null;
            function startDashboardPolling(intervalMs = 10000) {
                if (!user || !user.loginId) return;
                if (__dashboardPoll) return;
                __dashboardPoll = setInterval(async () => {
                    try {
                        const res = await fetch(`${API_BASE}/api/owners/${encodeURIComponent(user.loginId)}`);
                        if (res.ok) {
                            const fresh = await res.json();
                            const db = JSON.parse(localStorage.getItem('roomhy_owners_db') || '{}');
                            db[user.loginId] = db[user.loginId] || {};
                            db[user.loginId].kyc = fresh.kyc || db[user.loginId].kyc;
                            db[user.loginId].profileFilled = db[user.loginId].profileFilled || !!fresh.profileFilled;
                            localStorage.setItem('roomhy_owners_db', JSON.stringify(db));
                            if (fresh.kyc && (fresh.kyc.status === 'submitted' || fresh.kyc.status === 'verified')) {
                                try { localStorage.setItem('owner_kyc_updated', JSON.stringify({ loginId: user.loginId, ts: Date.now() })); } catch (e) {}
                                clearInterval(__dashboardPoll); __dashboardPoll = null;
                            }
                        }
                    } catch (e) { /* ignore */ }
                }, intervalMs);
            }

            // If KYC incomplete, start polling to pick up admin verification
            const curKyc = ownerRecord.kyc?.status || 'pending';
            if (!(curKyc === 'submitted' || curKyc === 'verified')) startDashboardPolling();

            // Listen for external KYC updates (from superadmin) and refresh owner record
            window.addEventListener('storage', async (ev) => {
                if (ev.key === 'owner_kyc_updated') {
                    try {
                        const payload = JSON.parse(ev.newValue || '{}');
                        if (payload && payload.loginId === user.loginId) {
                            console.log('Detected KYC update for current owner, refreshing owner data...');
                            try {
                                const fres = await fetch(`${API_BASE}/api/owners/${encodeURIComponent(user.loginId)}`);
                                if (fres.ok) {
                                    const freshOwner = await fres.json();
                                    // Update local view and storage
                                    const db = JSON.parse(localStorage.getItem('roomhy_owners_db') || '{}');
                                    db[user.loginId] = db[user.loginId] || {};
                                    db[user.loginId].kyc = freshOwner.kyc || db[user.loginId].kyc;
                                    db[user.loginId].profileFilled = db[user.loginId].profileFilled || !!freshOwner.profileFilled;
                                    localStorage.setItem('roomhy_owners_db', JSON.stringify(db));

                                    // If KYC now allows access, do nothing; if not, existing checks will handle it.
                                    console.log('Owner data refreshed after KYC update.');
                                }
                            } catch (e) { console.warn('Failed to refresh owner after storage event', e && e.message); }
                        }
                    } catch (e) { /* ignore parse errors */ }
                }
            });

            const profile = ownerRecord.profile || {};
            const kycStatus = ownerRecord.kyc ? ownerRecord.kyc.status : 'pending';

            // Respect canonical localStorage flags (set by KYC flow) to avoid brief backend/local races
            const localKycDone = localStorage.getItem('kycCompleted') === 'true';
            const localProfileDone = localStorage.getItem('ownerProfileCompleted') === 'true';

            // Check profile completion (consider backend OR local flag)
            const hasProfileFlag = ownerRecord.profileFilled === true || localProfileDone === true;
            const hasProfileFields = profile.name && profile.email && profile.address;
            const profileIncomplete = !hasProfileFlag && !hasProfileFields;

            if (profileIncomplete) {
                console.warn('Profile incomplete, redirecting to profile setup');
                safeRedirect('ownerprofile.html');
                return;
            }

            // KYC: allow dashboard if backend says submitted/verified OR local flag is set
            const kycDone = (kycStatus === 'submitted' || kycStatus === 'verified') || localKycDone;
            if (!kycDone) {
                console.warn('KYC incomplete, redirecting to KYC');
                safeRedirect('ownerkyc.html');
                return;
            }

            // Show name (prefer backend profile name)
            const displayName = (profile.name) || user.name || 'Owner';
            document.getElementById('headerName').innerText = displayName;
            document.getElementById('welcomeName').innerText = displayName;
            document.getElementById('headerAvatar').innerText = displayName.charAt(0).toUpperCase();
            document.getElementById('headerAccountId').innerText = `Account: ${user.loginId}`;

            // Fetch properties from backend (new endpoint). If unavailable, fallback to localStorage.
            let myProperties = [];
            try {
                const propRes = await fetch(`${API_BASE}/api/owners/${encodeURIComponent(user.loginId)}/properties`);
                if (propRes.ok) {
                    const payload = await propRes.json();
                    myProperties = payload.properties || [];
                } else {
                    console.warn('Properties fetch returned', propRes.status);
                }
            } catch (err) {
                console.warn('Properties fetch failed, falling back to localStorage', err);
            }
            if (!myProperties || myProperties.length === 0) {
                try {
                    const allProps = JSON.parse(localStorage.getItem('roomhy_properties') || '[]');
                    const ownerId = user.ownerId || user.loginId;
                    myProperties = allProps.filter(p => p.ownerId === ownerId);
                } catch (e) {
                    myProperties = [];
                }
            }

            // Fetch rent collected (sum of paidAmount from all accepted/approved enquiries or from /api/owners/:id/rent)
            let rentCollected = 0;
            try {
                const rentRes = await fetch(`${API_BASE}/api/owners/${encodeURIComponent(user.loginId)}/rent`);
                if (rentRes.ok) {
                    const rentData = await rentRes.json();
                    rentCollected = rentData.totalRent || 0;
                }
            } catch (e) {
                // fallback: sum paidAmount from accepted/approved enquiries
                try {
                    const enqRes = await fetch(`${API_BASE}/api/owners/${encodeURIComponent(user.loginId)}/enquiries`);
                    if (enqRes.ok) {
                        const enqList = await enqRes.json();
                        rentCollected = enqList.filter(e => (e.status === 'accepted' || e.status === 'approved') && e.paidAmount)
                            .reduce((sum, e) => sum + (e.paidAmount || 0), 0);
                    }
                } catch (e) {}
            }
            document.getElementById('statRent').innerText = `?${rentCollected.toLocaleString()}`;

            // Fetch rooms from backend (new endpoint). If unavailable, fallback to localStorage.
            let myRooms = [];
            try {
                const roomsRes = await fetch(`${API_BASE}/api/owners/${encodeURIComponent(user.loginId)}/rooms`);
                if (roomsRes.ok) {
                    const payload = await roomsRes.json();
                    myRooms = payload.rooms || [];
                } else {
                    console.warn('Rooms fetch returned', roomsRes.status);
                }
            } catch (err) {
                console.warn('Rooms fetch failed, falling back to localStorage', err);
            }
            if (!myRooms || myRooms.length === 0) {
                try {
                    const allRooms = JSON.parse(localStorage.getItem('roomhy_rooms') || '[]');
                    const ownerId = user.ownerId || user.loginId;
                    myRooms = allRooms.filter(r => r.ownerId === ownerId);
                } catch (e) {
                    myRooms = [];
                }
            }
            document.getElementById('statRooms').innerText = myRooms.length;

            // tenant count: backend rooms use numeric 'beds' field; localStorage used arrays.
            let tenantCount = 0;
            myRooms.forEach(r => {
                if (Array.isArray(r.beds)) {
                    tenantCount += r.beds.filter(b => b.tenant).length;
                } else if (typeof r.beds === 'number') {
                    tenantCount += r.beds;
                }
            });
            document.getElementById('statTenants').innerText = tenantCount;
        });

        // Logout
        document.getElementById('logoutBtn').addEventListener('click', (e) => {
            e.preventDefault();
            localStorage.removeItem('user');
            window.location.href = '../index.html';
        });

        // Owner Enquiries: Load from localStorage key 'owner_enquiries_<ownerId>'
        async function loadOwnerEnquiries() {
            try {
                const user = JSON.parse(localStorage.getItem('user') || 'null');
                if (!user || !user.loginId) return;
                const ownerId = user.loginId;
                const res = await fetch(`${API_BASE}/api/owners/${encodeURIComponent(ownerId)}/enquiries`);
                const list = res.ok ? await res.json() : [];
                const container = document.getElementById('owner-enquiries-list');
                if (!container) return;
                // Update enquiry count
                const countSpan = document.getElementById('enquiry-count');
                if (countSpan) countSpan.textContent = `(${list.length})`;
                if (!list.length) { container.innerHTML = '<p class="text-sm text-gray-500">No enquiries yet.</p>'; return; }
                container.innerHTML = list.map(e => {
                    // Status badge
                    let statusColor = 'bg-gray-200 text-gray-700';
                    if (e.status === 'pending') statusColor = 'bg-yellow-100 text-yellow-800';
                    if (e.status === 'accepted') statusColor = 'bg-green-100 text-green-800';
                    if (e.status === 'rejected') statusColor = 'bg-red-100 text-red-700';
                    if (e.status === 'approved') statusColor = 'bg-blue-100 text-blue-800';
                    if (e.status === 'request to connect') statusColor = 'bg-purple-100 text-purple-800';
                    const statusBadge = `<span class='inline-block px-2 py-0.5 rounded text-xs font-semibold ${statusColor}'>${e.status.charAt(0).toUpperCase() + e.status.slice(1)}</span>`;
                    return `<tr>
                        <td class='px-2 py-1'>${e.propertyName || e.propertyId}</td>
                        <td class='px-2 py-1'>${e.studentName || e.studentId}</td>
                        <td class='px-2 py-1'>${statusBadge}</td>
                        <td class='px-2 py-1'>${new Date(e.ts).toLocaleString()}</td>
                        <td class='px-2 py-1'>
                            <button data-enqid="${e._id}" class="accept-enq mb-2 bg-green-600 text-white px-2 py-1 rounded text-xs">Accept</button>
                            <button data-enqid="${e._id}" class="reject-enq ml-2 bg-red-100 text-red-700 px-2 py-1 rounded text-xs">Reject</button>
                        </td>
                    </tr>`;
                }).join('');

                // attach handlers
                setTimeout(() => {
                    document.querySelectorAll('.accept-enq').forEach(b => b.addEventListener('click', (ev) => {
                        const enqId = ev.target.getAttribute('data-enqid'); ownerAction(enqId, 'accept');
                    }));
                    document.querySelectorAll('.reject-enq').forEach(b => b.addEventListener('click', (ev) => {
                        const enqId = ev.target.getAttribute('data-enqid'); ownerAction(enqId, 'reject');
                    }));
                }, 50);
            } catch (e) { console.warn('loadOwnerEnquiries error', e); }
        }

        function ownerAction(enquiryId, action) {
            const user = JSON.parse(localStorage.getItem('user') || 'null');
            if (!user || !user.loginId) return alert('Owner session missing');
            fetch(`${API_BASE}/api/owners/enquiries/${enquiryId}`, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(
                    action === 'accept'
                        ? { status: 'accepted', chatOpen: true, visitAllowed: true }
                        : { status: 'rejected', chatOpen: false, visitAllowed: false }
                )
            })
            .then(res => res.json())
            .then(() => {
                loadOwnerEnquiries();
                alert('Enquiry ' + action + 'ed');
            })
            .catch(() => alert('Failed to update enquiry'));
        }

        document.getElementById('refresh-enquiries')?.addEventListener('click', loadOwnerEnquiries);

        // load on start
        loadOwnerEnquiries();
        // Auto-refresh enquiry list every 30 seconds
        setInterval(loadOwnerEnquiries, 30000);

        // Mobile Menu Functionality
        document.getElementById('mobile-menu-open').addEventListener('click', function() {
            document.getElementById('mobile-menu').classList.remove('hidden');
        });

        document.getElementById('close-mobile-menu').addEventListener('click', function() {
            document.getElementById('mobile-menu').classList.add('hidden');
        });

        document.getElementById('mobile-menu-overlay').addEventListener('click', function() {
            document.getElementById('mobile-menu').classList.add('hidden');
        });

        // Optionally, you can use polling or websockets for real-time updates

        // Add Account functionality
        function addNewAccount() {
            // Clear current session and redirect to login
            localStorage.removeItem('user');
            sessionStorage.removeItem('user');
            window.location.href = 'index.html';
        }

        // Load and display accounts in sidebar
        function loadAccounts() {
            const accountsList = document.getElementById('accounts-list');
            const mobileAccountsList = document.getElementById('mobile-accounts-list');
            const ownerAccounts = JSON.parse(localStorage.getItem('owner_accounts') || '[]');
            const currentUser = JSON.parse(localStorage.getItem('user') || 'null');
            
            if (ownerAccounts.length === 0) {
                const noAccountsHtml = '<div class="text-xs text-gray-500 text-center py-2">No accounts</div>';
                if (accountsList) accountsList.innerHTML = noAccountsHtml;
                if (mobileAccountsList) mobileAccountsList.innerHTML = noAccountsHtml;
                return;
            }
            
            const accountsHtml = ownerAccounts.map(account => {
                const isActive = currentUser && currentUser.loginId === account.loginId;
                return `
                    <div class="account-item ${isActive ? 'bg-blue-700' : 'bg-gray-700'} rounded-lg p-2 cursor-pointer hover:bg-opacity-80 transition-colors" onclick="switchAccount('${account.loginId}')">
                        <div class="flex items-center justify-between">
                            <div class="flex-1 min-w-0">
                                <div class="text-xs font-medium text-white truncate">${account.name || 'Owner'}</div>
                                <div class="text-xs text-gray-300 truncate">${account.loginId}</div>
                            </div>
                            ${isActive ? '<div class="w-2 h-2 bg-green-400 rounded-full ml-2"></div>' : ''}
                        </div>
                    </div>
                `;
            }).join('');
            
            if (accountsList) accountsList.innerHTML = accountsHtml;
            if (mobileAccountsList) mobileAccountsList.innerHTML = accountsHtml;
        }

        // Switch between accounts
        function switchAccount(loginId) {
            const ownerAccounts = JSON.parse(localStorage.getItem('owner_accounts') || '[]');
            const account = ownerAccounts.find(acc => acc.loginId === loginId);
            
            if (account) {
                // Set as active account
                localStorage.setItem('user', JSON.stringify(account));
                sessionStorage.setItem('owner_session', JSON.stringify(account));
                
                // Reload the page to reflect the account change
                window.location.reload();
            }
        }

        // Initialize accounts on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadAccounts();
        });

    </script>
</body>
</html>
