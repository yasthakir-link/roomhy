<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RoomHy - Room Management</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <!-- Lucide icons: try CDN (keeps working when local file missing) -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        
        /* Sidebar Styling (match admin.html) */
        .sidebar { background-color: #111827; color: #9ca3af; }
        .sidebar-link { color: #9ca3af; font-weight: 500; transition: all 0.2s ease; display: flex; align-items: center; padding: 0.75rem 1.5rem; font-size: 0.9rem; border-left: 3px solid transparent; cursor: pointer; }
        .sidebar-link:hover { color: #f3f4f6; background-color: #1f2937; }
        .sidebar-link.active { background-color: #1f2937; color: #ffffff; border-left-color: #a855f7; }
        
        /* Profile Dropdown Transition */
        .profile-dropdown { transition: opacity 0.2s ease-out, transform 0.2s ease-out; }

        /* Custom Scrollbar */
        .custom-scrollbar::-webkit-scrollbar { width: 5px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 4px; }

        /* Room Card */
        .room-card {
            transition: transform 0.2s, box-shadow 0.2s;
            border-top: 4px solid transparent;
        }
        .room-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
        }
        .room-card-ac { border-top-color: #3b82f6; } /* Blue for AC */
        .room-card-nonac { border-top-color: #f59e0b; } /* Amber for Non-AC */

        /* Bed Visuals */
        .bed-item { transition: all 0.2s; }
        
        .bed-occupied {
            background: linear-gradient(to bottom right, #f0fdf4, #dcfce7);
            border: 1px solid #bbf7d0;
        }
        .bed-occupied:hover { border-color: #86efac; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }

        .bed-empty {
            background-color: #ffffff;
            border: 1px dashed #cbd5e1;
            color: #64748b;
        }
        .bed-empty:hover {
            border-color: #a855f7;
            color: #7e22ce;
            background-color: #faf5ff;
            cursor: pointer;
        }

        .add-bed-btn {
            border: 1px dashed #e2e8f0;
            color: #94a3b8;
        }
        .add-bed-btn:hover {
            border-color: #cbd5e1;
            background-color: #f1f5f9;
            color: #475569;
        }
        
        /* Tab Button Active State */
        .tab-btn.active {
            background-color: #f3e8ff;
            color: #7e22ce;
            border-color: #d8b4fe;
        }
    </style>
</head>
<body class="text-slate-800 h-screen overflow-hidden flex flex-col">

    <div class="flex h-full overflow-hidden">
        <!-- Sidebar (copied from admin.html for exact match) -->
        <aside class="sidebar w-72 flex-shrink-0 hidden md:flex flex-col z-20 overflow-y-auto custom-scrollbar">
            <div class="h-16 flex items-center px-6 border-b border-gray-800 sticky top-0 bg-[#111827] z-10">
                 <div class="flex items-center gap-3">
                     <div class="bg-purple-600 p-1.5 rounded-lg"><i data-lucide="home" class="w-5 h-5 text-white"></i></div>
                     <div><h1 class="text-xl font-bold text-white">RoomHy</h1><span class="text-[10px] text-gray-500">OWNER PANEL</span></div>
                 </div>
            </div>
            <nav class="flex-1 py-6 space-y-1">
                <a href="admin.html" class="sidebar-link"><i data-lucide="layout-dashboard" class="w-5 h-5 mr-3"></i> Dashboard</a>
                <a href="properties.html" class="sidebar-link"><i data-lucide="building" class="w-5 h-5 mr-3"></i> Properties</a>
                <a href="rooms.html" class="sidebar-link active"><i data-lucide="bed-double" class="w-5 h-5 mr-3"></i> Rooms</a>
                <a href="tenantrec.html" class="sidebar-link"><i data-lucide="clipboard-list" class="w-5 h-5 mr-3"></i> Tenant Records</a>
                <a href="enquiry.html" class="sidebar-link"><i data-lucide="mail" class="w-5 h-5 mr-3"></i> Enquiry</a>
                <a href="documents.html" class="sidebar-link"><i data-lucide="file-text" class="w-5 h-5 mr-3"></i> Documents</a>
                <a href="payment.html" class="sidebar-link"><i data-lucide="credit-card" class="w-5 h-5 mr-3"></i> Payments</a>
                <a href="complaints.html" class="sidebar-link"><i data-lucide="alert-circle" class="w-5 h-5 mr-3"></i> Complaints</a>
                <a href="location.html" class="sidebar-link"><i data-lucide="map-pin" class="w-5 h-5 mr-3"></i> Location</a>
                <a href="ownerprofile.html" class="sidebar-link"><i data-lucide="user" class="w-5 h-5 mr-3"></i> Profile</a>
                <a href="settings.html" class="sidebar-link"><i data-lucide="settings" class="w-5 h-5 mr-3"></i> Settings</a>
            </nav>
        </aside>

        <!-- Main Content -->
        <div class="flex-1 flex flex-col h-full overflow-hidden bg-[#f3f4f6] relative">
            <!-- Top Header -->
            <header class="bg-white shadow-sm h-16 flex items-center justify-between px-6 relative z-30 flex-shrink-0">
                <div class="flex items-center">
                    <button id="mobile-menu-button" class="md:hidden mr-4 text-gray-500 hover:text-gray-700 focus:outline-none">
                        <i data-lucide="menu" class="w-6 h-6"></i>
                    </button>
                    <h2 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                        <i data-lucide="bed-double" class="w-6 h-6 text-purple-600"></i> Manage Rooms
                    </h2>
                </div>
                <div class="flex items-center space-x-4">
                    <button class="relative p-2 text-gray-400 hover:text-gray-500 focus:outline-none">
                        <span class="absolute top-2 right-2 block h-2 w-2 rounded-full bg-red-500 ring-2 ring-white"></span>
                        <i data-lucide="bell" class="w-6 h-6"></i>
                    </button>
                    
                    <!-- Profile Dropdown -->
                    <div class="relative ml-3">
                        <button id="profile-button" class="flex items-center max-w-xs text-sm rounded-full focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500">
                            <div class="h-9 w-9 rounded-full bg-purple-100 flex items-center justify-center text-purple-700 font-bold border border-purple-200" id="headerAvatar">
                                O
                            </div>
                        </button>
                        <!-- Dropdown menu -->
                        <div id="profile-dropdown" class="profile-dropdown hidden origin-top-right absolute right-0 mt-2 w-48 rounded-md shadow-lg py-1 bg-white ring-1 ring-black ring-opacity-5 focus:outline-none z-50 transform scale-95 opacity-0">
                            <div class="px-4 py-3 border-b border-gray-100">
                                <p class="text-sm font-medium text-gray-900" id="headerOwnerName">Owner</p>
                                <p class="text-xs text-gray-500 truncate" id="headerOwnerId">ID: ...</p>
                            </div>
                            <a href="index.html" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100"><i data-lucide="user" class="w-4 h-4 inline mr-2"></i> Account</a>
                            <a href="ownerprofile.html" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100"><i data-lucide="user-circle" class="w-4 h-4 inline mr-2"></i> Your Profile</a>
                            <a href="settings.html" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100"><i data-lucide="settings" class="w-4 h-4 inline mr-2"></i> Settings</a>
                            <a href="ownerlogin.html" onclick="localStorage.removeItem('user'); sessionStorage.clear();" class="block px-4 py-2 text-sm text-red-600 hover:bg-gray-100"><i data-lucide="log-out" class="w-4 h-4 inline mr-2"></i> Sign out</a>
                        </div>
                    </div>
                </div>
            </header>

            <div class="flex-1 overflow-y-auto p-6 md:p-8 custom-scrollbar">
                <div class="max-w-7xl mx-auto">
                    
                    <!-- Header Section Content -->
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-4">
                        <div>
                            <div class="flex items-center mt-1 text-slate-500 text-sm bg-white px-3 py-1.5 rounded-full shadow-sm border border-gray-200 w-fit">
                                <i data-lucide="map-pin" class="w-4 h-4 mr-2 text-purple-500"></i>
                                <a id="propertyNameDisplay" class="font-medium text-purple-700 hover:underline" href="#">Loading Property...</a>
                            </div>
                            <div id="dataStatus" class="mt-2 text-xs text-gray-500 flex items-center gap-3">
                                <span id="backendStatus">Backend: unknown</span>
                                <span id="roomsCount">Rooms: -</span>
                                <span id="tenantsCount">Tenants: -</span>
                                <button id="loadTenantsBtn" onclick="loadTenantsFromBackend()" class="ml-2 text-xs px-2 py-1 bg-gray-100 rounded-md">Import Tenants</button>
                            </div>
                        </div>
                        <button onclick="openAddRoomModal()" class="bg-purple-600 hover:bg-purple-700 text-white px-5 py-2.5 rounded-lg flex items-center gap-2 shadow-lg hover:shadow-purple-500/30 transition-all font-medium">
                            <i data-lucide="plus-circle" class="w-5 h-5"></i> Add New Room
                        </button>
                    </div>

                    <!-- Room Grid -->
                    <div id="roomsGrid" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
                        <!-- Rooms will be injected here -->
                    </div>
                    
                    <!-- Empty State -->
                    <div id="emptyState" class="hidden flex flex-col items-center justify-center py-24 text-gray-400 bg-white rounded-xl border border-dashed border-gray-300">
                        <div class="bg-purple-50 p-4 rounded-full mb-4">
                            <i data-lucide="bed-double" class="w-10 h-10 text-purple-400"></i>
                        </div>
                        <h3 class="text-lg font-semibold text-gray-700">No rooms added yet</h3>
                        <p class="text-sm">Start by adding a room to manage beds and tenants.</p>
                        <button onclick="openAddRoomModal()" class="mt-4 text-purple-600 font-medium hover:underline">Add Room Now</button>
                    </div>

                </div>
            </div>
        </div>
        
        <!-- Mobile Sidebar Overlay -->
        <div id="mobile-overlay" class="fixed inset-0 bg-black/50 z-30 hidden md:hidden backdrop-blur-sm" onclick="toggleMobileMenu()"></div>
        <aside id="mobile-sidebar" class="fixed inset-y-0 left-0 w-72 bg-[#111827] z-40 transform -translate-x-full transition-transform duration-300 md:hidden flex flex-col shadow-2xl">
            <nav class="flex-1 py-4 space-y-1 px-2">
                 <a href="admin.html" class="flex items-center px-4 py-3 text-sm font-medium rounded-md text-gray-400 hover:bg-gray-800">Dashboard</a>
                 <a href="#" class="flex items-center px-4 py-3 text-sm font-medium rounded-md bg-gray-800 text-white border-l-4 border-purple-500">Rooms</a>
                 <a href="ownerlogin.html" onclick="localStorage.removeItem('user'); sessionStorage.clear();" class="flex items-center px-4 py-3 text-sm font-medium rounded-md text-red-400 hover:bg-gray-800 mt-4 border-t border-gray-700">Sign Out</a>
            </nav>
        </aside>
    </div>

    <!-- Add Room Modal -->
    <div id="roomModal" class="fixed inset-0 bg-black/60 hidden items-center justify-center z-50 backdrop-blur-sm transition-opacity">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6 relative transform transition-all scale-100">
            <button onclick="closeRoomModal()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 bg-gray-100 hover:bg-gray-200 p-1 rounded-full transition"><i data-lucide="x" class="w-5 h-5"></i></button>
            
            <div class="mb-6">
                <h3 class="text-xl font-bold text-gray-900">Add New Room</h3>
                <p class="text-sm text-gray-500">Configure room details and capacity.</p>
            </div>
            
            <form id="roomForm" onsubmit="saveRoom(event)">
                <div class="space-y-5">
                    <!-- Property Name (Read Only) -->
                    <div class="bg-gray-50 p-3 rounded-lg border border-gray-200">
                        <label class="block text-xs font-bold text-gray-500 uppercase tracking-wide mb-1">Property</label>
                        <div class="flex items-center text-sm font-medium text-gray-800">
                            <i data-lucide="building-2" class="w-4 h-4 mr-2 text-purple-500"></i>
                            <span id="modalPropertyNameText">Loading...</span>
                        </div>
                        <input type="hidden" id="modalPropertyId">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Room Number / Name</label>
                        <input type="text" id="roomNo" required class="w-full border border-gray-300 rounded-lg px-4 py-2.5 focus:ring-2 focus:ring-purple-500 focus:border-purple-500 outline-none transition" placeholder="e.g. 101, A-Wing">
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Room Type</label>
                            <div class="relative">
                                <select id="roomType" class="w-full border border-gray-300 rounded-lg px-4 py-2.5 pr-8 focus:ring-2 focus:ring-purple-500 outline-none appearance-none bg-white">
                                    <option value="AC">AC Room</option>
                                    <option value="Non-AC">Non-AC</option>
                                </select>
                                <i data-lucide="chevron-down" class="absolute right-3 top-3 w-4 h-4 text-gray-400 pointer-events-none"></i>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Rent / Month (₹)</label>
                            <input type="number" id="roomRent" required class="w-full border border-gray-300 rounded-lg px-4 py-2.5 focus:ring-2 focus:ring-purple-500 outline-none" placeholder="0.00">
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Gender</label>
                        <div class="relative">
                            <select id="roomGender" required class="w-full border border-gray-300 rounded-lg px-4 py-2.5 pr-8 focus:ring-2 focus:ring-purple-500 outline-none appearance-none bg-white">
                                <option value="">-- Select Gender --</option>
                                <option value="Boys">Boys</option>
                                <option value="Girls">Girls</option>
                                <option value="Co-ed">Co-ed</option>
                            </select>
                            <i data-lucide="chevron-down" class="absolute right-3 top-3 w-4 h-4 text-gray-400 pointer-events-none"></i>
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Initial Beds</label>
                        <div class="flex items-center border border-gray-300 rounded-lg overflow-hidden">
                            <button type="button" onclick="adjustBedCount(-1)" class="px-4 py-2.5 bg-gray-50 hover:bg-gray-100 text-gray-600 border-r">-</button>
                            <input type="number" id="roomBeds" required min="1" max="10" value="2" class="w-full text-center py-2.5 outline-none" readonly>
                            <button type="button" onclick="adjustBedCount(1)" class="px-4 py-2.5 bg-gray-50 hover:bg-gray-100 text-gray-600 border-l">+</button>
                        </div>
                        <p class="text-xs text-gray-500 mt-1">You can add/remove beds later.</p>
                    </div>
                </div>
                
                <div class="mt-8 flex justify-end gap-3">
                    <button type="button" onclick="closeRoomModal()" class="px-5 py-2.5 text-gray-700 hover:bg-gray-100 rounded-lg text-sm font-medium transition">Cancel</button>
                    <button type="submit" class="px-5 py-2.5 bg-purple-600 text-white rounded-lg text-sm font-medium hover:bg-purple-700 shadow-md hover:shadow-lg transition">Create Room</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Assign Tenant Modal -->
    <div id="assignModal" class="fixed inset-0 bg-black/60 hidden items-center justify-center z-50 backdrop-blur-sm">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6 relative">
            <button onclick="closeAssignModal()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 bg-gray-100 p-1 rounded-full"><i data-lucide="x" class="w-5 h-5"></i></button>
            
            <div class="text-center mb-6">
                <h3 class="text-xl font-bold text-gray-900">Assign Tenant</h3>
                <p class="text-sm text-gray-500" id="assignRoomTitle">Assigning to Room -</p>
            </div>
            
            <!-- Tabs -->
            <div class="flex mb-4 bg-gray-100 p-1 rounded-lg">
                <button onclick="toggleAssignTab('existing')" id="tabExisting" class="tab-btn active flex-1 py-2 text-sm font-medium rounded-md transition text-center">Select Existing</button>
                <button onclick="toggleAssignTab('new')" id="tabNew" class="tab-btn flex-1 py-2 text-sm font-medium rounded-md transition text-center text-gray-500">New Tenant</button>
            </div>

            <form onsubmit="confirmAssignment(event)">
                <input type="hidden" id="assignRoomId">
                <input type="hidden" id="assignBedIndex">
                <input type="hidden" id="assignMode" value="existing">
                
                <!-- Existing Tenant Section -->
                <div id="existingTenantSection" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Select Unassigned Tenant</label>
                        <select id="tenantSelect" class="w-full border border-gray-300 rounded-xl px-4 py-3 focus:ring-2 focus:ring-purple-500 outline-none bg-white">
                            <option value="">Select a tenant...</option>
                            <!-- Tenants loaded here -->
                        </select>
                    </div>
                </div>

                <!-- New Tenant Section -->
                <div id="newTenantSection" class="space-y-4 hidden">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Full Name</label>
                        <input type="text" id="newTenantName" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-purple-500 outline-none" placeholder="Enter name">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Phone Number</label>
                        <input type="tel" id="newTenantPhone" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-purple-500 outline-none" placeholder="Enter phone">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Email (Optional)</label>
                        <input type="email" id="newTenantEmail" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-purple-500 outline-none" placeholder="Enter email">
                    </div>
                </div>

                <div class="mt-8 flex justify-end gap-3">
                    <button type="button" onclick="closeAssignModal()" class="px-5 py-2.5 text-gray-600 hover:bg-gray-100 rounded-lg text-sm font-medium transition">Cancel</button>
                    <button type="submit" class="px-5 py-2.5 bg-green-600 text-white rounded-lg text-sm font-medium hover:bg-green-700 shadow-md transition flex items-center gap-2">
                        <i data-lucide="check" class="w-4 h-4"></i> Assign & Generate Login
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Credentials Modal -->
    <div id="credsModal" class="fixed inset-0 bg-black/70 hidden items-center justify-center z-50 backdrop-blur-sm">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm p-6 text-center animate-bounce-in">
            <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4 text-green-600">
                <i data-lucide="key" class="w-8 h-8"></i>
            </div>
            <h3 class="text-xl font-bold text-gray-900 mb-2">Login Created!</h3>
            <p class="text-sm text-gray-500 mb-6">Share these credentials with the tenant.</p>
            
            <div class="bg-slate-50 border border-slate-200 rounded-xl p-4 mb-6 text-left">
                <div class="mb-3">
                    <label class="text-xs font-bold text-slate-400 uppercase">Tenant Name</label>
                    <div class="font-bold text-slate-800" id="credName">Name</div>
                </div>
                <div class="mb-3">
                    <label class="text-xs font-bold text-slate-400 uppercase">Login ID</label>
                    <div class="flex justify-between items-center">
                        <code class="font-mono font-bold text-purple-600 text-lg" id="credLoginId">TNT123</code>
                        <button onclick="copyText('credLoginId')" class="text-gray-400 hover:text-purple-600"><i data-lucide="copy" class="w-4 h-4"></i></button>
                    </div>
                </div>
                <div>
                    <label class="text-xs font-bold text-slate-400 uppercase">Password</label>
                    <div class="flex justify-between items-center">
                        <code class="font-mono font-bold text-slate-700 text-lg" id="credPassword">pass123</code>
                        <button onclick="copyText('credPassword')" class="text-gray-400 hover:text-purple-600"><i data-lucide="copy" class="w-4 h-4"></i></button>
                    </div>
                </div>
            </div>
            
            <button onclick="closeCredsModal()" class="w-full bg-slate-900 text-white py-3 rounded-xl font-bold hover:bg-slate-800 transition">Done</button>
        </div>
    </div>

    <script>
        window.addEventListener('load', () => { if(typeof lucide!=='undefined') lucide.createIcons(); });

        // Backend base for dev (Live Server / different origin). Adjust if your backend runs elsewhere.
        const backendBase = (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') ? 'http://localhost:5000' : '';
        let backendRoomsCache = null; // store rooms fetched from backend for this owner

        // 1. Session & Property Init
        const user = JSON.parse(sessionStorage.getItem('owner_user') || sessionStorage.getItem('owner_session') || localStorage.getItem('user') || 'null');
        
        if(!user || user.role !== 'owner') {
            console.warn("No owner session found");
        }

        const ownerId = user ? (user.ownerId || user.loginId) : 'OWNER001';
        const areaCode = (user && user.locationCode) ? user.locationCode : 'KO'; 
        let currentProperty = null;

        // Load property associated with this Owner ID
        async function loadOwnerProperty() {
            // Try backend first: GET /api/owners/:loginId/rooms
            try {
                const res = await fetch(`${backendBase}/api/owners/${encodeURIComponent(ownerId)}/rooms`);
                if (res.ok) {
                    const data = await res.json();
                    // data: { properties, rooms }
                    if (data && Array.isArray(data.properties) && data.properties.length > 0) {
                        currentProperty = data.properties[0];
                    }
                    if (data && Array.isArray(data.rooms)) {
                        backendRoomsCache = data.rooms;
                    }
                }
            } catch (err) {
                // ignore and fallback to localStorage
                console.warn('Owner rooms fetch failed, falling back to localStorage', err);
            }

            // Fallback to localStorage properties if backend didn't return a property
            const properties = JSON.parse(localStorage.getItem('roomhy_properties') || '[]');
            if (!currentProperty) currentProperty = properties.find(p => p.ownerId === ownerId || p.ownerLoginId === ownerId || p.owner === ownerId);

            // If not found in property list, check Visit Reports (User Requirement)
            if (!currentProperty) {
                const visits = JSON.parse(localStorage.getItem('roomhy_visits') || '[]');
                console.debug('loadOwnerProperty: trying visits lookup', { ownerId, visitsCount: visits.length });

                // Find visit where generated credentials or other identifiers match the ownerId
                const matchedVisit = visits.find(v => {
                    const gv = v.generatedCredentials || v.generatedCreds || v.generated || {};
                    return String(v.loginId) === String(ownerId) ||
                        String(gv.loginId) === String(ownerId) ||
                        String(v.generatedId || '') === String(ownerId) ||
                        String(v.username || '') === String(ownerId) ||
                        (user && v.mobile && String(v.mobile) === String(user.phone));
                });

                console.debug('loadOwnerProperty: matchedVisit', matchedVisit);

                if (matchedVisit) {
                    // Prefer structured property info if present
                    const pInfo = matchedVisit.propertyInfo || matchedVisit.property || matchedVisit.propertyDetails || matchedVisit;
                    const pName = pInfo?.title || pInfo?.name || pInfo?.propertyName || matchedVisit.propertyName || matchedVisit.name || "Property Name";
                    const pLoc = pInfo?.location || pInfo?.city || pInfo?.address || matchedVisit.location || "Location";
                    const oName = pInfo?.ownerName || matchedVisit.ownerName || matchedVisit.owner || "Owner";

                    currentProperty = {
                        id: pInfo?._id || matchedVisit.propertyId || matchedVisit._id || matchedVisit.id || ('PROP_' + ownerId),
                        title: pName,
                        name: pName,
                        location: pLoc,
                        ownerName: oName
                    };

                    // Also update header name from Visit if session is generic
                    if (user && (user.name === 'Owner' || !user.name)) {
                        user.name = oName;
                        sessionStorage.setItem('owner_user', JSON.stringify(user));
                        // Update DOM immediately if elements exist
                        const hn = document.getElementById('headerOwnerName');
                        const ha = document.getElementById('headerAvatar');
                        if (hn) hn.innerText = user.name;
                        if (ha) ha.innerText = (user.name || 'O').charAt(0).toUpperCase();
                    }
                    console.debug('loadOwnerProperty: built currentProperty', currentProperty);
                }
            }

            const displayEl = document.getElementById('propertyNameDisplay');
            const modalDisplayEl = document.getElementById('modalPropertyNameText');
            const modalIdEl = document.getElementById('modalPropertyId');

                if (currentProperty) {
                const title = currentProperty.title || currentProperty.name || currentProperty.propertyName || currentProperty.displayName || currentProperty.propName || 'Property';
                const loc = currentProperty.location || currentProperty.locationCode || currentProperty.area || currentProperty.city || 'Unknown';
                const text = `${title} (${loc})`;
                if (displayEl) {
                    // render as a clickable link to the property page (use id when available)
                    displayEl.innerText = text;
                    const pid = currentProperty._id || currentProperty.id || currentProperty.propertyId || currentProperty.id;
                    if (pid) {
                        displayEl.href = `properties.html?id=${encodeURIComponent(pid)}`;
                        displayEl.target = '_self';
                    } else {
                        // fallback to properties list
                        displayEl.href = 'properties.html';
                        displayEl.target = '_self';
                    }
                }
                if(modalDisplayEl) modalDisplayEl.innerText = text;
                if(modalIdEl) modalIdEl.value = currentProperty._id || currentProperty.id || currentProperty.propertyId || currentProperty.id;
            } else {
                const errText = "No Property Linked (Contact Admin)";
                if(displayEl) { displayEl.innerText = errText; displayEl.removeAttribute('href'); }
                if(modalDisplayEl) modalDisplayEl.innerText = errText;
            }
            
            // Update Header Profile
            if(user) {
                const headerName = document.getElementById('headerOwnerName');
                const headerId = document.getElementById('headerOwnerId');
                const headerAvatar = document.getElementById('headerAvatar');
                
                if(headerName) headerName.innerText = user.name || 'Owner';
                if(headerId) headerId.innerText = `ID: ${ownerId}`;
                if(headerAvatar) headerAvatar.innerText = (user.name || 'O').charAt(0).toUpperCase();
            }
            
            // Profile Dropdown Logic
            const profileBtn = document.getElementById('profile-button');
            const profileDropdown = document.getElementById('profile-dropdown');
            if(profileBtn && profileDropdown) {
                profileBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const isHidden = profileDropdown.classList.contains('hidden');
                    if(isHidden) {
                        profileDropdown.classList.remove('hidden');
                        setTimeout(() => {
                            profileDropdown.classList.remove('scale-95', 'opacity-0');
                            profileDropdown.classList.add('scale-100', 'opacity-100');
                        }, 10);
                    } else {
                        profileDropdown.classList.remove('scale-100', 'opacity-100');
                        profileDropdown.classList.add('scale-95', 'opacity-0');
                        setTimeout(() => profileDropdown.classList.add('hidden'), 200);
                    }
                });
                document.addEventListener('click', () => {
                    if(!profileDropdown.classList.contains('hidden')) {
                        profileDropdown.classList.remove('scale-100', 'opacity-100');
                        profileDropdown.classList.add('scale-95', 'opacity-0');
                        setTimeout(() => profileDropdown.classList.add('hidden'), 200);
                    }
                });
            }
            
            if (typeof lucide !== 'undefined') lucide.createIcons();
            try { document.getElementById('roomsCount').innerText = 'Rooms: ' + myRooms.length; } catch(e){}
            try { const tenants = JSON.parse(localStorage.getItem('roomhy_tenants') || '[]'); document.getElementById('tenantsCount').innerText = 'Tenants: ' + tenants.length; } catch(e){}
        }

        // Check backend availability and update status UI
        async function checkBackendStatus() {
            const statusEl = document.getElementById('backendStatus');
            if (!backendBase) {
                if (statusEl) statusEl.innerText = 'Backend: disabled';
                return false;
            }
            try {
                const res = await fetch(`${backendBase}/api/owners/${encodeURIComponent(ownerId)}/rooms`, { method: 'GET' });
                if (res.ok) {
                    if (statusEl) statusEl.innerText = 'Backend: reachable';
                    return true;
                } else {
                    if (statusEl) statusEl.innerText = 'Backend: unreachable';
                    return false;
                }
            } catch (e) {
                if (statusEl) statusEl.innerText = 'Backend: connection failed';
                return false;
            }
        }

        // Load tenants from backend and store in localStorage (owner scoped)
        async function loadTenantsFromBackend() {
            if (!backendBase) return alert('Backend not configured.');
            try {
                const resp = await fetch(`${backendBase}/api/tenants/owner/${encodeURIComponent(ownerId)}`);
                if (!resp.ok) return alert('Failed to fetch tenants from backend: ' + resp.status);
                const data = await resp.json();
                // Expect data to be an array or object with .data
                const tenants = Array.isArray(data) ? data : (data.data || data.tenants || []);
                if (!Array.isArray(tenants)) return alert('Unexpected tenants response');
                localStorage.setItem('roomhy_tenants', JSON.stringify(tenants));
                document.getElementById('tenantsCount').innerText = 'Tenants: ' + tenants.length;
                alert('Imported ' + tenants.length + ' tenants into localStorage');
                // refresh room UI
                loadRooms();
            } catch (e) {
                console.error('loadTenantsFromBackend error', e);
                alert('Error importing tenants: ' + e.message);
            }
        }

        // 2. Load Rooms
        async function loadRooms() {
            // Try backend cache first
            let myRooms = [];
            if (backendRoomsCache && Array.isArray(backendRoomsCache)) {
                myRooms = backendRoomsCache.filter(r => (r.ownerLoginId === ownerId) || (r.owner && r.owner.loginId === ownerId) || (r.ownerId === ownerId));
            }

            // If backend didn't return rooms, fallback to localStorage
            if (!myRooms || myRooms.length === 0) {
                const allRooms = JSON.parse(localStorage.getItem('roomhy_rooms') || '[]');
                myRooms = allRooms.filter(r => r.ownerId === ownerId || r.ownerLoginId === ownerId || r.owner === ownerId);

                // If still no rooms (session ownerId might be missing), try matching by current property
                if((!myRooms || myRooms.length === 0) && currentProperty) {
                    const pid = currentProperty._id || currentProperty.id || currentProperty.propertyId || currentProperty.id;
                    myRooms = allRooms.filter(r => r.propertyId === pid || r.propertyTitle === (currentProperty.title || currentProperty.name));
                    if(myRooms && myRooms.length > 0) console.debug('loadRooms: matched rooms by property fallback', pid, myRooms.length);
                }
            }

            // Deduplicate rooms by room number + property to prevent showing the same room twice
            // (same room may exist in both localStorage and backend with different IDs)
            const seenRoomKeys = new Set();
            myRooms = myRooms.filter(room => {
                const propId = room.propertyId || room.property?._id || room.property?.id || '';
                const roomNum = room.number || '';
                const roomKey = `${propId}:${roomNum}`;
                
                if (seenRoomKeys.has(roomKey)) {
                    console.debug('loadRooms: filtering duplicate room', { roomKey, roomId: room.id || room._id });
                    return false;
                }
                seenRoomKeys.add(roomKey);
                return true;
            });
            
            const grid = document.getElementById('roomsGrid');
            if(!grid) return;
            grid.innerHTML = '';

            const emptyState = document.getElementById('emptyState');
            if (myRooms.length === 0) {
                if(emptyState) emptyState.classList.remove('hidden');
                return;
            }
            if(emptyState) emptyState.classList.add('hidden');

            myRooms.forEach(room => {
                const bedsVisuals = generateBedsVisuals(room);
                const occupied = room.beds.filter(b => b.status === 'occupied').length;
                const total = room.beds.length;
                const percent = Math.round((occupied / total) * 100);
                
                const borderColorClass = room.type === 'AC' ? 'room-card-ac' : 'room-card-nonac';
                const badgeColor = room.type === 'AC' ? 'bg-blue-100 text-blue-700' : 'bg-amber-100 text-amber-700';

                const card = document.createElement('div');
                card.className = `bg-white rounded-xl shadow-sm border border-gray-100 p-0 flex flex-col room-card ${borderColorClass}`;
                
                card.innerHTML = `
                    <!-- Card Header -->
                    <div class="p-5 pb-3 border-b border-gray-50">
                        <div class="flex justify-between items-start">
                            <div>
                                <div class="flex items-center gap-2 mb-1">
                                    <h3 class="text-lg font-bold text-gray-800">Room ${room.number}</h3>
                                    <span class="text-[10px] font-bold px-2 py-0.5 rounded-full ${badgeColor} uppercase tracking-wide">${room.type}</span>
                                    ${room.source === 'tenant' ? '<span class="text-[10px] font-bold px-2 py-0.5 rounded-full bg-blue-100 text-blue-700 uppercase tracking-wide">From Visit</span>' : ''}
                                    
                                    ${room.approvalStatus === 'auto-approved' ? '<span class="text-[10px] font-bold px-2 py-0.5 rounded-full bg-green-100 text-green-700 uppercase tracking-wide">Approved</span>' : ''}
                                </div>
                                <div class="text-xs text-gray-400">Capacity: ${total} Beds</div>
                            </div>
                            <div class="text-right">
                                <div class="text-lg font-bold text-slate-700">₹${room.rent}<span class="text-xs text-gray-400 font-normal">/mo</span></div>
                            </div>
                        </div>
                        
                        <div class="mt-3 flex items-center gap-2">
                            <div class="flex-1 h-1.5 bg-gray-100 rounded-full overflow-hidden">
                                <div class="h-full bg-green-500 rounded-full" style="width: ${percent}%"></div>
                            </div>
                            <span class="text-[10px] font-bold text-gray-500">${occupied}/${total}</span>
                        </div>
                    </div>
                    
                    <div class="p-5 bg-slate-50 flex-1">
                        <div class="grid grid-cols-2 gap-3">
                            ${bedsVisuals}
                            <div onclick="addBedToRoom('${room.id}')" class="add-bed-btn p-3 rounded-lg flex flex-col items-center justify-center text-center cursor-pointer transition h-full min-h-[80px]" title="Add another bed">
                                <div class="w-8 h-8 rounded-full bg-white flex items-center justify-center mb-1 shadow-sm text-gray-400">
                                    <i data-lucide="plus" class="w-4 h-4"></i>
                                </div>
                                <span class="text-xs font-semibold">Add Bed</span>
                            </div>
                        </div>
                    </div>

                    <div class="px-5 py-3 bg-white border-t border-gray-100 flex justify-end gap-2">
                        ${room.source === 'tenant' ? '<span class="text-xs text-gray-500 flex items-center gap-1"><i data-lucide="lock" class="w-3 h-3"></i> Read-only (from visit)</span>' : ''}
                                    
                        <button onclick="deleteRoom('${room.id}')" ${room.source === 'tenant' ? 'disabled' : ''} class="text-gray-400 hover:text-red-500 disabled:text-gray-200 disabled:cursor-not-allowed text-xs font-medium flex items-center gap-1 transition">
                            <i data-lucide="trash-2" class="w-3 h-3"></i> Remove Room
                        </button>
                    </div>
                `;
                grid.appendChild(card);
            });
            if (typeof lucide !== 'undefined') lucide.createIcons();
        }

        function generateBedsVisuals(room) {
            return room.beds.map((bed, idx) => {
                const bedNum = idx + 1;
                if (bed.status === 'occupied') {
                    return `
                    <div class="bed-item bed-occupied p-3 rounded-lg relative group h-full min-h-[80px] flex flex-col justify-between">
                        <div class="flex items-start justify-between">
                            <div class="flex items-center gap-1.5">
                                <div class="w-6 h-6 rounded-full bg-green-200 text-green-700 flex items-center justify-center text-[10px] font-bold">
                                    ${(bed.tenantName || 'U').charAt(0)}
                                </div>
                                <span class="text-xs font-bold text-green-800 truncate max-w-[60px]">${bed.tenantName || 'User'}</span>
                            </div>
                            <span class="text-[9px] font-bold text-green-600 bg-green-100 px-1 rounded">B${bedNum}</span>
                        </div>
                        <div class="mt-2 text-[10px] text-green-600 flex items-center gap-1">
                            <span class="w-1.5 h-1.5 bg-green-500 rounded-full animate-pulse"></span> Active
                        </div>
                        <div class="absolute inset-0 bg-white/95 rounded-lg flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity cursor-pointer border border-red-200" onclick="vacateBed('${room.id}', ${idx})">
                            <span class="text-red-500 text-xs font-bold flex items-center gap-1"><i data-lucide="log-out" class="w-3 h-3"></i> Vacate</span>
                        </div>
                    </div>`;
                } else {
                    return `
                    <div onclick="openAssignModal('${room.id}', ${idx}, '${room.number}')" class="bed-item bed-empty p-3 rounded-lg flex flex-col items-center justify-center text-center relative group h-full min-h-[80px]">
                        <span class="absolute top-1 left-2 text-[9px] font-bold text-gray-300">B${bedNum}</span>
                        <div class="text-purple-300 group-hover:text-purple-500 transition-colors mb-1">
                            <i data-lucide="user-plus" class="w-5 h-5"></i>
                        </div>
                        <span class="text-xs font-semibold group-hover:underline">Assign</span>
                        <button onclick="removeBedFromRoom('${room.id}', ${idx}, event)" class="absolute -top-1.5 -right-1.5 bg-white text-gray-300 hover:text-red-500 shadow-sm border border-gray-100 rounded-full p-0.5 opacity-0 group-hover:opacity-100 transition-all hover:scale-110" title="Remove Bed">
                            <i data-lucide="x" class="w-3 h-3"></i>
                        </button>
                    </div>`;
                }
            }).join('');
        }

        // 3. Save Room
        function saveRoom(e) {
            e.preventDefault();
            const propId = document.getElementById('modalPropertyId').value;
            const number = document.getElementById('roomNo').value;
            const type = document.getElementById('roomType').value;
            const rent = document.getElementById('roomRent').value;
            const gender = document.getElementById('roomGender').value;
            const bedCount = parseInt(document.getElementById('roomBeds').value);

            if (!propId) return alert("Property not loaded. Cannot add room.");

            const beds = Array(bedCount).fill().map(() => ({ status: 'available', tenantId: null, tenantName: null }));

            const newRoom = {
                id: 'ROOM-' + Date.now(),
                ownerId: ownerId,
                ownerLoginId: (user && (user.loginId || user.ownerId)) || ownerId,
                owner: (user && (user.name || user.ownerName)) || undefined,
                propertyId: propId,
                propertyTitle: document.getElementById('modalPropertyNameText') ? document.getElementById('modalPropertyNameText').innerText : '',
                number,
                type,
                rent,
                gender,
                beds,
                source: 'owner',
                submittedAt: new Date().toISOString(),
                submittedBy: (user && (user.name || user.ownerName)) || 'Owner',
                approvalStatus: 'auto-approved'
            };

            const allRooms = JSON.parse(localStorage.getItem('roomhy_rooms') || '[]');
            allRooms.push(newRoom);
            try {
                localStorage.setItem('roomhy_rooms', JSON.stringify(allRooms));
            } catch (err) {
                console.error('Failed to save roomhy_rooms:', err);
            }

            closeRoomModal();
            loadRooms();
        }

        // 4. Manage Bed Logic
        function addBedToRoom(roomId) {
            const allRooms = JSON.parse(localStorage.getItem('roomhy_rooms') || '[]');
            const roomIdx = allRooms.findIndex(r => r.id === roomId);
            if (roomIdx !== -1) {
                if(allRooms[roomIdx].beds.length >= 10) return alert("Maximum 10 beds per room.");
                allRooms[roomIdx].beds.push({ status: 'available', tenantId: null, tenantName: null });
                try { localStorage.setItem('roomhy_rooms', JSON.stringify(allRooms)); } catch(e){ console.error('Failed to save roomhy_rooms after addBed:', e); }
                loadRooms();
            }
        }

        function removeBedFromRoom(roomId, bedIdx, event) {
            event.stopPropagation();
            if(!confirm("Remove this bed slot permanently?")) return;
            const allRooms = JSON.parse(localStorage.getItem('roomhy_rooms') || '[]');
            const roomIdx = allRooms.findIndex(r => r.id === roomId);
            if (roomIdx !== -1) {
                allRooms[roomIdx].beds.splice(bedIdx, 1);
                localStorage.setItem('roomhy_rooms', JSON.stringify(allRooms));
                loadRooms();
            }
        }

        function adjustBedCount(delta) {
            const input = document.getElementById('roomBeds');
            let val = parseInt(input.value) + delta;
            if(val < 1) val = 1;
            if(val > 10) val = 10;
            input.value = val;
        }

        // 5. Assign Tenant Logic with TABS
        function openAssignModal(roomId, bedIndex, roomNum) {
            document.getElementById('assignRoomId').value = roomId;
            document.getElementById('assignBedIndex').value = bedIndex;
            const titleEl = document.getElementById('assignRoomTitle');
            if(titleEl) titleEl.innerText = `Assigning to Room ${roomNum} - Bed ${bedIndex + 1}`;
            
            const tenants = JSON.parse(localStorage.getItem('roomhy_tenants') || '[]');
            const available = tenants.filter(t => t.ownerId === ownerId && !t.roomNo);
            
            const select = document.getElementById('tenantSelect');
            select.innerHTML = '<option value="">Select a tenant...</option>';
            
            if (available.length === 0) {
                const opt = document.createElement('option');
                opt.text = "No unassigned tenants found";
                opt.disabled = true;
                select.add(opt);
            } else {
                available.forEach(t => {
                    const opt = document.createElement('option');
                    opt.value = t.id || t.loginId;
                    opt.text = t.name;
                    select.add(opt);
                });
            }

            toggleAssignTab('new');
            const modal = document.getElementById('assignModal');
            if(modal) {
                modal.classList.remove('hidden');
                modal.classList.add('flex');
            }
        }

        function toggleAssignTab(mode) {
            const inputMode = document.getElementById('assignMode');
            if(inputMode) inputMode.value = mode;
            
            const secExist = document.getElementById('existingTenantSection');
            const secNew = document.getElementById('newTenantSection');
            const tabEx = document.getElementById('tabExisting');
            const tabNew = document.getElementById('tabNew');

            if (mode === 'existing') {
                if(secExist) secExist.classList.remove('hidden');
                if(secNew) secNew.classList.add('hidden');
                if(tabEx) { tabEx.classList.add('active', 'bg-white', 'text-purple-600', 'shadow-sm'); tabEx.classList.remove('text-gray-500'); }
                if(tabNew) { tabNew.classList.remove('active', 'bg-white', 'text-purple-600', 'shadow-sm'); tabNew.classList.add('text-gray-500'); }
            } else {
                if(secExist) secExist.classList.add('hidden');
                if(secNew) secNew.classList.remove('hidden');
                if(tabNew) { tabNew.classList.add('active', 'bg-white', 'text-purple-600', 'shadow-sm'); tabNew.classList.remove('text-gray-500'); }
                if(tabEx) { tabEx.classList.remove('active', 'bg-white', 'text-purple-600', 'shadow-sm'); tabEx.classList.add('text-gray-500'); }
            }
        }

        function confirmAssignment(e) {
            e.preventDefault();
            const mode = document.getElementById('assignMode').value;
            const roomId = document.getElementById('assignRoomId').value;
            const bedIdx = parseInt(document.getElementById('assignBedIndex').value);
            
            let tenantId, tenantName;
            
            const allRooms = JSON.parse(localStorage.getItem('roomhy_rooms') || '[]');
            const roomIdx = allRooms.findIndex(r => r.id === roomId);
            if (roomIdx === -1) return;

            const tenants = JSON.parse(localStorage.getItem('roomhy_tenants') || '[]');

            if (mode === 'existing') {
                tenantId = document.getElementById('tenantSelect').value;
                if (!tenantId) return alert("Select a tenant");
                const t = tenants.find(x => x.id === tenantId || x.loginId === tenantId);
                if(!t) return;
                tenantName = t.name;
                
                if (!t.loginId) {
                    const creds = generateCredentials(areaCode);
                    t.loginId = creds.loginId;
                    t.password = creds.password;
                    showCredentialsModal(t.name, t.loginId, t.password, t.email);
                }
                t.roomNo = allRooms[roomIdx].number;
                t.bedNo = bedIdx + 1;
                t.propertyId = allRooms[roomIdx].propertyId;
                // assign property object or fallback to title for display
                try {
                    const props = JSON.parse(localStorage.getItem('roomhy_properties') || '[]');
                    const prop = props.find(p => (p._id && p._id === t.propertyId) || (p.id && p.id === t.propertyId) || (p.propertyId && p.propertyId === t.propertyId) || (p.title && p.title === t.propertyId) || (p.name && p.name === t.propertyId));
                    if (prop) t.property = prop;
                    else if (allRooms[roomIdx].propertyTitle) t.property = { title: allRooms[roomIdx].propertyTitle };
                    else if (currentProperty) t.property = { title: currentProperty.title || currentProperty.name };
                } catch (err) {}
                t.assignedBy = ownerId;
            } else {
                const name = document.getElementById('newTenantName').value.trim();
                const phone = document.getElementById('newTenantPhone').value.trim();
                const email = document.getElementById('newTenantEmail').value.trim();
                
                if (!name || !phone) return alert("Name and Phone required");

                const creds = generateCredentials(areaCode);
                const newTenant = {
                    id: 'TNT-' + Date.now(),
                    loginId: creds.loginId,
                    password: creds.password,
                    name: name,
                    phone: phone,
                    email: email,
                    ownerId: ownerId,
                    roomNo: allRooms[roomIdx].number,
                    bedNo: bedIdx + 1,
                    propertyId: allRooms[roomIdx].propertyId,
                    // attach property object for immediate display in tenant records
                    property: (function(){
                        try {
                            const props = JSON.parse(localStorage.getItem('roomhy_properties') || '[]');
                            const pid = allRooms[roomIdx].propertyId;
                            const found = props.find(p => (p._id && p._id === pid) || (p.id && p.id === pid) || (p.propertyId && p.propertyId === pid) || (p.title && p.title === pid) || (p.name && p.name === pid));
                            if (found) return found;
                        } catch(e) {}
                        if (allRooms[roomIdx].propertyTitle) return { title: allRooms[roomIdx].propertyTitle };
                        if (currentProperty) return { title: currentProperty.title || currentProperty.name };
                        return allRooms[roomIdx].propertyId || '';
                    })(),
                    status: 'Active',
                    assignedBy: ownerId,
                    joinedDate: new Date().toISOString().split('T')[0]
                };
                
                tenants.push(newTenant);
                tenantId = newTenant.loginId;
                tenantName = name;

                // Best-effort: create tenant in backend (MongoDB Atlas) so tenant is persisted server-side
                (async () => {
                    try {
                        const payload = {
                            name: newTenant.name,
                            phone: newTenant.phone,
                            email: newTenant.email,
                            propertyId: newTenant.propertyId,
                            roomNo: newTenant.roomNo,
                            bedNo: newTenant.bedNo,
                            moveInDate: newTenant.joinedDate,
                            agreedRent: newTenant.agreedRent || 0
                        };
                        const assignUrl = `${backendBase}/api/tenants/assign`;
                        const resp = await fetch(assignUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });
                        if (resp.ok) {
                            const d = await resp.json();
                            if (d && d.tenant) {
                                // update local tenant with server-side identifiers
                                const idx = tenants.findIndex(x => x.loginId === newTenant.loginId || x.id === newTenant.id);
                                if (idx !== -1) {
                                    tenants[idx].dbId = d.tenant.id || d.tenant._id;
                                    tenants[idx].loginId = d.tenant.loginId || tenants[idx].loginId;
                                    tenants[idx].tempPassword = d.tenant.tempPassword || tenants[idx].tempPassword;
                                    tenants[idx].property = d.tenant.property || tenants[idx].property;
                                }
                            }
                        }
                    } catch (err) {
                        console.warn('Tenant assign to backend failed (continuing with local record):', err);
                    }
                })();

                showCredentialsModal(name, creds.loginId, creds.password, email);
            }

            allRooms[roomIdx].beds[bedIdx] = {
                status: 'occupied',
                tenantId: tenantId,
                tenantName: tenantName
            };
            localStorage.setItem('roomhy_rooms', JSON.stringify(allRooms));
            localStorage.setItem('roomhy_tenants', JSON.stringify(tenants));

            closeAssignModal();
            loadRooms();
        }

        function generateCredentials(code) {
            const random = Math.floor(1000 + Math.random() * 9000);
            const loginId = `TNT${code}${random}`;
            const password = Math.random().toString(36).slice(-8);
            return { loginId, password };
        }

        function showCredentialsModal(name, id, pass, email) {
            const nameEl = document.getElementById('credName');
            const idEl = document.getElementById('credLoginId');
            const passEl = document.getElementById('credPassword');
            const modal = document.getElementById('credsModal');

            if(nameEl) nameEl.innerText = name;
            if(idEl) idEl.innerText = id;
            if(passEl) passEl.innerText = pass;
            
            if(modal) {
                modal.classList.remove('hidden');
                modal.classList.add('flex');
            }
            
            // Send email credentials if email provided
            if (email) {
                try {
                    const emailHtml = `
                        <!DOCTYPE html>
                        <html>
                        <head>
                            <style>
                                body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; }
                                .container { max-width: 600px; margin: 0 auto; padding: 20px; background-color: #f9f9f9; border-radius: 8px; }
                                .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; text-align: center; border-radius: 8px 8px 0 0; }
                                .header h1 { margin: 0; font-size: 28px; }
                                .content { background: white; padding: 30px; border-radius: 0 0 8px 8px; }
                                .credentials-box { background: #f5f5f5; border: 2px solid #667eea; padding: 20px; margin: 20px 0; border-radius: 8px; font-family: 'Courier New', monospace; }
                                .credentials-box p { margin: 10px 0; font-size: 14px; }
                                .label { color: #666; font-weight: bold; }
                                .value { color: #000; font-weight: bold; font-size: 16px; }
                                .footer { text-align: center; padding: 20px; color: #666; font-size: 12px; }
                            </style>
                        </head>
                        <body>
                            <div class="container">
                                <div class="header">
                                    <h1>🏠 Welcome to RoomHy!</h1>
                                </div>
                                <div class="content">
                                    <p>Hi ${name},</p>
                                    
                                    <p>You have been successfully assigned a room. Your tenant account has been created on the RoomHy platform. Here are your login credentials:</p>
                                    
                                    <div class="credentials-box">
                                        <p><span class="label">Login ID:</span><br><span class="value">${id}</span></p>
                                        <p><span class="label">Password:</span><br><span class="value">${pass}</span></p>
                                    </div>
                                    
                                    <p><strong>Next Steps:</strong></p>
                                    <ol>
                                        <li>Log in to your tenant portal using the credentials above</li>
                                        <li>Complete your profile information</li>
                                        <li>Upload necessary documents</li>
                                        <li>Connect with property management</li>
                                    </ol>
                                    
                                    <p style="color: #d32f2f; font-weight: bold;">⚠️ Important: Please keep these credentials secure and change your password on first login.</p>
                                    
                                    <p>If you have any questions, please contact property management.</p>
                                </div>
                                <div class="footer">
                                    <p>© 2026 Roomhy. All rights reserved.</p>
                                </div>
                            </div>
                        </body>
                        </html>
                    `;
                    
                    fetch('https://roomhy-backend-wqwo.onrender.com/api/email/send', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            to: email,
                            subject: '🏠 Your RoomHy Tenant Account Credentials',
                            html: emailHtml
                        })
                    }).then(res => res.json()).then(data => {
                        if (data.success) {
                            console.log('✅ Credentials email sent to:', email);
                        } else {
                            console.warn('⚠️ Failed to send email:', data.message);
                        }
                    }).catch(err => console.error('❌ Email send error:', err));
                } catch (err) {
                    console.error('Error preparing email:', err);
                }
            }
        }
        function closeCredsModal() {
            const modal = document.getElementById('credsModal');
            if(modal) {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
            }
        }
        function copyText(id) {
            const text = document.getElementById(id).innerText;
            navigator.clipboard.writeText(text);
            alert("Copied!");
        }

        function vacateBed(roomId, bedIdx) {
            if(!confirm("Remove tenant from this bed?")) return;
            const allRooms = JSON.parse(localStorage.getItem('roomhy_rooms') || '[]');
            const roomIdx = allRooms.findIndex(r => r.id === roomId);
            if (roomIdx === -1) return;

            const tenantId = allRooms[roomIdx].beds[bedIdx].tenantId;
            allRooms[roomIdx].beds[bedIdx] = { status: 'available', tenantId: null, tenantName: null };
            localStorage.setItem('roomhy_rooms', JSON.stringify(allRooms));

            if (tenantId) {
                const tenants = JSON.parse(localStorage.getItem('roomhy_tenants') || '[]');
                const tIdx = tenants.findIndex(t => (t.id === tenantId || t.loginId === tenantId));
                if (tIdx !== -1) {
                    delete tenants[tIdx].roomNo;
                    delete tenants[tIdx].bedNo;
                    delete tenants[tIdx].propertyId;
                    localStorage.setItem('roomhy_tenants', JSON.stringify(tenants));
                }
            }
            loadRooms();
        }

        function deleteRoom(roomId) {
            let allRooms = JSON.parse(localStorage.getItem('roomhy_rooms') || '[]');
            
            const room = allRooms.find(r => r.id === roomId);
            if(!room) return alert('Room not found');
            
            // Prevent deletion of tenant-added rooms
            if(room.source === 'tenant') return alert('Cannot delete rooms added from visit reports. This room was created by area manager inspection.');
            
            // Prevent deletion of pending rooms
            // allow deletion for owner-created rooms; tenant-sourced rooms remain read-only
            if(room.source === 'tenant') return alert('Cannot delete rooms created from visit reports. Contact area manager.');
            
            if(!confirm("Delete this room? Tenants will be unassigned.")) return;
            
            if(room) {
                const tenants = JSON.parse(localStorage.getItem('roomhy_tenants') || '[]');
                let updatedTenants = false;
                room.beds.forEach(bed => {
                    if(bed.tenantId) {
                        const tIdx = tenants.findIndex(t => t.id === bed.tenantId || t.loginId === bed.tenantId);
                        if(tIdx !== -1) {
                            delete tenants[tIdx].roomNo;
                            delete tenants[tIdx].bedNo;
                            updatedTenants = true;
                        }
                    }
                });
                if(updatedTenants) localStorage.setItem('roomhy_tenants', JSON.stringify(tenants));
            }

            allRooms = allRooms.filter(r => r.id !== roomId);
            localStorage.setItem('roomhy_rooms', JSON.stringify(allRooms));
            loadRooms();
        }

        // Modal Helpers
        function openAddRoomModal() {
            const modal = document.getElementById('roomModal');
            if(modal) {
                // Reset form
                document.getElementById('roomForm').reset();
                document.getElementById('roomBeds').value = '2';
                document.getElementById('roomGender').value = '';
                modal.classList.remove('hidden');
                modal.classList.add('flex');
            }
        }
        function closeRoomModal() {
            const modal = document.getElementById('roomModal');
            if(modal) {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
            }
        }
        function closeAssignModal() {
            const modal = document.getElementById('assignModal');
            if(modal) {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
            }
        }
        function toggleMobileMenu() {
            const sidebar = document.getElementById('mobile-sidebar');
            const overlay = document.getElementById('mobile-overlay');
            if(sidebar) sidebar.classList.toggle('-translate-x-full');
            if(overlay) overlay.classList.toggle('hidden');
        }
        
        const menuBtn = document.getElementById('mobile-menu-button'); // Fixed ID
        if(menuBtn) menuBtn.addEventListener('click', toggleMobileMenu);

        // Init (ensure backend calls complete before rendering)
        (async function initPage(){
            await loadOwnerProperty();
            await checkBackendStatus();
            await loadRooms();
        })();

    </script>
</body>
</html>