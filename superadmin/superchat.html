<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Super Admin - All Messages</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { font-family: 'Inter', sans-serif; }
        .sidebar { background-color: #111827; color: #9ca3af; }
        .sidebar-link { color: #9ca3af; font-weight: 500; transition: all 0.2s ease; display: flex; align-items: center; padding: 0.75rem 1.5rem; font-size: 0.9rem; border-left: 3px solid transparent; cursor: pointer; }
        .sidebar-link:hover { color: #f3f4f6; background-color: #1f2937; }
        .sidebar-link.active { background-color: #1f2937; color: #ffffff; border-left-color: #f59e0b; }
        .message-own { @apply bg-amber-100 border-l-4 border-amber-500 ml-auto mr-0 max-w-xs; }
        .message-other { @apply bg-gray-100 border-l-4 border-gray-400 ml-0 mr-auto max-w-xs; }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 4px; }
    </style>
</head>
<body class="bg-gray-50">
    <div class="flex h-screen">
        <!-- Sidebar -->
        <aside class="sidebar w-72 flex-shrink-0 hidden md:flex flex-col z-20 overflow-y-auto custom-scrollbar">
            <div class="h-16 flex items-center px-6 border-b border-gray-800 sticky top-0 bg-[#111827] z-10">
                <div class="flex items-center gap-3">
                    <div class="bg-amber-600 p-1.5 rounded-lg"><i data-lucide="shield-alert" class="w-5 h-5 text-white"></i></div>
                    <div><h1 class="text-xl font-bold text-white">RoomHy</h1><span class="text-[10px] text-gray-500">SUPER ADMIN</span></div>
                </div>
            </div>
            <nav class="flex-1 py-6 space-y-1">
                <a href="#" class="sidebar-link active"><i data-lucide="mail" class="w-5 h-5 mr-3"></i> All Messages</a>
                <a href="superadmin.html" class="sidebar-link"><i data-lucide="layout-dashboard" class="w-5 h-5 mr-3"></i> Dashboard</a>
                <a href="enquiry.html" class="sidebar-link"><i data-lucide="clipboard-list" class="w-5 h-5 mr-3"></i> Enquiries</a>
                <a href="users.html" class="sidebar-link"><i data-lucide="users" class="w-5 h-5 mr-3"></i> Users</a>
                <a href="settings.html" class="sidebar-link"><i data-lucide="settings" class="w-5 h-5 mr-3"></i> Settings</a>
            </nav>
            <div class="p-4 border-t border-gray-800">
                <button onclick="logout()" class="w-full px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 text-sm font-medium">
                    Logout
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <div class="flex-1 flex flex-col overflow-hidden">
            <!-- Header -->
            <header class="bg-white h-16 flex items-center justify-between px-6 shadow-sm z-10 border-b border-gray-200">
                <div class="flex items-center">
                    <button id="mobile-menu-open" class="md:hidden mr-4 text-slate-500"><i data-lucide="menu" class="w-6 h-6"></i></button>
                    <h2 class="text-lg font-semibold text-slate-800">All System Messages</h2>
                </div>
                <div class="flex items-center gap-4">
                    <div id="connectionStatus" class="flex items-center gap-2">
                        <span id="statusDot" class="w-2 h-2 bg-yellow-500 rounded-full"></span>
                        <p class="text-xs text-gray-600">Connecting</p>
                    </div>
                </div>
            </header>

            <!-- Messages Area -->
            <div class="flex-1 overflow-y-auto p-6 bg-gray-50">
                <div id="messagesContainer" class="max-w-6xl mx-auto space-y-4">
                    <div class="text-center text-gray-400 mt-20">
                        <i data-lucide="mail-open" class="w-16 h-16 mx-auto mb-4 opacity-30"></i>
                        <p>Loading all system messages...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Mobile Overlay -->
    <div id="mobile-overlay" class="fixed inset-0 bg-black/50 z-30 hidden backdrop-blur-sm" onclick="toggleMobileMenu()"></div>

    <script>
        const API_URL = 'https://roomhy-backend.onrender.com';
        let socket = null;
        let superAdminLoginId = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            const user = JSON.parse(localStorage.getItem('superadmin_user') || 'null');
            if (!user || !user.loginId) {
                // Allow for demo/testing - generate a default super admin ID
                superAdminLoginId = 'superadmin_system';
                console.warn('âš ï¸ No super admin user found, using demo ID');
            } else {
                superAdminLoginId = user.loginId;
            }

            console.log('âœ“ Super Admin initialized:', superAdminLoginId);

            initSocket();
            loadAllMessages();
            setupAutoRefresh();
            lucide.createIcons();
        });

        // Initialize Socket.IO
        function initSocket() {
            socket = io(API_URL);

            socket.on('connect', () => {
                console.log('âœ“ Connected to chat');
                updateStatus('Connected', 'green');
                socket.emit('join_room', {
                    login_id: superAdminLoginId,
                    role: 'superadmin',
                    name: 'Super Admin System'
                });
            });

            socket.on('receive_message', (msg) => {
                console.log('ðŸ“¨ New message received:', msg);
                displayMessage(msg);
            });

            socket.on('disconnect', () => {
                console.log('Disconnected');
                updateStatus('Disconnected', 'red');
            });

            socket.on('error', (data) => {
                console.error('Socket error:', data);
                updateStatus('Error', 'red');
            });
        }

        // Load all messages from database
        async function loadAllMessages() {
            try {
                const response = await fetch(`${API_URL}/api/chat/messages/all`, {
                    headers: { 'X-Admin': 'true' }
                });

                let messages = [];
                if (response.status === 404) {
                    // Fallback: load from multiple rooms
                    console.log('Loading messages from all known rooms...');
                    messages = await loadMessagesFromAllRooms();
                } else if (response.ok) {
                    messages = await response.json();
                }

                document.getElementById('messagesContainer').innerHTML = '';

                if (!messages || messages.length === 0) {
                    document.getElementById('messagesContainer').innerHTML = `
                        <div class="text-center text-gray-400 py-16">
                            <i data-lucide="inbox" class="w-16 h-16 mx-auto mb-4 opacity-30"></i>
                            <p class="text-lg font-medium">No messages in system</p>
                            <p class="text-sm mt-2">Messages will appear here as users communicate</p>
                        </div>
                    `;
                    return;
                }

                // Sort messages by timestamp (newest first)
                messages.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));

                // Display each message
                messages.forEach(msg => displayMessage(msg));
                console.log(`âœ“ Loaded ${messages.length} messages`);
            } catch (error) {
                console.error('Error loading messages:', error);
                document.getElementById('messagesContainer').innerHTML = `
                    <div class="text-center text-red-400 py-16">
                        <i data-lucide="alert-circle" class="w-16 h-16 mx-auto mb-4"></i>
                        <p class="text-lg font-medium">Error loading messages</p>
                        <p class="text-sm mt-2">${error.message}</p>
                    </div>
                `;
            }
        }

        // Fallback: Load messages from known room patterns
        async function loadMessagesFromAllRooms() {
            const rooms = [
                'owner_1', 'owner_2', 'owner_3',
                'tenant_apt101_1', 'tenant_apt102_1',
                'areamanager_zone1', 'areamanager_zone2',
                'web_user_guest', 'web_user_visitor',
                'superadmin_system'
            ];

            let allMessages = [];

            for (const room of rooms) {
                try {
                    const response = await fetch(`${API_URL}/api/chat/messages/${room}`);
                    if (response.ok) {
                        const messages = await response.json();
                        allMessages = allMessages.concat(messages);
                    }
                } catch (error) {
                    console.log(`Could not load from room: ${room}`);
                }
            }

            return allMessages;
        }

        // Display message in timeline
        function displayMessage(msg) {
            const container = document.getElementById('messagesContainer');

            // Clear placeholder if it exists
            const placeholder = container.querySelector('[data-lucide="inbox"]');
            if (placeholder) {
                container.innerHTML = '';
            }

            const div = document.createElement('div');
            div.className = 'bg-white rounded-lg p-4 border border-gray-200 hover:shadow-md transition';
            div.innerHTML = `
                <div class="flex justify-between items-start mb-2">
                    <div>
                        <p class="font-semibold text-gray-900">${msg.sender_name || 'Unknown'}</p>
                        <p class="text-xs text-gray-500">
                            <span class="inline-block px-2 py-1 bg-gray-100 rounded mr-2">${msg.sender_role || 'user'}</span>
                            To: ${msg.room_id || 'unknown'}
                        </p>
                    </div>
                    <p class="text-xs text-gray-400">${new Date(msg.created_at).toLocaleString()}</p>
                </div>
                <div class="bg-gray-50 rounded p-3 text-sm text-gray-700 break-words">
                    ${escapeHtml(msg.message || '')}
                </div>
                <div class="flex justify-between items-center mt-2 text-xs text-gray-400">
                    <span>ID: ${msg._id ? msg._id.toString().substring(0, 12) : 'N/A'}</span>
                    <span>${msg.is_read ? 'âœ“ Read' : 'â—‹ Unread'}</span>
                </div>
            `;

            container.appendChild(div);
        }

        // Auto-refresh messages every 5 seconds
        function setupAutoRefresh() {
            setInterval(loadAllMessages, 5000);
        }

        // Utilities
        function updateStatus(text, color) {
            const colorClass = {
                green: 'bg-green-500',
                yellow: 'bg-yellow-500',
                red: 'bg-red-500'
            };

            document.getElementById('statusDot').className = `w-2 h-2 rounded-full ${colorClass[color]}`;
            document.getElementById('connectionStatus').querySelector('p').textContent = text;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text || '';
            return div.innerHTML;
        }

        function logout() {
            localStorage.removeItem('superadmin_user');
            window.location.href = '/propertyowner/ownerlogin.html';
        }

        // Mobile menu functionality
        function toggleMobileMenu() {
            const mobileSidebar = document.querySelector('aside');
            const mobileOverlay = document.getElementById('mobile-overlay');
            
            if (mobileSidebar.classList.contains('hidden')) {
                mobileSidebar.classList.remove('hidden');
                mobileSidebar.classList.add('fixed', 'inset-y-0', 'left-0');
                mobileOverlay.classList.remove('hidden');
            } else {
                mobileSidebar.classList.add('hidden');
                mobileSidebar.classList.remove('fixed', 'inset-y-0', 'left-0');
                mobileOverlay.classList.add('hidden');
            }
        }

        document.getElementById('mobile-menu-open').addEventListener('click', toggleMobileMenu);
    </script>
</body>
</html>
