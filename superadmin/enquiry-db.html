<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Enquiry - Approve Properties</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.4);
        }
        .modal.active {
            display: block;
        }
        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 90%;
            max-width: 600px;
            border-radius: 8px;
            max-height: 80vh;
            overflow-y: auto;
        }
        .photo-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 10px;
            margin: 10px 0;
        }
        .photo-grid img {
            width: 100%;
            height: 100px;
            object-fit: cover;
            border-radius: 4px;
            cursor: pointer;
        }
    </style>
</head>
<body class="bg-gray-50">
    <div class="container mx-auto py-8 px-4">
        <!-- Header -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
            <h1 class="text-3xl font-bold text-gray-800 mb-2">Admin Enquiry Management</h1>
            <p class="text-gray-600">Review and approve property submissions</p>
        </div>

        <!-- Filters -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <div class="flex flex-wrap gap-3">
                <button onclick="filterVisits('all')" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                    All Visits
                </button>
                <button onclick="filterVisits('submitted')" class="px-4 py-2 bg-yellow-600 text-white rounded-lg hover:bg-yellow-700">
                    Pending
                </button>
                <button onclick="filterVisits('approved')" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                    Approved
                </button>
                <button onclick="filterVisits('rejected')" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">
                    Rejected
                </button>
                <button onclick="loadVisits()" class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 ml-auto">
                    Refresh
                </button>
            </div>
        </div>

        <!-- Visits List -->
        <div id="visitsList" class="space-y-4">
            <div class="text-center py-8 text-gray-500">Loading visits...</div>
        </div>
    </div>

    <!-- Modal for details and approval -->
    <div id="detailsModal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-gray-800" id="modalTitle">Visit Details</h2>
                <button onclick="closeModal()" class="text-2xl font-bold text-gray-600 hover:text-gray-900">&times;</button>
            </div>

            <div id="detailsContent" class="space-y-4">
                <!-- Details will be populated here -->
            </div>

            <div class="mt-6 flex gap-3" id="approvalButtons">
                <!-- Approval buttons will be populated here -->
            </div>
        </div>
    </div>

    <!-- Lightbox for photos -->
    <div id="photoLightbox" class="modal" onclick="closeLightbox()">
        <div class="modal-content bg-black" style="margin-top: 10%; width: 80%; max-width: 800px;" onclick="event.stopPropagation()">
            <button onclick="closeLightbox()" class="text-white text-2xl float-right mb-4">&times;</button>
            <img id="lightboxImage" src="" alt="" style="width: 100%; border-radius: 4px;">
        </div>
    </div>

    <script>
        const API_BASE_URL = 'https://roomhy-backend-wqwo.onrender.com/api/visits';
        let allVisits = [];
        let currentFilter = 'all';
        let selectedVisit = null;

        async function loadVisits() {
            try {
                const response = await fetch(`${API_BASE_URL}/all`);
                const result = await response.json();

                if (result.success) {
                    allVisits = result.visits || [];
                    filterVisits(currentFilter);
                } else {
                    document.getElementById('visitsList').innerHTML = '<div class="text-red-600">Failed to load visits</div>';
                }
            } catch (error) {
                console.error('Error loading visits:', error);
                document.getElementById('visitsList').innerHTML = '<div class="text-red-600">Error: ' + error.message + '</div>';
            }
        }

        function filterVisits(filter) {
            currentFilter = filter;
            let filtered = allVisits;

            if (filter !== 'all') {
                filtered = allVisits.filter(v => v.status === filter);
            }

            displayVisits(filtered);
        }

        function displayVisits(visits) {
            const container = document.getElementById('visitsList');

            if (visits.length === 0) {
                container.innerHTML = '<div class="bg-white rounded-lg p-6 text-center text-gray-500">No visits found</div>';
                return;
            }

            container.innerHTML = visits.map(visit => `
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <h3 class="text-xl font-bold text-gray-800">${visit.propertyName}</h3>
                            <p class="text-gray-600">${visit.city}, ${visit.area || ''}</p>
                            <p class="text-sm text-gray-500">ID: ${visit.visitId}</p>
                        </div>
                        <span class="px-3 py-1 rounded-full text-white font-semibold ${getStatusColor(visit.status)}">
                            ${visit.status.replace('_', ' ').toUpperCase()}
                        </span>
                    </div>

                    <div class="grid grid-cols-2 gap-4 mb-4 text-sm">
                        <div>
                            <p class="font-semibold text-gray-700">Visitor</p>
                            <p>${visit.visitorName}</p>
                            <p class="text-gray-500">${visit.visitorPhone}</p>
                        </div>
                        <div>
                            <p class="font-semibold text-gray-700">Owner</p>
                            <p>${visit.ownerName}</p>
                            <p class="text-gray-500">${visit.ownerPhone}</p>
                        </div>
                        <div>
                            <p class="font-semibold text-gray-700">Property Type</p>
                            <p>${visit.propertyType}</p>
                        </div>
                        <div>
                            <p class="font-semibold text-gray-700">Monthly Rent</p>
                            <p>₹${visit.monthlyRent || 'N/A'}</p>
                        </div>
                    </div>

                    <button onclick="showDetails('${visit.visitId}')" class="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700">
                        View Details & Approve
                    </button>
                </div>
            `).join('');
        }

        function getStatusColor(status) {
            switch (status) {
                case 'submitted':
                case 'pending_review':
                    return 'bg-yellow-500';
                case 'approved':
                    return 'bg-green-500';
                case 'rejected':
                    return 'bg-red-500';
                default:
                    return 'bg-gray-500';
            }
        }

        async function showDetails(visitId) {
            const visit = allVisits.find(v => v.visitId === visitId);
            if (!visit) return;

            selectedVisit = visit;
            const modal = document.getElementById('detailsModal');
            const content = document.getElementById('detailsContent');

            content.innerHTML = `
                <div class="space-y-4">
                    <!-- Visitor Info -->
                    <div>
                        <h4 class="font-bold text-gray-800 mb-2">Visitor Information</h4>
                        <div class="bg-gray-50 p-3 rounded">
                            <p><strong>Name:</strong> ${visit.visitorName}</p>
                            <p><strong>Email:</strong> ${visit.visitorEmail}</p>
                            <p><strong>Phone:</strong> ${visit.visitorPhone}</p>
                        </div>
                    </div>

                    <!-- Property Info -->
                    <div>
                        <h4 class="font-bold text-gray-800 mb-2">Property Information</h4>
                        <div class="bg-gray-50 p-3 rounded">
                            <p><strong>Name:</strong> ${visit.propertyName}</p>
                            <p><strong>Type:</strong> ${visit.propertyType}</p>
                            <p><strong>Address:</strong> ${visit.address || 'N/A'}</p>
                            <p><strong>City:</strong> ${visit.city}</p>
                            <p><strong>Area:</strong> ${visit.area || 'N/A'}</p>
                            <p><strong>Pincode:</strong> ${visit.pincode || 'N/A'}</p>
                            <p><strong>Description:</strong> ${visit.description || 'N/A'}</p>
                            <p><strong>Monthly Rent:</strong> ₹${visit.monthlyRent || 'N/A'}</p>
                            <p><strong>Deposit:</strong> ${visit.deposit || 'N/A'}</p>
                            <p><strong>Gender Suitability:</strong> ${visit.genderSuitability || 'N/A'}</p>
                            <p><strong>Amenities:</strong> ${(visit.amenities || []).join(', ') || 'N/A'}</p>
                        </div>
                    </div>

                    <!-- Owner Info -->
                    <div>
                        <h4 class="font-bold text-gray-800 mb-2">Owner Information</h4>
                        <div class="bg-gray-50 p-3 rounded">
                            <p><strong>Name:</strong> ${visit.ownerName}</p>
                            <p><strong>Email:</strong> ${visit.ownerEmail}</p>
                            <p><strong>Phone:</strong> ${visit.ownerPhone}</p>
                            <p><strong>City:</strong> ${visit.ownerCity}</p>
                        </div>
                    </div>

                    <!-- Photos -->
                    ${visit.photos && visit.photos.length > 0 ? `
                        <div>
                            <h4 class="font-bold text-gray-800 mb-2">Regular Photos</h4>
                            <div class="photo-grid">
                                ${visit.photos.map((photo, idx) => `
                                    <img src="${photo}" alt="Photo ${idx + 1}" onclick="showLightbox('${photo}')">
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}

                    ${visit.professionalPhotos && visit.professionalPhotos.length > 0 ? `
                        <div>
                            <h4 class="font-bold text-gray-800 mb-2">Professional Photos</h4>
                            <div class="photo-grid">
                                ${visit.professionalPhotos.map((photo, idx) => `
                                    <img src="${photo}" alt="Pro Photo ${idx + 1}" onclick="showLightbox('${photo}')">
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}

                    <!-- Submitted Date -->
                    <div class="text-sm text-gray-500">
                        Submitted: ${new Date(visit.submittedAt).toLocaleString()}
                    </div>
                </div>
            `;

            // Set approval buttons based on status
            const buttonsDiv = document.getElementById('approvalButtons');
            if (visit.status === 'submitted' || visit.status === 'pending_review') {
                buttonsDiv.innerHTML = `
                    <textarea id="approvalNotes" placeholder="Approval notes..." class="w-full px-3 py-2 border border-gray-300 rounded-lg"></textarea>
                    <button onclick="approveVisit()" class="flex-1 bg-green-600 text-white py-2 rounded-lg hover:bg-green-700">
                        ✓ Approve
                    </button>
                    <button onclick="rejectVisit()" class="flex-1 bg-red-600 text-white py-2 rounded-lg hover:bg-red-700">
                        ✗ Reject
                    </button>
                `;
            } else if (visit.status === 'approved') {
                buttonsDiv.innerHTML = `
                    <p class="text-green-600 font-semibold">✓ This property has been approved</p>
                    <p class="text-sm text-gray-600">${visit.approvalNotes || 'No notes'}</p>
                    <button onclick="rejectVisit()" class="w-full bg-red-600 text-white py-2 rounded-lg hover:bg-red-700">
                        Undo Approval
                    </button>
                `;
            } else if (visit.status === 'rejected') {
                buttonsDiv.innerHTML = `
                    <p class="text-red-600 font-semibold">✗ This property has been rejected</p>
                    <p class="text-sm text-gray-600">${visit.approvalNotes || 'No notes'}</p>
                    <button onclick="approveVisit()" class="w-full bg-green-600 text-white py-2 rounded-lg hover:bg-green-700">
                        Approve Again
                    </button>
                `;
            }

            modal.classList.add('active');
        }

        async function approveVisit() {
            if (!selectedVisit) return;

            const notes = document.getElementById('approvalNotes')?.value || '';
            const admin = prompt('Enter admin name:');
            if (!admin) return;

            try {
                const response = await fetch(`${API_BASE_URL}/${selectedVisit.visitId}/approve`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        approvalNotes: notes,
                        approvedBy: admin
                    })
                });

                const result = await response.json();

                if (result.success) {
                    alert('✓ Property approved successfully! Data saved to approved properties.');
                    closeModal();
                    loadVisits();
                } else {
                    alert('✗ Error: ' + (result.message || 'Failed to approve'));
                }
            } catch (error) {
                alert('✗ Error: ' + error.message);
            }
        }

        async function rejectVisit() {
            if (!selectedVisit) return;

            const notes = prompt('Reason for rejection:');
            if (notes === null) return;

            const admin = prompt('Enter admin name:');
            if (!admin) return;

            try {
                const response = await fetch(`${API_BASE_URL}/${selectedVisit.visitId}/reject`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        approvalNotes: notes,
                        approvedBy: admin
                    })
                });

                const result = await response.json();

                if (result.success) {
                    alert('✓ Property rejected.');
                    closeModal();
                    loadVisits();
                } else {
                    alert('✗ Error: ' + (result.message || 'Failed to reject'));
                }
            } catch (error) {
                alert('✗ Error: ' + error.message);
            }
        }

        function closeModal() {
            document.getElementById('detailsModal').classList.remove('active');
            selectedVisit = null;
        }

        function showLightbox(imageSrc) {
            document.getElementById('lightboxImage').src = imageSrc;
            document.getElementById('photoLightbox').classList.add('active');
        }

        function closeLightbox() {
            document.getElementById('photoLightbox').classList.remove('active');
        }

        // Load visits on page load
        window.addEventListener('load', loadVisits);
    </script>
</body>
</html>
