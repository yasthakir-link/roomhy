<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat - Roomhy</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
        import { getFirestore, collection, doc, addDoc, onSnapshot, query, orderBy, where, getDocs, updateDoc, deleteDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDemie4RXoP2H0p4nPD7cJBo1xzy5qIRxk",
            authDomain: "chatroomhy.firebaseapp.com",
            projectId: "chatroomhy",
            storageBucket: "chatroomhy.firebasestorage.app",
            messagingSenderId: "815811304053",
            appId: "1:815811304053:web:337c1d21d63ab7dd4df63c",
            measurementId: "G-WRBZ6LVWPZ"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        window.db = db;
        window.collection = collection;
        window.doc = doc;
        window.addDoc = addDoc;
        window.onSnapshot = onSnapshot;
        window.query = query;
        window.orderBy = orderBy;
        window.where = where;
        window.getDocs = getDocs;
        window.updateDoc = updateDoc;
        window.deleteDoc = deleteDoc;
        window.serverTimestamp = serverTimestamp;
    </script>

    <style>
        body { font-family: 'Inter', sans-serif; }
        .glass-header { background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(12px); border-bottom: 1px solid rgba(0,0,0,0.05); }
        .chat-hero { background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%); }
        .custom-scrollbar::-webkit-scrollbar { width: 5px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 10px; }
        
        .message-bubble { max-width: 90%; position: relative; transition: all 0.2s; word-wrap: break-word; overflow-wrap: break-word; }
        @media (min-width: 640px) { .message-bubble { max-width: 80%; } }
        .message-bubble.sent { background: #4f46e5; color: white; border-radius: 18px 18px 4px 18px; padding: 10px 12px; font-size: 13px; line-height: 1.4; }
        .message-bubble.received { background: #f1f5f9; color: #1e293b; border-radius: 18px 18px 18px 4px; padding: 10px 12px; font-size: 13px; line-height: 1.4; }
        @media (min-width: 640px) {
            .message-bubble.sent { padding: 12px 16px; font-size: 14px; }
            .message-bubble.received { padding: 12px 16px; font-size: 14px; }
        }
        
        .message-options { opacity: 0; transition: opacity 0.2s; position: absolute; top: 50%; transform: translateY(-50%); }
        .sent .message-options { left: -60px; }
        .received .message-options { right: -60px; }
        .message-container:hover .message-options { opacity: 1; }

        .reaction-badge { position: absolute; bottom: -8px; right: 8px; background: white; border-radius: 12px; padding: 2px 6px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); border: 1px solid #f1f5f9; }
    </style>
</head>
<body class="bg-gray-50 text-slate-800 flex flex-col min-h-screen">

    <!-- Header -->
    <header class="bg-white shadow-sm sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center">
                    <a href="#" class="flex-shrink-0">
                        <img src="https://res.cloudinary.com/dpwgvcibj/image/upload/v1768990260/roomhy/website/logoroomhy.png" alt="Roomhy Logo" class="h-10 w-25">
                    </a>
                </div>

                <div class="flex items-center gap-3 sm:gap-6">
                    <nav class="hidden lg:flex items-center space-x-6">
                        <a href="about.html" class="text-gray-600 hover:text-blue-600 font-medium transition-colors">About Us</a>
                        <a href="#faq" class="text-gray-600 hover:text-blue-600 font-medium transition-colors">FAQ</a>
                        <a href="contact.html" class="text-gray-600 hover:text-blue-600 font-medium transition-colors">Contact</a>
                    </nav>

                    <a href="list.html" class="flex-shrink-0 flex items-center justify-center px-3 sm:px-4 py-2 rounded-lg text-sm font-semibold transition-colors w-10 h-10 sm:w-auto sm:h-auto sm:px-4">
                        <span class="text-3xl font-bold">+</span>
                    </a>

                    <button id="menu-toggle" class="p-2 rounded-lg hover:bg-gray-100 transition-colors">
                        <i data-lucide="menu" class="w-7 h-7 text-gray-800"></i>
                    </button>
                </div>

            </div>
        </div>
    </header>

    <div id="menu-overlay" class="fixed inset-0 bg-black/50 z-40 hidden"></div>

    <div id="mobile-menu" class="fixed top-0 right-0 w-80 h-full bg-white z-50 shadow-xl transform translate-x-full transition-transform duration-300 ease-in-out flex flex-col">
        <div class="flex justify-end p-4 flex-shrink-0">
            <button id="menu-close" class="p-2">
                <i data-lucide="x" class="w-6 h-6 text-gray-700"></i>
            </button>
        </div>

        <div class="flex justify-between items-center px-6 py-2">
            <div class="flex items-center space-x-3">
                <div class="w-12 h-12 rounded-full bg-gray-200 flex items-center justify-center">
                    <i data-lucide="users" class="w-6 h-6 text-gray-600"></i>
                </div>
                <span class="text-lg font-semibold text-gray-800">Hi,welcome</span>
            </div>
            <a href="profile.html" class="text-sm font-medium text-blue-600 hover:underline">Profile</a>
        </div>

        <div class="px-6 py-4">
            <div class="border border-blue-200 rounded-lg p-4 relative overflow-hidden">
                <p class="font-semibold text-gray-800 mb-3 relative z-10">Looking to Sell/Rent your Property?</p>
                <a href="list.html" class="block text-center w-full bg-blue-100 hover:bg-blue-200 text-blue-700 font-medium py-2 px-4 rounded-lg text-sm transition-colors relative z-10">
                    Post Property for Free
                </a>
            </div>
        </div>

        <nav class="flex-grow p-4 space-y-1 overflow-y-auto">
            <a href="ourproperty.html" class="flex items-center space-x-4 p-3 rounded-lg text-gray-700 hover:bg-blue-50 hover:text-blue-600">
                <div class="w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center flex-shrink-0">
                    <i data-lucide="home" class="w-5 h-5 text-blue-600"></i>
                </div>
                <span>Our Properties</span>
            </a>
            <a href="fav.html" class="flex items-center space-x-4 p-3 rounded-lg text-gray-700 hover:bg-blue-50 hover:text-blue-600">
                <div class="w-8 h-8 rounded-full bg-red-100 flex items-center justify-center flex-shrink-0">
                    <i data-lucide="heart" class="w-5 h-5 text-red-600"></i>
                </div>
                <span>Favorites</span>
            </a>
            <a href="mystays.html" class="flex items-center space-x-4 p-3 rounded-lg text-gray-700 hover:bg-blue-50 hover:text-blue-600">
                <div class="w-8 h-8 rounded-full bg-purple-100 flex items-center justify-center flex-shrink-0">
                    <i data-lucide="building" class="w-5 h-5 text-purple-600"></i>
                </div>
                <span>My Stays</span>
            </a>
            <a href="about.html" class="flex items-center space-x-4 p-3 rounded-lg text-gray-700 hover:bg-blue-50 hover:text-blue-600">
                <div class="w-8 h-8 rounded-full bg-yellow-100 flex items-center justify-center flex-shrink-0">
                    <i data-lucide="info" class="w-5 h-5 text-yellow-600"></i>
                </div>
                <span>About Us</span>
            </a>
            <a href="contact.html" class="flex items-center space-x-4 p-3 rounded-lg text-gray-700 hover:bg-blue-50 hover:text-blue-600">
                <div class="w-8 h-8 rounded-full bg-cyan-100 flex items-center justify-center flex-shrink-0">
                    <i data-lucide="phone" class="w-5 h-5 text-cyan-600"></i>
                </div>
                <span>Contact Us</span>
            </a>
            <a href="websitechat.html" class="flex items-center space-x-4 p-3 rounded-lg text-gray-700 hover:bg-blue-50 hover:text-blue-600">
                <div class="w-8 h-8 rounded-full bg-green-100 flex items-center justify-center flex-shrink-0">
                    <i data-lucide="message-circle" class="w-5 h-5 text-green-600"></i>
                </div>
                <span>Chat</span>
            </a>
        </nav>

        <div class="p-4 border-t flex-shrink-0">
            <a href="#" class="flex items-center space-x-4 p-3 rounded-lg text-red-600 hover:bg-red-50">
                <div class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center flex-shrink-0">
                    <i data-lucide="log-out" class="w-5 h-5 text-gray-600"></i>
                </div>
                <span>Logout</span>
            </a>
        </div>
    </div>

    <!-- Hero Section Content -->
    <section class="chat-hero pt-12 pb-24 text-white">
        <div class="max-w-7xl mx-auto px-4 text-center">
            <h1 class="text-4xl md:text-5xl font-extrabold mb-4">Messenger</h1>
            <p class="text-indigo-100 text-lg max-w-2xl mx-auto opacity-90">Chat directly with property owners, manage your stays, and get instant updates.</p>
        </div>
    </section>

    <!-- Main Chat Interface -->
    <main class="max-w-7xl mx-auto px-2 sm:px-4 -mt-16 mb-20 flex-1 w-full">
        <div class="bg-white rounded-2xl sm:rounded-3xl shadow-2xl overflow-hidden flex h-[500px] sm:h-[600px] md:h-[700px] border border-slate-100">
            <!-- Sidebar: Conversations -->
            <div class="hidden md:flex w-full md:w-80 bg-slate-50 border-r border-slate-200 flex-col" id="contacts-panel">
                <div class="p-6 border-b border-slate-200 bg-white">
                    <h3 class="font-bold text-slate-800 text-lg">My Chats</h3>
                    <div class="relative mt-2 sm:mt-4">
                        <input type="text" placeholder="Search..." class="w-full pl-8 sm:pl-10 pr-3 sm:pr-4 py-2 text-xs sm:text-sm bg-slate-100 rounded-lg sm:rounded-xl text-sm border-none focus:ring-2 focus:ring-indigo-500 outline-none">
                        <i data-lucide="search" class="w-3 sm:w-4 h-3 sm:h-4 absolute left-2.5 sm:left-3 top-2.5 text-slate-400"></i>
                    </div>
                </div>
                <div id="chat-list" class="flex-1 overflow-y-auto custom-scrollbar p-2 sm:p-3 space-y-1 sm:space-y-2">
                    <!-- Conversations loaded dynamically -->
                    <div class="animate-pulse flex flex-col gap-3 sm:gap-4 p-2 sm:p-4">
                        <div class="h-10 sm:h-12 bg-slate-200 rounded-lg sm:rounded-xl w-full"></div>
                        <div class="h-10 sm:h-12 bg-slate-200 rounded-lg sm:rounded-xl w-full"></div>
                    </div>
                </div>
            </div>

            <!-- Chat Content -->
            <div class="flex-1 flex flex-col bg-white relative" id="chat-canvas">
                <!-- Welcome Screen -->
                <div id="no-chat-selected" class="flex-1 flex flex-col items-center justify-center p-8 text-center bg-indigo-50/20">
                    <div class="w-24 h-24 bg-white rounded-full flex items-center justify-center mb-6 shadow-xl shadow-indigo-100">
                        <i data-lucide="message-circle" class="w-12 h-12 text-indigo-400"></i>
                    </div>
                    <h2 class="text-2xl font-bold text-slate-800">Your Conversations</h2>
                    <p class="text-slate-500 max-w-xs mt-2">Select an owner from the sidebar to start chatting about your booking.</p>
                </div>

                <!-- Active Chat Area -->
                <div id="chat-active" class="flex-1 flex flex-col hidden">
                    <!-- Chat Header -->
                    <div class="px-3 sm:px-6 py-3 sm:py-4 border-b border-slate-100 flex items-center justify-between">
                        <div class="flex items-center gap-2 sm:gap-4">
                            <button id="back-btn" class="md:hidden text-slate-400"><i data-lucide="arrow-left" class="w-6 h-6"></i></button>
                            <div class="w-10 sm:w-12 h-10 sm:h-12 rounded-full bg-indigo-100 flex items-center justify-center font-bold text-indigo-700 text-sm sm:text-base" id="active-chat-avatar">O</div>
                            <div class="min-w-0">
                                <h3 class="font-bold text-slate-800 text-sm sm:text-base leading-tight truncate" id="active-chat-name">Owner Name</h3>
                                <p class="text-[9px] sm:text-[10px] text-slate-400 truncate" id="active-chat-id">ID: ...</p>
                                <div class="flex items-center gap-1 mt-0.5">
                                    <span class="w-1.5 h-1.5 bg-green-500 rounded-full animate-pulse"></span>
                                    <span class="text-[8px] sm:text-[10px] text-green-600 font-bold uppercase tracking-wider">Active</span>
                                </div>
                            </div>
                        </div>
                        <div class="flex items-center gap-1 sm:gap-2">
                            <button class="p-1.5 sm:p-2 text-slate-400 hover:bg-slate-50 rounded-xl transition-colors"><i data-lucide="phone" class="w-4 sm:w-5 h-4 sm:h-5"></i></button>
                            <button class="p-1.5 sm:p-2 text-slate-400 hover:bg-slate-50 rounded-xl transition-colors"><i data-lucide="more-vertical" class="w-4 sm:w-5 h-4 sm:h-5"></i></button>
                        </div>
                    </div>

                    <!-- Messages Container -->
                    <div id="messages" class="flex-1 overflow-y-auto p-3 sm:p-6 space-y-3 sm:space-y-6 custom-scrollbar bg-[url('https://www.transparenttextures.com/patterns/cubes.png')] bg-fixed opacity-95">
                        <!-- Messages injected dynamically -->
                    </div>

                    <!-- Input Area -->
                    <div class="p-3 sm:p-6 border-t border-slate-100">
                        <div class="flex flex-col gap-2 max-w-4xl mx-auto">
                            <div class="hidden sm:flex items-center gap-1.5">
                                <button onclick="sendReaction('like')" class="flex items-center gap-0.5 px-2 sm:px-3 py-1 rounded-full bg-indigo-50 text-indigo-600 text-[9px] sm:text-[11px] font-bold border border-indigo-100 hover:bg-indigo-100 transition-all">
                                    <i data-lucide="thumbs-up" class="w-3 h-3"></i> LIKE
                                </button>
                                <button onclick="sendReaction('dislike')" class="flex items-center gap-0.5 px-2 sm:px-3 py-1 rounded-full bg-rose-50 text-rose-600 text-[9px] sm:text-[11px] font-bold border border-rose-100 hover:bg-rose-100 transition-all">
                                    <i data-lucide="thumbs-down" class="w-3 h-3"></i> DISLIKE
                                </button>
                            </div>
                            <div class="relative flex items-center">
                                <textarea id="message-text" rows="1" placeholder="Type a message..." class="w-full pl-4 sm:pl-5 pr-12 sm:pr-14 py-2 sm:py-4 bg-slate-50 border border-slate-200 rounded-2xl text-xs sm:text-sm focus:ring-2 focus:ring-indigo-500 outline-none resize-none transition-all custom-scrollbar"></textarea>
                                <button id="send-btn" class="absolute right-2 w-9 sm:w-11 h-9 sm:h-11 bg-indigo-600 text-white rounded-xl flex items-center justify-center shadow-lg shadow-indigo-200 hover:bg-indigo-700 hover:scale-105 active:scale-95 transition-all">
                                    <i data-lucide="send" class="w-4 sm:w-5 h-4 sm:h-5"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer (Matching index.html) -->
    <footer class="bg-slate-900 text-slate-300 pt-20 pb-10">
        <div class="max-w-7xl mx-auto px-4 grid grid-cols-1 md:col-4 gap-12 mb-16">
            <div class="col-span-1 md:col-span-1">
                <div class="flex items-center gap-2 mb-6">
                    <div class="bg-indigo-600 p-2 rounded-lg"><i data-lucide="home" class="w-5 h-5 text-white"></i></div>
                    <span class="text-2xl font-bold text-white">Roomhy</span>
                </div>
                <p class="text-sm leading-relaxed mb-6 opacity-70">Roomhy is India's most trusted student accommodation platform, helping students find safe and comfortable homes near top educational hubs.</p>
                <div class="flex gap-4">
                    <a href="#" class="w-10 h-10 bg-slate-800 rounded-full flex items-center justify-center hover:bg-indigo-600 hover:text-white transition-all"><i class="fa-brands fa-facebook-f"></i></a>
                    <a href="#" class="w-10 h-10 bg-slate-800 rounded-full flex items-center justify-center hover:bg-indigo-600 hover:text-white transition-all"><i class="fa-brands fa-instagram"></i></a>
                    <a href="#" class="w-10 h-10 bg-slate-800 rounded-full flex items-center justify-center hover:bg-indigo-600 hover:text-white transition-all"><i class="fa-brands fa-x-twitter"></i></a>
                </div>
            </div>
            
            <div>
                <h4 class="text-white font-bold mb-6">Quick Links</h4>
                <ul class="space-y-4 text-sm">
                    <li><a href="index.html" class="hover:text-indigo-400 transition-colors">Find a Room</a></li>
                    <li><a href="about.html" class="hover:text-indigo-400 transition-colors">Our Story</a></li>
                    <li><a href="contact.html" class="hover:text-indigo-400 transition-colors">Contact Support</a></li>
                    <li><a href="terms.html" class="hover:text-indigo-400 transition-colors">Terms and Conditions</a></li>
                    <li><a href="privacy.html" class="hover:text-indigo-400 transition-colors">Privacy Policy</a></li>
                    <li><a href="cancellation.html" class="hover:text-indigo-400 transition-colors">Cancellation Policy</a></li>
                </ul>
            </div>

            <div>
                <h4 class="text-white font-bold mb-6">Explore Cities</h4>
                <ul class="space-y-4 text-sm">
                    <li><a href="#" class="hover:text-indigo-400 transition-colors">Kota</a></li>
                    <li><a href="#" class="hover:text-indigo-400 transition-colors">Pune</a></li>
                    <li><a href="#" class="hover:text-indigo-400 transition-colors">Bangalore</a></li>
                    <li><a href="#" class="hover:text-indigo-400 transition-colors">Delhi</a></li>
                </ul>
            </div>

            <div>
                <h4 class="text-white font-bold mb-6">Contact Us</h4>
                <div class="space-y-4 text-sm">
                    <div class="flex items-start gap-3">
                        <i data-lucide="map-pin" class="w-5 h-5 text-indigo-500 shrink-0"></i>
                        <span>123 Knowledge Hub, Landmark Area, Kota, Rajasthan</span>
                    </div>
                    <div class="flex items-center gap-3">
                        <i data-lucide="phone" class="w-5 h-5 text-indigo-500 shrink-0"></i>
                        <span>+91 98765 43210</span>
                    </div>
                    <div class="flex items-center gap-3">
                        <i data-lucide="mail" class="w-5 h-5 text-indigo-500 shrink-0"></i>
                        <span>support@roomhy.com</span>
                    </div>
                </div>
            </div>
        </div>
        <div class="max-w-7xl mx-auto px-4 pt-8 border-t border-slate-800 text-center text-xs opacity-50">
            <p>&copy; 2025 Roomhy Technologies Pvt. Ltd. All Rights Reserved.</p>
        </div>
    </footer>

    <script>
        lucide.createIcons();

        // Mobile menu functionality
        const menuToggle = document.getElementById('menu-toggle');
        const menuClose = document.getElementById('menu-close');
        const mobileMenu = document.getElementById('mobile-menu');
        const menuOverlay = document.getElementById('menu-overlay');

        if (menuToggle && mobileMenu && menuClose && menuOverlay) {
            menuToggle.addEventListener('click', () => {
                mobileMenu.classList.remove('translate-x-full');
                menuOverlay.classList.remove('hidden');
            });

            const closeMenu = () => {
                mobileMenu.classList.add('translate-x-full');
                menuOverlay.classList.add('hidden');
            };

            menuClose.addEventListener('click', closeMenu);
            menuOverlay.addEventListener('click', closeMenu);

            mobileMenu.querySelectorAll('a').forEach(link => {
                link.addEventListener('click', closeMenu);
            });
        }

        let currentUser = null;
        let currentChat = null;
        let unsubscribeMessages = null;

        // Load Session User
        async function loadUser() {
            const user = JSON.parse(sessionStorage.getItem('user') || localStorage.getItem('user') || 'null');
            if (user) {
                currentUser = user;
                loadChats();
            } else {
                alert('Please login to continue');
                window.location.href = 'tenantlogin.html';
            }
        }

        // Fetch user's confirmed bookings to build chat list
        async function loadChats() {
            if (!currentUser) return;
            const loginId = currentUser.loginId;
            const userId = localStorage.getItem('user_id');
            const API_URL = (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') 
                ? 'http://localhost:5000' 
                : 'https://roomhy-backend-wqwo.onrender.com';

            try {
                // Fetch from backend API
                const response = await fetch(`${API_URL}/api/booking/requests?user_id=${loginId}`);
                const result = await response.json();
                const allBookings = result.data || [];
                
                // Filter out rejected bookings
                const bookings = allBookings.filter(b => b.status !== 'rejected');

                // Also load chats from localStorage (created by booking.html)
                const localStorageChats = [];
                try {
                    const storedChatRooms = JSON.parse(localStorage.getItem('chatRooms') || '[]');
                    localStorageChats.push(...storedChatRooms);
                    console.log('✅ Loaded', storedChatRooms.length, 'chats from localStorage');
                } catch (e) {
                    console.log('No chats in localStorage yet');
                }

                // Merge backend and localStorage chats
                const mergedChats = [...bookings, ...localStorageChats];

                const chatList = document.getElementById('chat-list');
                chatList.innerHTML = '';

                if (mergedChats.length === 0) {
                    chatList.innerHTML = '<div class="p-8 text-center text-xs text-slate-400">No active bookings found.<br/>Start by requesting a property on Our Properties page.</div>';
                    return;
                }

                // Deduplicate by owner ID
                const uniqueOwners = [];
                const seenOwners = new Set();
                mergedChats.forEach(b => {
                    const ownerId = b.owner_id || b.ownerLoginId;
                    if (ownerId && !seenOwners.has(ownerId)) {
                        seenOwners.add(ownerId);
                        // Ensure chat object has all necessary properties
                        const chat = {
                            owner_name: b.owner_name || b.ownerName || 'Property Owner',
                            owner_id: ownerId,
                            ownerLoginId: b.ownerLoginId || ownerId,
                            property_name: b.property_name || 'Roomhy Partner',
                            status: b.status || 'pending',
                            chatRoomId: b.chatRoomId || `${userId}_${ownerId}`,
                            timestamp: b.timestamp || new Date().toISOString()
                        };
                        uniqueOwners.push(chat);
                    }
                });

                uniqueOwners.forEach(chat => {
                    const item = document.createElement('div');
                    item.className = 'flex items-center gap-2 sm:gap-4 p-2 sm:p-4 rounded-lg sm:rounded-2xl cursor-pointer hover:bg-white hover:shadow-md transition-all border border-transparent hover:border-slate-100 group';
                    
                    const ownerInitial = (chat.owner_name || 'O').charAt(0).toUpperCase();
                    const colors = ['bg-indigo-100', 'bg-blue-100', 'bg-green-100', 'bg-purple-100', 'bg-pink-100'];
                    const colorIndex = ownerInitial.charCodeAt(0) % colors.length;
                    const textColors = ['text-indigo-700', 'text-blue-700', 'text-green-700', 'text-purple-700', 'text-pink-700'];
                    const hoverBg = ['group-hover:bg-indigo-600', 'group-hover:bg-blue-600', 'group-hover:bg-green-600', 'group-hover:bg-purple-600', 'group-hover:bg-pink-600'];
                    
                    item.innerHTML = `
                        <div class="w-10 sm:w-12 h-10 sm:h-12 rounded-full ${colors[colorIndex]} ${textColors[colorIndex]} flex items-center justify-center font-bold text-xs sm:text-sm ${hoverBg[colorIndex]} group-hover:text-white transition-all flex-shrink-0">
                            ${ownerInitial}
                        </div>
                        <div class="flex-1 min-w-0">
                            <h4 class="text-xs sm:text-sm font-bold text-slate-800 truncate">${chat.owner_name}</h4>
                            <p class="text-[8px] sm:text-[10px] text-slate-400 uppercase font-bold tracking-wider truncate">${chat.property_name}</p>
                            <p class="text-[7px] sm:text-[9px] text-slate-500 mt-0.5 sm:mt-1">${chat.status === 'accepted' ? '✅ Accepted' : '⏳ Pending'}</p>
                        </div>
                    `;
                    item.onclick = () => openChat(chat);
                    chatList.appendChild(item);
                });
                
                console.log('✅ Chat list loaded with', uniqueOwners.length, 'unique owners');
            } catch (err) {
                console.error("Error loading chats", err);
            }
        }

        function openChat(chat) {
            currentChat = chat;
            document.getElementById('no-chat-selected').classList.add('hidden');
            document.getElementById('chat-active').classList.remove('hidden');
            
            // Display owner information
            const ownerName = chat.owner_name || chat.ownerName || 'Property Owner';
            const ownerId = chat.owner_id || chat.ownerLoginId || '...';
            const ownerInitial = (ownerName || 'O').charAt(0).toUpperCase();
            
            document.getElementById('active-chat-name').textContent = ownerName;
            document.getElementById('active-chat-id').textContent = `Login ID: ${ownerId}`;
            document.getElementById('active-chat-avatar').textContent = ownerInitial;
            
            // Update avatar background color based on owner initial
            const avatarEl = document.getElementById('active-chat-avatar');
            const colors = ['bg-indigo-100', 'bg-blue-100', 'bg-green-100', 'bg-purple-100', 'bg-pink-100'];
            const colorIndex = ownerInitial.charCodeAt(0) % colors.length;
            avatarEl.className = `w-12 h-12 rounded-full ${colors[colorIndex]} flex items-center justify-center font-bold text-slate-700`;

            if (window.innerWidth < 768) {
                document.getElementById('contacts-panel').classList.add('hidden');
            }

            console.log('✅ Chat opened with owner:', ownerName, 'ID:', ownerId);
            loadMessages();
        }

        function loadMessages() {
            if (!currentChat || !currentUser) return;

            const userId = currentUser.loginId;
            const ownerId = currentChat.owner_id;
            const chatId = `${userId}_${ownerId}`;
            
            const messagesRef = window.collection(window.db, 'chats', chatId, 'messages');
            const q = window.query(messagesRef, window.orderBy('timestamp', 'asc'));

            if (unsubscribeMessages) unsubscribeMessages();

            unsubscribeMessages = window.onSnapshot(q, (snapshot) => {
                const messagesDiv = document.getElementById('messages');
                messagesDiv.innerHTML = '';

                snapshot.forEach((msgDoc) => {
                    const msg = msgDoc.data();
                    const isMine = msg.senderId === currentUser.loginId;
                    
                    const msgContainer = document.createElement('div');
                    msgContainer.className = `message-container flex w-full ${isMine ? 'justify-end' : 'justify-start'}`;
                    
                    const time = msg.timestamp ? new Date(msg.timestamp.toDate()).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : '...';
                    
                    // Reactions Badge
                    let reactionHtml = '';
                    if (msg.reaction) {
                        const icon = msg.reaction === 'like' ? 'thumbs-up' : 'thumbs-down';
                        const color = msg.reaction === 'like' ? 'text-green-500' : 'text-rose-500';
                        reactionHtml = `<div class="reaction-badge"><i data-lucide="${icon}" class="w-2.5 h-2.5 ${color}"></i></div>`;
                    }

                    // Handle system messages with links
                    let messageText = msg.text.replace(/\d{10,}/g, '***');
                    if (msg.isLink) {
                        // Handle schedule visit links
                        const linkMatch = messageText.match(/\[Schedule Visit\]\(([^)]+)\)/);
                        if (linkMatch) {
                            const url = linkMatch[1];
                            messageText = messageText.replace(linkMatch[0], `<a href="${url}" class="text-blue-600 underline hover:text-blue-800">Schedule Visit</a>`);
                        }
                    }

                    msgContainer.innerHTML = `
                        <div class="message-bubble shadow-sm ${isMine ? 'sent' : 'received'}">
                            <p class="text-xs sm:text-sm leading-relaxed">${messageText}</p>
                            <div class="flex items-center justify-end gap-1 sm:gap-2 mt-1 sm:mt-2">
                                <span class="text-[7px] sm:text-[9px] opacity-60">${time}</span>
                                ${msg.edited ? '<span class="text-[7px] sm:text-[9px] opacity-40">Edited</span>' : ''}
                            </div>
                            ${reactionHtml}

                            <!-- Action Icons (only for user messages) -->
                            ${msg.sender !== 'system' ? `
                            <div class="message-options flex items-center bg-white border border-slate-100 rounded-full px-2 sm:px-3 py-1 shadow-lg gap-2 sm:gap-3">
                                <button onclick="handleEdit('${msgDoc.id}', \`${msg.text.replace(/'/g, "\\'")}\`)" class="hover:text-indigo-600 text-slate-400 transition-colors" title="Edit">
                                    <i data-lucide="edit-2" class="w-3 sm:w-3.5 h-3 sm:h-3.5"></i>
                                </button>
                                <button onclick="handleDelete('${msgDoc.id}')" class="hover:text-rose-600 text-slate-400 transition-colors" title="Delete">
                                    <i data-lucide="trash-2" class="w-3 sm:w-3.5 h-3 sm:h-3.5"></i>
                                </button>
                            </div>
                            ` : ''}
                        </div>
                    `;
                    messagesDiv.appendChild(msgContainer);
                });

                messagesDiv.scrollTop = messagesDiv.scrollHeight;
                lucide.createIcons();
            });
        }

        async function sendMessage() {
            const input = document.getElementById('message-text');
            const text = input.value.trim();
            if (!text || !currentChat || !currentUser) return;

            const chatId = `${currentUser.loginId}_${currentChat.owner_id}`;
            const messagesRef = window.collection(window.db, 'chats', chatId, 'messages');

            try {
                await window.addDoc(messagesRef, {
                    text: text,
                    sender: 'user',
                    senderId: currentUser.loginId,
                    timestamp: window.serverTimestamp()
                });
                input.value = '';
                input.style.height = 'auto';

                // Send email notification to owner
                try {
                    const response = await fetch(`${API_URL}/api/notifications/chat-message`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            ownerId: currentChat.owner_id,
                            tenantName: currentUser.name || currentUser.firstName || 'Tenant',
                            message: text.substring(0, 100) + (text.length > 100 ? '...' : ''),
                            chatId: chatId
                        })
                    });
                } catch (emailError) {
                    console.error('Failed to send chat notification:', emailError);
                }
            } catch (err) { console.error("Send error", err); }
        }

        async function sendReaction(type) {
            if (!currentChat || !currentUser) return;
            const chatId = `${currentUser.loginId}_${currentChat.owner_id}`;
            const messagesRef = window.collection(window.db, 'chats', chatId, 'messages');
            
            try {
                await window.addDoc(messagesRef, {
                    text: type === 'like' ? '??' : '??',
                    sender: 'user',
                    senderId: currentUser.loginId,
                    timestamp: window.serverTimestamp(),
                    reaction: type
                });
                
                // Update chat decision
                const decision = type === 'like' ? 'like' : 'reject';
                await updateChatDecision(decision, 'user');
            } catch (err) { console.error("Reaction error", err); }
        }

        async function handleEdit(msgId, currentText) {
            const newText = prompt("Edit your message:", currentText);
            if (newText && newText.trim() !== currentText) {
                const chatId = `${currentUser.loginId}_${currentChat.owner_id}`;
                const msgRef = window.doc(window.db, 'chats', chatId, 'messages', msgId);
                try {
                    await window.updateDoc(msgRef, {
                        text: newText.trim(),
                        edited: true,
                        updatedAt: window.serverTimestamp()
                    });
                } catch (e) { alert("Cannot edit message"); }
            }
        }

        async function handleDelete(msgId) {
            if (!confirm("Delete this message?")) return;
            const chatId = `${currentUser.loginId}_${currentChat.owner_id}`;
            const msgRef = window.doc(window.db, 'chats', chatId, 'messages', msgId);
            try {
                await window.deleteDoc(msgRef);
            } catch (e) { alert("Cannot delete message"); }
        }

        async function updateChatDecision(decision, userType) {
            if (!currentChat) return;
            
            const API_URL = (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') 
                ? 'http://localhost:5000' 
                : 'https://roomhy-backend-wqwo.onrender.com';
            try {
                const response = await fetch(`${API_URL}/api/booking/requests/${currentChat._id || currentChat.id}/decision`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ decision, userType })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('Decision updated:', result);
                    
                    // If both liked, show message
                    if (result.data.owner_liked && result.data.user_liked) {
                        alert('Both parties liked! Visit scheduled and booking details sent to booking.html');
                    }
                    
                    // If rejected, show message
                    if (result.data.owner_rejected || result.data.user_rejected) {
                        alert('Booking rejected. Chat closed.');
                    }
                } else {
                    console.error('Failed to update decision');
                }
            } catch (err) {
                console.error('Error updating decision:', err);
            }
        }

        // Mobile Menu Logic
        const mobileBtn = document.getElementById('menu-toggle');
        const mobileSidebar = document.getElementById('mobile-menu');
        const mobileOverlay = document.getElementById('menu-overlay');
        const closeMobile = document.getElementById('menu-close');

        function toggleMobile() {
            if (mobileSidebar && mobileOverlay) {
                mobileSidebar.classList.toggle('translate-x-full');
                mobileOverlay.classList.toggle('hidden');
            }
        }

        if (mobileBtn) mobileBtn.onclick = toggleMobile;
        if (closeMobile) closeMobile.onclick = toggleMobile;
        if (mobileOverlay) mobileOverlay.onclick = toggleMobile;

        // UI Helpers
        document.getElementById('back-btn').onclick = () => {
            document.getElementById('contacts-panel').classList.remove('hidden');
            document.getElementById('chat-active').classList.add('hidden');
            document.getElementById('no-chat-selected').classList.remove('hidden');
        };

        document.getElementById('send-btn').onclick = sendMessage;
        document.getElementById('message-text').onkeypress = (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        };

        // Textarea height
        const tx = document.getElementById('message-text');
        tx.oninput = function() {
            this.style.height = "auto";
            this.style.height = (this.scrollHeight) + "px";
        };

        loadUser();
    </script>
</body>
</html>
