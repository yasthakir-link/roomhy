<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finalize Booking - Athena House (Modern)</title>
    <script>
        const API_URL = (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1')
            ? 'http://localhost:5000'
            : 'https://roomhy-backend-wqwo.onrender.com';
    </script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
            color: #1F2937;
        }
        .main-card {
            background: #FFFFFF;
            border-radius: 1rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.08), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            transition: all 0.3s ease;
        }
        .step-header {
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .agreement-box-scroll {
            max-height: 350px;
            overflow-y: auto;
            border: 1px solid #e2e8f0;
            border-radius: 0.5rem;
            background-color: #ffffff;
        }
        .stepper-line {
            height: 100%;
            width: 2px;
            background-color: #cbd5e1;
            position: absolute;
            left: 17px;
            top: 24px;
            z-index: 0;
        }
    </style>
</head>
<body class="antialiased">

    <main class="max-w-6xl mx-auto py-12 px-4 sm:px-6 lg:px-8">
        
        <!-- Booking Header -->
        <div class="mb-10 text-center">
            <h1 class="text-4xl font-extrabold text-gray-900 mb-2">
                <span class="text-indigo-600">Finalize Booking</span> for Athena House
            </h1>
            <p class="text-xl font-medium text-gray-500">
                Agreed Rent: <span class="text-indigo-600 font-bold">?8,500/mo</span>. Complete the 4 steps below.
            </p>
            <!-- Display User ID -->
            <div id="userIdDisplay" class="mt-4 inline-block bg-blue-100 text-blue-800 px-4 py-2 rounded-lg font-semibold">
                User ID: <span id="currentUserId">Loading...</span>
            </div>
        </div>

        <div class="lg:grid lg:grid-cols-12 lg:gap-10">

            <!-- Sidebar: Stepper and Summary -->
            <aside class="lg:col-span-4 mb-8 lg:mb-0">
                <div class="sticky top-4 main-card p-6 border-t-4 border-indigo-500">
                    
                    <h3 class="text-2xl font-bold text-gray-800 mb-6">Booking Progress</h3>

                    <!-- Vertical Stepper -->
                    <div class="relative pl-8">
                        <div class="stepper-line"></div>
                        
                        <div id="step-pill-1" data-step="1" class="mb-8 relative flex items-start">
                            <div class="w-9 h-9 flex items-center justify-center rounded-full bg-indigo-600 text-white font-bold text-lg shrink-0 z-10 shadow-lg">1</div>
                            <div class="ml-4 pt-1">
                                <p class="font-semibold text-gray-900">Verify Your Email</p>
                                <p class="text-sm text-gray-500">Check your registration.</p>
                            </div>
                        </div>

                        <div id="step-pill-2" data-step="2" class="mb-8 relative flex items-start opacity-50">
                            <div class="w-9 h-9 flex items-center justify-center rounded-full bg-gray-300 text-gray-600 font-bold text-lg shrink-0 z-10">2</div>
                            <div class="ml-4 pt-1">
                                <p class="font-semibold text-gray-900">Review Rules & Safety</p>
                                <p class="text-sm text-gray-500">Confirm all guidelines.</p>
                            </div>
                        </div>

                        <div id="step-pill-3" data-step="3" class="mb-8 relative flex items-start opacity-50">
                            <div class="w-9 h-9 flex items-center justify-center rounded-full bg-gray-300 text-gray-600 font-bold text-lg shrink-0 z-10">3</div>
                            <div class="ml-4 pt-1">
                                <p class="font-semibold text-gray-900">Accept Rental Agreement</p>
                                <p class="text-sm text-gray-500">Legal confirmation.</p>
                            </div>
                        </div>
                        
                        <div id="step-pill-4" data-step="4" class="relative flex items-start opacity-50">
                            <div class="w-9 h-9 flex items-center justify-center rounded-full bg-gray-300 text-gray-600 font-bold text-lg shrink-0 z-10">4</div>
                            <div class="ml-4 pt-1">
                                <p class="font-semibold text-gray-900">Initial Payment</p>
                                <p class="text-sm text-gray-500">Secure your room.</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Fixed Summary -->
                    <div class="mt-8 pt-6 border-t border-gray-100">
                        <h4 class="text-lg font-bold text-gray-800 mb-3">Total Payable Now:</h4>
                        <div class="flex justify-between items-center text-xl font-extrabold text-indigo-600">
                            <span>Security Deposit + Rent</span>
                            <span class="text-3xl">?25,500</span>
                        </div>
                    </div>
                </div>
            </aside>

            <!-- Main Content: Steps -->
            <div class="lg:col-span-8 space-y-8">
                
                <!-- STEP 1: Email Verification -->
                <div id="step-1" class="booking-step main-card p-8">
                    <div class="step-header flex items-center space-x-4 mb-6" onclick="scrollToStep(1)">
                        <div class="w-8 h-8 flex items-center justify-center rounded-full bg-indigo-100 text-indigo-600 font-bold text-lg">1</div>
                        <h2 class="text-2xl font-bold text-gray-900">Verify Your Email</h2>
                    </div>
                    
                    <p class="text-gray-700 mb-6">Please enter your email to verify you're registered with us.</p>
                    
                    <div class="space-y-4 mb-6">
                        <div>
                            <label for="emailInput" class="block text-sm font-semibold text-gray-800 mb-2">Email Address</label>
                            <input type="email" id="emailInput" placeholder="your.email@example.com" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        </div>
                        <div id="emailError" class="hidden p-3 bg-red-100 text-red-800 rounded-lg text-sm font-medium"></div>
                        <div id="emailSuccess" class="hidden p-3 bg-green-100 text-green-800 rounded-lg text-sm font-medium">‚úÖ Email verified!</div>
                    </div>

                    <button id="verifyEmailBtn" class="w-full bg-indigo-600 text-white px-6 py-3 rounded-lg hover:bg-indigo-700 transition duration-150 font-semibold flex items-center justify-center space-x-2">
                        <span>Verify Email</span>
                        <i data-lucide="check" class="w-4 h-4"></i>
                    </button>
                </div>

                <!-- STEP 2: Rules & Regulations -->
                <div id="step-2" class="booking-step main-card p-8 hidden">
                    <div class="step-header flex items-center space-x-4 mb-6" onclick="scrollToStep(2)">
                        <div class="w-8 h-8 flex items-center justify-center rounded-full bg-indigo-100 text-indigo-600 font-bold text-lg">2</div>
                        <h2 class="text-2xl font-bold text-gray-900">Rules & Safety Guidelines</h2>
                    </div>
                    
                    <p class="text-gray-700 mb-6">These are the non-negotiable guidelines for living at Athena House.</p>
                    
                    <ul class="space-y-4 text-sm text-gray-700">
                        <li class="flex items-start space-x-3 p-3 bg-red-50 rounded-lg">
                            <i data-lucide="volume-2" class="w-5 h-5 text-red-600 shrink-0 mt-1"></i>
                            <div>
                                <strong class="font-semibold text-red-600">Quiet Hours:</strong> Strictly 11:00 PM to 7:00 AM.
                            </div>
                        </li>
                        <li class="flex items-start space-x-3 p-3 bg-red-50 rounded-lg">
                            <i data-lucide="smoking" class="w-5 h-5 text-red-600 shrink-0 mt-1"></i>
                            <div>
                                <strong class="font-semibold text-red-600">Prohibitions:</strong> No smoking, alcohol, or pets allowed on the property.
                            </div>
                        </li>
                        <li class="flex items-start space-x-3 p-3 bg-green-50 rounded-lg">
                            <i data-lucide="shield-check" class="w-5 h-5 text-green-600 shrink-0 mt-1"></i>
                            <div>
                                <strong class="font-semibold text-green-600">Rent Payment:</strong> Due before the 5th of every month. Late fees apply thereafter.
                            </div>
                        </li>
                    </ul>

                    <button data-next-step="3" class="next-step-button mt-8 bg-indigo-600 text-white px-6 py-3 rounded-lg hover:bg-indigo-700 transition duration-150 font-semibold flex items-center justify-center space-x-2">
                        <span>Acknowledge & Continue to Agreement</span>
                        <i data-lucide="arrow-right" class="w-4 h-4"></i>
                    </button>
                </div>

                <!-- STEP 3: Booking Agreement -->
                <div id="step-3" class="booking-step main-card p-8 hidden">
                    <div class="step-header flex items-center space-x-4 mb-6" onclick="scrollToStep(3)">
                        <div class="w-8 h-8 flex items-center justify-center rounded-full bg-indigo-100 text-indigo-600 font-bold text-lg">3</div>
                        <h2 class="text-2xl font-bold text-gray-900">Digital Rental Agreement</h2>
                    </div>
                    
                    <p class="text-gray-600 mb-4">Please read the full contract details below before accepting the terms.</p>

                    <div class="agreement-box-scroll mb-6 text-xs text-gray-700 leading-relaxed p-4">
                        <h3 class="font-bold text-base mb-2 text-center text-gray-900">ROOMHY RENTAL AGREEMENT - ATHENA HOUSE</h3>
                        <p class="mb-4">This legally binding agreement is effective from <span id="current-date-v2"></span> between the Owner (Mr. Vijay Kumar) and the Tenant (Ayush Singh).</p>
                        
                        <h4 class="font-semibold text-sm mb-1 text-indigo-600">1. Financials</h4>
                        <p>Monthly Rent: ‚Çπ8,500. Security Deposit: ‚Çπ17,000 (2 Months' Rent). The initial payment includes both the deposit and the first month's rent, totaling ‚Çπ25,500.</p>
                        
                        <h4 class="font-semibold text-sm mt-4 mb-1 text-indigo-600">2. Lease Term</h4>
                        <p>The standard lease is for 11 months, automatically converting to month-to-month thereafter unless a new agreement is signed. Notice for early termination must be 30 days written notice.</p>
                        
                        <h4 class="font-semibold text-sm mt-4 mb-1 text-indigo-600">3. Deposit Conditions</h4>
                        <p>The security deposit will be refunded within 15 days of move-out, contingent upon the room being returned in good condition, minus any costs for professional cleaning or damage repair.</p>
                        
                        <p class="mt-4 font-semibold text-center text-red-600 border-t pt-2 border-red-200">Digital acceptance constitutes a binding contract.</p>
                    </div>

                    <div class="flex items-start space-x-3 mb-6 p-4 bg-yellow-50 rounded-xl border border-yellow-300">
                        <input type="checkbox" id="accept-agreement-v2" class="mt-1 w-5 h-5 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                        <label for="accept-agreement-v2" class="text-sm font-medium text-gray-800">
                            I confirm I have read and agree to all terms and conditions of this Booking Agreement.
                        </label>
                    </div>

                    <button data-next-step="4" id="agreement-next-button-v2" disabled class="next-step-button mt-2 w-full sm:w-auto bg-gray-400 text-white px-6 py-3 rounded-lg opacity-80 cursor-not-allowed transition duration-150 font-semibold flex items-center justify-center space-x-2">
                        <span>Proceed to Secure Payment</span>
                        <i data-lucide="lock" class="w-4 h-4"></i>
                    </button>
                </div>

                <!-- STEP 4: Payment Gateway -->
                <div id="step-4" class="booking-step main-card p-8 hidden">
                    <div class="step-header flex items-center space-x-4 mb-6" onclick="scrollToStep(4)">
                        <div class="w-8 h-8 flex items-center justify-center rounded-full bg-indigo-100 text-indigo-600 font-bold text-lg">4</div>
                        <h2 class="text-2xl font-bold text-gray-900">Secure Initial Payment</h2>
                    </div>
                    
                    <p class="text-gray-600 mb-6">Complete the payment of <strong>‚Çπ25,500</strong> to confirm your booking instantly.</p>
                    
                    <!-- Payment Breakdown -->
                    <div class="space-y-3 p-4 bg-indigo-50 rounded-lg border border-indigo-200 mb-8">
                        <div class="flex justify-between items-center text-base">
                            <span class="text-gray-700">Security Deposit (2x Rent)</span>
                            <span class="font-semibold text-gray-800">‚Çπ17,000</span>
                        </div>
                        <div class="flex justify-between items-center text-base">
                            <span class="text-gray-700">First Month's Rent</span>
                            <span class="font-semibold text-gray-800">‚Çπ8,500</span>
                        </div>
                        <div class="border-t border-indigo-300 pt-3 flex justify-between items-center text-2xl font-extrabold text-indigo-600">
                            <span>TOTAL DUE NOW</span>
                            <span>‚Çπ25,500</span>
                        </div>
                    </div>
                    
                    <!-- Payment Options -->
                    <div class="space-y-4">
                        <h3 class="font-semibold text-lg text-gray-800">Choose Your Method:</h3>
                        <label class="flex items-center space-x-3 p-5 border border-indigo-400 bg-indigo-50 rounded-xl cursor-pointer shadow-md">
                            <input type="radio" name="payment_method" value="upi" checked class="w-5 h-5 text-indigo-600 border-indigo-300 focus:ring-indigo-500">
                            <div class="flex-1">
                                <span class="font-bold text-gray-800">UPI (Preferred)</span>
                                <p class="text-sm text-gray-600">Instant transfer via Google Pay, PhonePe, or BHIM.</p>
                            </div>
                            <i data-lucide="scan" class="w-6 h-6 text-indigo-600"></i>
                        </label>
                        <label class="flex items-center space-x-3 p-5 border border-gray-300 bg-white rounded-xl cursor-pointer">
                            <input type="radio" name="payment_method" value="card" class="w-5 h-5 text-indigo-600 border-gray-300 focus:ring-indigo-500">
                            <div class="flex-1">
                                <span class="font-bold text-gray-800">Credit / Debit Card</span>
                                <p class="text-sm text-gray-600">Secure payment via Visa/MasterCard.</p>
                            </div>
                            <i data-lucide="credit-card" class="w-6 h-6 text-gray-500"></i>
                        </label>
                    </div>

                    <button id="pay-now-button-v2" class="mt-8 w-full bg-green-600 text-white px-6 py-4 rounded-xl hover:bg-green-700 transition duration-150 font-bold text-xl shadow-lg flex items-center justify-center space-x-3">
                        <i data-lucide="check-circle" class="w-6 h-6"></i>
                        <span>PAY ‚Çπ25,500 NOW</span>
                    </button>
                    
                    <p id="payment-status-v2" class="hidden mt-4 text-center p-3 text-base bg-green-100 text-green-700 font-semibold border border-green-300 rounded-lg">
                        ‚úì Booking confirmed! Chat room created. Check your email.
                    </p>
                </div>
            </div>

        </div>
    </main>

    <script>
        lucide.createIcons();

        // Initialize date
        const dateElement = document.getElementById('current-date-v2');
        if (dateElement) {
            dateElement.textContent = new Date().toLocaleDateString('en-IN', { year: 'numeric', month: 'long', day: 'numeric' });
        }

        // Display Current User ID
        function displayCurrentUserId() {
            const user = localStorage.getItem('user');
            const userId = user ? JSON.parse(user).userId || 'Not Available' : 'Not Available';
            document.getElementById('currentUserId').textContent = userId;
            return userId;
        }

        // Verify Email against new_signups.html database
        async function verifyEmail(email) {
            try {
                const response = await fetch(`${API_URL}/api/kyc`, {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' }
                });

                if (!response.ok) {
                    console.error('Error fetching signups:', response.status);
                    return false;
                }

                const data = await response.json();
                const signups = Array.isArray(data) ? data : data.data || [];
                
                // Check if email exists in signups
                const exists = signups.some(signup => 
                    signup.email.toLowerCase() === email.toLowerCase()
                );
                
                return exists;
            } catch (error) {
                console.error('Email verification error:', error);
                return false;
            }
        }

        // Create Chat Room
        async function createChatRoom(userId, ownerLoginId, propertyId, ownerName = 'Property Owner', propertyName = 'Roomhy Property') {
            try {
                const chatRoomId = `${userId}_${ownerLoginId}_${Date.now()}`;
                const chatData = {
                    chatRoomId: chatRoomId,
                    userId: userId,
                    ownerLoginId: ownerLoginId,
                    owner_id: ownerLoginId,  // For compatibility with websitechat.html
                    owner_name: ownerName,   // For display in chat list
                    property_id: propertyId,
                    property_name: propertyName,
                    createdAt: new Date().toISOString(),
                    timestamp: new Date().toISOString(),
                    status: 'active'
                };

                // Save to localStorage (can be extended to backend)
                let chatRooms = JSON.parse(localStorage.getItem('chatRooms') || '[]');
                chatRooms.push(chatData);
                localStorage.setItem('chatRooms', JSON.stringify(chatRooms));

                console.log('‚úÖ Chat room created:', {
                    id: chatRoomId,
                    owner: ownerName,
                    property: propertyName
                });
                return chatRoomId;
            } catch (error) {
                console.error('Error creating chat room:', error);
                return null;
            }
        }

        // Send Booking Confirmation Email
        async function sendBookingConfirmationEmail(email, userId, ownerName, ownerLoginId) {
            try {
                const response = await fetch(`${API_URL}/api/email/send`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        to: email,
                        subject: 'üéâ Booking Confirmation - Roomhy',
                        html: `
                            <div style="font-family: Arial, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; border-radius: 10px; color: white;">
                                <h2>‚úì Booking Confirmed!</h2>
                                <p>Dear Tenant,</p>
                                <p>Your booking has been successfully confirmed for Athena House.</p>
                                <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 8px; margin: 20px 0;">
                                    <p><strong>Your User ID:</strong> ${userId}</p>
                                    <p><strong>Owner Name:</strong> ${ownerName}</p>
                                    <p><strong>Owner Login ID:</strong> ${ownerLoginId}</p>
                                </div>
                                <p>A chat room has been created between you and the property owner. You can now communicate directly.</p>
                                <p><a href="https://tranquil-concha-5eec89.netlify.app/website/websitechat.html" style="background: white; color: #667eea; padding: 10px 20px; border-radius: 5px; text-decoration: none; font-weight: bold;">Open Chat Room</a></p>
                                <p>Thank you for choosing Roomhy!</p>
                            </div>
                        `,
                        text: `Booking confirmed! Chat room created between you (${userId}) and owner ${ownerName} (${ownerLoginId}).`
                    })
                });

                if (response.ok) {
                    console.log('‚úÖ Booking confirmation email sent');
                    return true;
                } else {
                    console.error('Error sending email:', response.status);
                    return false;
                }
            } catch (error) {
                console.error('Email sending error:', error);
                return false;
            }
        }

        const steps = document.querySelectorAll('.booking-step');
        const nextStepButtons = document.querySelectorAll('.next-step-button');
        const acceptAgreementCheckbox = document.getElementById('accept-agreement-v2');
        const agreementNextButton = document.getElementById('agreement-next-button-v2');
        const payNowButton = document.getElementById('pay-now-button-v2');
        const paymentStatus = document.getElementById('payment-status-v2');
        const verifyEmailBtn = document.getElementById('verifyEmailBtn');
        const emailInput = document.getElementById('emailInput');
        const emailError = document.getElementById('emailError');
        const emailSuccess = document.getElementById('emailSuccess');
        
        const stepPills = {
            1: document.getElementById('step-pill-1'),
            2: document.getElementById('step-pill-2'),
            3: document.getElementById('step-pill-3'),
            4: document.getElementById('step-pill-4')
        };

        let currentStep = 1;
        let verifiedEmail = null;

        function showStep(stepNumber) {
            currentStep = stepNumber;
            
            steps.forEach(step => step.classList.add('hidden'));
            
            const targetStepElement = document.getElementById(`step-${stepNumber}`);
            if (targetStepElement) {
                targetStepElement.classList.remove('hidden');
            }

            for (let i = 1; i <= 4; i++) {
                const pill = stepPills[i];
                const icon = pill.querySelector('div:first-child');
                
                pill.classList.remove('opacity-50');
                
                if (i === stepNumber) {
                    icon.classList.remove('bg-gray-300', 'text-gray-600');
                    icon.classList.add('bg-indigo-600', 'text-white', 'shadow-lg');
                } else if (i < stepNumber) {
                    icon.classList.remove('bg-indigo-600', 'text-white', 'shadow-lg');
                    icon.classList.add('bg-green-500', 'text-white');
                } else {
                    icon.classList.remove('bg-indigo-600', 'text-white', 'shadow-lg', 'bg-green-500');
                    icon.classList.add('bg-gray-300', 'text-gray-600');
                    pill.classList.add('opacity-50');
                }
            }

            scrollToStep(stepNumber);
        }
        
        function scrollToStep(stepNumber) {
             const targetElement = document.getElementById(`step-${stepNumber}`);
             if (targetElement) {
                 window.scrollTo({
                     top: targetElement.offsetTop - 30,
                     behavior: 'smooth'
                 });
             }
        }

        // Email Verification Logic
        if (verifyEmailBtn) {
            verifyEmailBtn.addEventListener('click', async () => {
                const email = emailInput.value.trim();
                
                if (!email) {
                    emailError.textContent = '‚ùå Please enter an email address';
                    emailError.classList.remove('hidden');
                    emailSuccess.classList.add('hidden');
                    return;
                }

                verifyEmailBtn.disabled = true;
                verifyEmailBtn.innerHTML = '<i data-lucide="loader" class="w-4 h-4 animate-spin"></i><span>Verifying...</span>';
                lucide.createIcons();

                const isValid = await verifyEmail(email);

                if (isValid) {
                    verifiedEmail = email;
                    emailError.classList.add('hidden');
                    emailSuccess.classList.remove('hidden');
                    verifyEmailBtn.textContent = '‚úì Email Verified';
                    verifyEmailBtn.classList.add('bg-green-600', 'hover:bg-green-700');
                    verifyEmailBtn.classList.remove('bg-indigo-600', 'hover:bg-indigo-700');
                    
                    setTimeout(() => showStep(2), 1500);
                } else {
                    emailSuccess.classList.add('hidden');
                    emailError.textContent = '‚ùå Email not found. Please sign up first.';
                    emailError.classList.remove('hidden');
                    
                    setTimeout(() => {
                        const redirectConfirm = confirm('Email not registered. Would you like to sign up?');
                        if (redirectConfirm) {
                            window.location.href = 'signup.html';
                        }
                    }, 2000);
                    
                    verifyEmailBtn.disabled = false;
                    verifyEmailBtn.innerHTML = '<span>Verify Email</span><i data-lucide="check" class="w-4 h-4"></i>';
                    lucide.createIcons();
                }
            });
        }

        nextStepButtons.forEach(button => {
            button.addEventListener('click', () => {
                const nextStep = parseInt(button.getAttribute('data-next-step'));
                showStep(nextStep);
            });
        });

        if (acceptAgreementCheckbox && agreementNextButton) {
            acceptAgreementCheckbox.addEventListener('change', () => {
                if (acceptAgreementCheckbox.checked) {
                    agreementNextButton.disabled = false;
                    agreementNextButton.classList.remove('bg-gray-400', 'cursor-not-allowed');
                    agreementNextButton.classList.add('bg-green-600', 'hover:bg-green-700');
                    agreementNextButton.querySelector('i').setAttribute('data-lucide', 'credit-card');
                    lucide.createIcons();
                } else {
                    agreementNextButton.disabled = true;
                    agreementNextButton.classList.add('bg-gray-400', 'cursor-not-allowed');
                    agreementNextButton.classList.remove('bg-green-600', 'hover:bg-green-700');
                    agreementNextButton.querySelector('i').setAttribute('data-lucide', 'lock');
                    lucide.createIcons();
                }
            });
        }
        
        if (payNowButton) {
            payNowButton.addEventListener('click', async () => {
                payNowButton.disabled = true;
                payNowButton.innerHTML = `<i data-lucide="loader" class="w-6 h-6 animate-spin"></i><span>Processing Payment...</span>`;
                payNowButton.classList.remove('bg-green-600', 'hover:bg-green-700');
                payNowButton.classList.add('bg-gray-500', 'cursor-wait');
                lucide.createIcons();

                setTimeout(async () => {
                    // Get user data
                    const user = localStorage.getItem('user');
                    const userId = user ? JSON.parse(user).userId : 'USER123';
                    const ownerLoginId = 'ROOMHY1234'; // From approval process
                    const ownerName = 'Mr. Vijay Kumar';
                    const propertyId = 'prop_athena_001';
                    const propertyName = 'Athena House';

                    // Create chat room with owner and property info for websitechat.html
                    const chatRoomId = await createChatRoom(userId, ownerLoginId, propertyId, ownerName, propertyName);

                    // Send confirmation email
                    if (verifiedEmail) {
                        await sendBookingConfirmationEmail(verifiedEmail, userId, ownerName, ownerLoginId);
                    }

                    payNowButton.classList.add('hidden');
                    paymentStatus.classList.remove('hidden');
                    console.log('‚úÖ Booking complete! Chat room:', chatRoomId);
                }, 3000);
            });
        }

        window.onload = () => {
            displayCurrentUserId();
            showStep(1);
        };
    </script>
</body>
</html>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb; /* Very light, subtle background */
            color: #1F2937;
        }
        .main-card {
            background: #FFFFFF;
            border-radius: 1rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.08), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            transition: all 0.3s ease;
        }
        .step-header {
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .agreement-box-scroll {
            max-height: 350px;
            overflow-y: auto;
            border: 1px solid #e2e8f0;
            border-radius: 0.5rem;
            background-color: #ffffff;
        }
        /* Custom Stepper style */
        .stepper-line {
            height: 100%;
            width: 2px;
            background-color: #cbd5e1;
            position: absolute;
            left: 17px;
            top: 24px;
            z-index: 0;
        }
    </style>
</head>
<body class="antialiased">

    <main class="max-w-6xl mx-auto py-12 px-4 sm:px-6 lg:px-8">
        
        <!-- Booking Header -->
        <div class="mb-10 text-center">
            <h1 class="text-4xl font-extrabold text-gray-900 mb-2">
                <span class="text-indigo-600">Finalize Booking</span> for Athena House
            </h1>
            <p class="text-xl font-medium text-gray-500">
                Agreed Rent: <span class="text-indigo-600 font-bold">?8,500/mo</span>. Complete the 3 steps below.
            </p>
        </div>

        <div class="lg:grid lg:grid-cols-12 lg:gap-10">

            <!-- Sidebar: Stepper and Summary -->
            <aside class="lg:col-span-4 mb-8 lg:mb-0">
                <div class="sticky top-4 main-card p-6 border-t-4 border-indigo-500">
                    
                    <h3 class="text-2xl font-bold text-gray-800 mb-6">Booking Progress</h3>

                    <!-- Vertical Stepper -->
                    <div class="relative pl-8">
                        <div class="stepper-line"></div>
                        
                        <div id="step-pill-1" data-step="1" class="mb-8 relative flex items-start">
                            <div class="w-9 h-9 flex items-center justify-center rounded-full bg-indigo-600 text-white font-bold text-lg shrink-0 z-10 shadow-lg">1</div>
                            <div class="ml-4 pt-1">
                                <p class="font-semibold text-gray-900">Review Rules & Safety</p>
                                <p class="text-sm text-gray-500">Confirm all guidelines.</p>
                            </div>
                        </div>

                        <div id="step-pill-2" data-step="2" class="mb-8 relative flex items-start opacity-50">
                            <div class="w-9 h-9 flex items-center justify-center rounded-full bg-gray-300 text-gray-600 font-bold text-lg shrink-0 z-10">2</div>
                            <div class="ml-4 pt-1">
                                <p class="font-semibold text-gray-900">Accept Rental Agreement</p>
                                <p class="text-sm text-gray-500">Legal confirmation.</p>
                            </div>
                        </div>
                        
                        <div id="step-pill-3" data-step="3" class="relative flex items-start opacity-50">
                            <div class="w-9 h-9 flex items-center justify-center rounded-full bg-gray-300 text-gray-600 font-bold text-lg shrink-0 z-10">3</div>
                            <div class="ml-4 pt-1">
                                <p class="font-semibold text-gray-900">Initial Payment</p>
                                <p class="text-sm text-gray-500">Secure your room.</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Fixed Summary -->
                    <div class="mt-8 pt-6 border-t border-gray-100">
                        <h4 class="text-lg font-bold text-gray-800 mb-3">Total Payable Now:</h4>
                        <div class="flex justify-between items-center text-xl font-extrabold text-indigo-600">
                            <span>Security Deposit + Rent</span>
                            <span class="text-3xl">?25,500</span>
                        </div>
                    </div>
                </div>
            </aside>

            <!-- Main Content: Steps -->
            <div class="lg:col-span-8 space-y-8">
                
                <!-- STEP 1: Rules & Regulations -->
                <div id="step-1" class="booking-step main-card p-8">
                    <div class="step-header flex items-center space-x-4 mb-6" onclick="scrollToStep(1)">
                        <div class="w-8 h-8 flex items-center justify-center rounded-full bg-indigo-100 text-indigo-600 font-bold text-lg">1</div>
                        <h2 class="text-2xl font-bold text-gray-900">Rules & Safety Guidelines</h2>
                    </div>
                    
                    <p class="text-gray-700 mb-6">These are the non-negotiable guidelines for living at Athena House.</p>
                    
                    <ul class="space-y-4 text-sm text-gray-700">
                        <li class="flex items-start space-x-3 p-3 bg-red-50 rounded-lg">
                            <i data-lucide="volume-2" class="w-5 h-5 text-red-600 shrink-0 mt-1"></i>
                            <div>
                                <strong class="font-semibold text-red-600">Quiet Hours:</strong> Strictly 11:00 PM to 7:00 AM.
                            </div>
                        </li>
                        <li class="flex items-start space-x-3 p-3 bg-red-50 rounded-lg">
                            <i data-lucide="smoking" class="w-5 h-5 text-red-600 shrink-0 mt-1"></i>
                            <div>
                                <strong class="font-semibold text-red-600">Prohibitions:</strong> No smoking, alcohol, or pets allowed on the property.
                            </div>
                        </li>
                        <li class="flex items-start space-x-3 p-3 bg-green-50 rounded-lg">
                            <i data-lucide="shield-check" class="w-5 h-5 text-green-600 shrink-0 mt-1"></i>
                            <div>
                                <strong class="font-semibold text-green-600">Rent Payment:</strong> Due before the 5th of every month. Late fees apply thereafter.
                            </div>
                        </li>
                    </ul>

                    <button data-next-step="2" class="next-step-button mt-8 bg-indigo-600 text-white px-6 py-3 rounded-lg hover:bg-indigo-700 transition duration-150 font-semibold flex items-center justify-center space-x-2">
                        <span>Acknowledge & Continue to Agreement</span>
                        <i data-lucide="arrow-right" class="w-4 h-4"></i>
                    </button>
                </div>

                <!-- STEP 2: Booking Agreement -->
                <div id="step-2" class="booking-step main-card p-8 hidden">
                    <div class="step-header flex items-center space-x-4 mb-6" onclick="scrollToStep(2)">
                        <div class="w-8 h-8 flex items-center justify-center rounded-full bg-indigo-100 text-indigo-600 font-bold text-lg">2</div>
                        <h2 class="text-2xl font-bold text-gray-900">Digital Rental Agreement</h2>
                    </div>
                    
                    <p class="text-gray-600 mb-4">Please read the full contract details below before accepting the terms.</p>

                    <div class="agreement-box-scroll mb-6 text-xs text-gray-700 leading-relaxed p-4">
                        <h3 class="font-bold text-base mb-2 text-center text-gray-900">ROOMHY RENTAL AGREEMENT - ATHENA HOUSE</h3>
                        <p class="mb-4">This legally binding agreement is effective from <span id="current-date-v2"></span> between the Owner (Mr. Vijay Kumar) and the Tenant (Ayush Singh).</p>
                        
                        <h4 class="font-semibold text-sm mb-1 text-indigo-600">1. Financials</h4>
                        <p>Monthly Rent: $\mathbf{?8,500}$. Security Deposit: $\mathbf{?17,000}$ (2 Months' Rent). The initial payment includes both the deposit and the first month's rent, totaling ?25,500.</p>
                        
                        <h4 class="font-semibold text-sm mt-4 mb-1 text-indigo-600">2. Lease Term</h4>
                        <p>The standard lease is for 11 months, automatically converting to month-to-month thereafter unless a new agreement is signed. Notice for early termination must be 30 days written notice.</p>
                        
                        <h4 class="font-semibold text-sm mt-4 mb-1 text-indigo-600">3. Deposit Conditions</h4>
                        <p>The security deposit will be refunded within 15 days of move-out, contingent upon the room being returned in good condition, minus any costs for professional cleaning or damage repair.</p>
                        
                        <p class="mt-4 font-semibold text-center text-red-600 border-t pt-2 border-red-200">Digital acceptance constitutes a binding contract.</p>
                    </div>

                    <div class="flex items-start space-x-3 mb-6 p-4 bg-yellow-50 rounded-xl border border-yellow-300">
                        <input type="checkbox" id="accept-agreement-v2" class="mt-1 w-5 h-5 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                        <label for="accept-agreement-v2" class="text-sm font-medium text-gray-800">
                            I confirm I have read and agree to all terms and conditions of this Booking Agreement.
                        </label>
                    </div>

                    <button data-next-step="3" id="agreement-next-button-v2" disabled class="next-step-button mt-2 w-full sm:w-auto bg-gray-400 text-white px-6 py-3 rounded-lg opacity-80 cursor-not-allowed transition duration-150 font-semibold flex items-center justify-center space-x-2">
                        <span>Proceed to Secure Payment</span>
                        <i data-lucide="lock" class="w-4 h-4"></i>
                    </button>
                </div>

                <!-- STEP 3: Payment Gateway -->
                <div id="step-3" class="booking-step main-card p-8 hidden">
                    <div class="step-header flex items-center space-x-4 mb-6" onclick="scrollToStep(3)">
                        <div class="w-8 h-8 flex items-center justify-center rounded-full bg-indigo-100 text-indigo-600 font-bold text-lg">3</div>
                        <h2 class="text-2xl font-bold text-gray-900">Secure Initial Payment</h2>
                    </div>
                    
                    <p class="text-gray-600 mb-6">Complete the payment of **?25,500** to confirm your booking instantly.</p>
                    
                    <!-- Payment Breakdown -->
                    <div class="space-y-3 p-4 bg-indigo-50 rounded-lg border border-indigo-200 mb-8">
                        <div class="flex justify-between items-center text-base">
                            <span class="text-gray-700">Security Deposit (2x Rent)</span>
                            <span class="font-semibold text-gray-800">?17,000</span>
                        </div>
                        <div class="flex justify-between items-center text-base">
                            <span class="text-gray-700">First Month's Rent</span>
                            <span class="font-semibold text-gray-800">?8,500</span>
                        </div>
                        <div class="border-t border-indigo-300 pt-3 flex justify-between items-center text-2xl font-extrabold text-indigo-600">
                            <span>TOTAL DUE NOW</span>
                            <span>?25,500</span>
                        </div>
                    </div>
                    
                    <!-- Payment Options -->
                    <div class="space-y-4">
                        <h3 class="font-semibold text-lg text-gray-800">Choose Your Method:</h3>
                        <label class="flex items-center space-x-3 p-5 border border-indigo-400 bg-indigo-50 rounded-xl cursor-pointer shadow-md">
                            <input type="radio" name="payment_method" value="upi" checked class="w-5 h-5 text-indigo-600 border-indigo-300 focus:ring-indigo-500">
                            <div class="flex-1">
                                <span class="font-bold text-gray-800">UPI (Preferred)</span>
                                <p class="text-sm text-gray-600">Instant transfer via Google Pay, PhonePe, or BHIM.</p>
                            </div>
                            <i data-lucide="scan" class="w-6 h-6 text-indigo-600"></i>
                        </label>
                        <label class="flex items-center space-x-3 p-5 border border-gray-300 bg-white rounded-xl cursor-pointer">
                            <input type="radio" name="payment_method" value="card" class="w-5 h-5 text-indigo-600 border-gray-300 focus:ring-indigo-500">
                            <div class="flex-1">
                                <span class="font-bold text-gray-800">Credit / Debit Card</span>
                                <p class="text-sm text-gray-600">Secure payment via Visa/MasterCard.</p>
                            </div>
                            <i data-lucide="credit-card" class="w-6 h-6 text-gray-500"></i>
                        </label>
                    </div>

                    <button id="pay-now-button-v2" class="mt-8 w-full bg-green-600 text-white px-6 py-4 rounded-xl hover:bg-green-700 transition duration-150 font-bold text-xl shadow-lg flex items-center justify-center space-x-3">
                        <i data-lucide="check-circle" class="w-6 h-6"></i>
                        <span>PAY ?25,500 NOW</span>
                    </button>
                    
                    <p id="payment-status-v2" class="hidden mt-4 text-center p-3 text-base bg-green-100 text-green-700 font-semibold border border-green-300 rounded-lg">
                        ? Booking confirmed! Please check your email for the receipt.
                    </p>
                </div>
            </div>

        </div>
    </main>

    <script>
        lucide.createIcons();

        // Initialize date
        const dateElement = document.getElementById('current-date-v2');
        if (dateElement) {
            dateElement.textContent = new Date().toLocaleDateString('en-IN', { year: 'numeric', month: 'long', day: 'numeric' });
        }

        const steps = document.querySelectorAll('.booking-step');
        const nextStepButtons = document.querySelectorAll('.next-step-button');
        const acceptAgreementCheckbox = document.getElementById('accept-agreement-v2');
        const agreementNextButton = document.getElementById('agreement-next-button-v2');
        const payNowButton = document.getElementById('pay-now-button-v2');
        const paymentStatus = document.getElementById('payment-status-v2');
        
        const stepPills = {
            1: document.getElementById('step-pill-1'),
            2: document.getElementById('step-pill-2'),
            3: document.getElementById('step-pill-3')
        };

        let currentStep = 1;

        // Function to update UI based on the current step
        function showStep(stepNumber) {
            currentStep = stepNumber;
            
            // Hide all content steps
            steps.forEach(step => step.classList.add('hidden'));
            
            // Show the target step
            const targetStepElement = document.getElementById(`step-${stepNumber}`);
            if (targetStepElement) {
                targetStepElement.classList.remove('hidden');
            }

            // Update step pills (navigation)
            for (let i = 1; i <= 3; i++) {
                const pill = stepPills[i];
                const icon = pill.querySelector('div:first-child');
                
                pill.classList.remove('opacity-50');
                
                if (i === stepNumber) {
                    icon.classList.remove('bg-gray-300', 'text-gray-600');
                    icon.classList.add('bg-indigo-600', 'text-white', 'shadow-lg');
                } else if (i < stepNumber) {
                    // Completed steps
                    icon.classList.remove('bg-indigo-600', 'text-white', 'shadow-lg');
                    icon.classList.add('bg-green-500', 'text-white');
                } else {
                    // Future steps
                    icon.classList.remove('bg-indigo-600', 'text-white', 'shadow-lg', 'bg-green-500');
                    icon.classList.add('bg-gray-300', 'text-gray-600');
                    pill.classList.add('opacity-50');
                }
            }

            // Scroll to the content block
            scrollToStep(stepNumber);
        }
        
        function scrollToStep(stepNumber) {
             const targetElement = document.getElementById(`step-${stepNumber}`);
             if (targetElement) {
                 window.scrollTo({
                     top: targetElement.offsetTop - 30, // Offset for a little padding
                     behavior: 'smooth'
                 });
             }
        }

        // Initialize step listeners for 'Next' buttons
        nextStepButtons.forEach(button => {
            button.addEventListener('click', () => {
                const nextStep = parseInt(button.getAttribute('data-next-step'));
                showStep(nextStep);
            });
        });

        // Step 2 Logic: Enabling 'Proceed to Payment'
        if (acceptAgreementCheckbox && agreementNextButton) {
            acceptAgreementCheckbox.addEventListener('change', () => {
                if (acceptAgreementCheckbox.checked) {
                    agreementNextButton.disabled = false;
                    agreementNextButton.classList.remove('bg-gray-400', 'cursor-not-allowed');
                    agreementNextButton.classList.add('bg-green-600', 'hover:bg-green-700');
                    agreementNextButton.querySelector('i').setAttribute('data-lucide', 'credit-card');
                    lucide.createIcons();
                } else {
                    agreementNextButton.disabled = true;
                    agreementNextButton.classList.add('bg-gray-400', 'cursor-not-allowed');
                    agreementNextButton.classList.remove('bg-green-600', 'hover:bg-green-700');
                    agreementNextButton.querySelector('i').setAttribute('data-lucide', 'lock');
                    lucide.createIcons();
                }
            });
        }
        
        // Step 3 Logic: Simulated Payment
        if (payNowButton) {
            payNowButton.addEventListener('click', () => {
                payNowButton.disabled = true;
                payNowButton.innerHTML = `<i data-lucide="loader" class="w-6 h-6 animate-spin"></i><span>Processing...</span>`;
                payNowButton.classList.remove('bg-green-600', 'hover:bg-green-700');
                payNowButton.classList.add('bg-gray-500', 'cursor-wait');
                lucide.createIcons();

                // Simulate payment gateway delay
                setTimeout(() => {
                    payNowButton.classList.add('hidden');
                    paymentStatus.classList.remove('hidden');
                    // Update step 3 pill to finalized
                    showStep(3); 
                    console.log("Payment of ?25,500 successful! Booking confirmed.");
                }, 3000);
            });
        }

        // Initial setup
        window.onload = () => showStep(1);
    </script>
</body>
</html>

