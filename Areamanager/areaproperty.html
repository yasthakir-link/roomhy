<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Roomhy - Area Properties</title>
    <script>
        const API_URL = 'https://roomhy-backend-wqwo.onrender.com';
    </script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="../website/js/area-manager-profile.js"></script>
    <!-- SheetJS for Excel Export -->
    <script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        
        /* --- Sidebar Styling --- */
        .sidebar { background-color: #111827; color: #9ca3af; }
        .sidebar-link {
            display: flex; align-items: center; padding: 0.75rem 1.5rem; 
            color: #9ca3af; font-weight: 500; font-size: 0.9rem;
            transition: all 0.2s; border-left: 3px solid transparent; cursor: pointer;
        }
        .sidebar-link:hover { background-color: #1f2937; color: #f3f4f6; }
        .sidebar-link.active { background-color: #1f2937; color: #ffffff; border-left-color: #a855f7; }

        /* Submenu Styling */
        .submenu { background-color: #0f172a; overflow: hidden; transition: max-height 0.3s ease-in-out; max-height: 0; }
        .submenu.open { max-height: 500px; }
        .submenu a { padding-left: 3.5rem; font-size: 0.85rem; }
        
        .excel-table th { background: #f9fafb; padding: 12px; font-size: 0.75rem; text-transform: uppercase; color: #6b7280; font-weight: 600; text-align: left; }
        .excel-table td { border-bottom: 1px solid #e5e7eb; padding: 12px; background: white; font-size: 0.875rem; vertical-align: middle; }
        
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 4px; }
    </style>
</head>
<body class="text-slate-800">
    <div class="flex h-screen overflow-hidden">
        <!-- Sidebar (Area Manager - Full) -->
        <aside class="sidebar w-72 flex-shrink-0 hidden md:flex flex-col z-20 overflow-y-auto custom-scrollbar">
            <div class="h-16 flex items-center px-6 border-b border-gray-800 sticky top-0 bg-[#111827] z-10">
                 <div class="flex items-center gap-3">
                     <div class="bg-purple-600 p-1.5 rounded-lg"><i data-lucide="map" class="w-5 h-5 text-white"></i></div>
                     <div><h1 class="text-xl font-bold text-white">RoomHy</h1><span class="text-[10px] text-gray-500">AREA ADMIN</span></div>
                 </div>
            </div>
            
            <nav class="flex-1 py-6 space-y-1">
                <div class="px-6 pb-2 text-xs font-semibold text-gray-500 uppercase tracking-wider">Overview</div>
                <a href="areaadmin.html" class="sidebar-link"><i data-lucide="layout-dashboard" class="w-5 h-5 mr-3"></i> Dashboard</a>

                <div class="mt-6 px-6 pb-2 text-xs font-semibold text-gray-500 uppercase tracking-wider">Management</div>
                <!-- Active Page -->
                <a href="areaproperty.html" class="sidebar-link active"><i data-lucide="home" class="w-5 h-5 mr-3"></i> Properties</a>
                <a href="visit.html" class="sidebar-link"><i data-lucide="clipboard-list" class="w-5 h-5 mr-3"></i> Visit Reports</a>
                <a href="areatenant.html" class="sidebar-link"><i data-lucide="users" class="w-5 h-5 mr-3"></i> Tenants</a>
                <a href="areaowner.html" class="sidebar-link"><i data-lucide="briefcase" class="w-5 h-5 mr-3"></i> Owners</a>
                

                <div class="mt-6 px-6 pb-2 text-xs font-semibold text-gray-500 uppercase tracking-wider">Operations</div>
                <a href="areapayment.html" class="sidebar-link"><i data-lucide="wallet" class="w-5 h-5 mr-3"></i> Payments</a>
                <a href="complaint.html" class="sidebar-link"><i data-lucide="alert-circle" class="w-5 h-5 mr-3"></i> Complaints & Maint.</a>
                <a href="#" class="sidebar-link disabled" onclick="event.preventDefault();"><i data-lucide="message-circle" class="w-5 h-5 mr-3"></i> Messages</a>
                <a href="areakyc.html" class="sidebar-link"><i data-lucide="file-check" class="w-5 h-5 mr-3"></i> KYC Verification</a>
                 <a href="areaenq.html" class="sidebar-link"><i data-lucide="help-circle" class="w-5 h-5 mr-3"></i> Enquiries</a>

                <div class="mt-6 px-6 pb-2 text-xs font-semibold text-gray-500 uppercase tracking-wider">System</div>
                 <a href="arealoc.html" class="sidebar-link"><i data-lucide="map-pin" class="w-5 h-5 mr-3"></i> RoomHy Location</a>
                 <a href="areareport.html" class="sidebar-link"><i data-lucide="bar-chart-2" class="w-5 h-5 mr-3"></i> Reports</a>
                 <a href="profile.html" class="sidebar-link"><i data-lucide="user" class="w-5 h-5 mr-3"></i> Profile</a>
                 <a href="setting.html" class="sidebar-link"><i data-lucide="settings" class="w-5 h-5 mr-3"></i> Settings</a>
            </nav>
        </aside>

        <div class="flex-1 flex flex-col overflow-hidden bg-[#f3f4f6]">
            <header class="bg-white h-16 flex items-center justify-between px-6 shadow-sm z-10">
                <div class="flex items-center">
                    <button id="mobile-menu-open" class="md:hidden mr-4 text-slate-500"><i data-lucide="menu" class="w-6 h-6"></i></button>
                    <div class="flex items-center">
                        <span class="text-slate-500 font-medium text-sm">Area:</span>
                        <span class="ml-2 px-3 py-1 rounded-full bg-purple-100 text-purple-700 text-xs font-bold" id="userAreaBadge">Loading...</span>
                    </div>
                </div>
                <div class="flex items-center gap-4">
                    <div class="relative group">
                        <button class="flex items-center gap-3 hover:bg-gray-50 p-1.5 rounded-full transition-colors">
                            <img src="https://i.pravatar.cc/150?u=areaadmin" alt="Admin" class="w-8 h-8 rounded-full border border-slate-200">
                            <div class="text-left hidden sm:block">
                                <p class="text-xs font-semibold text-gray-700" id="headerName">Manager</p>
                                <p class="text-[10px] text-gray-500" id="headerRole">Area Manager</p>
                            </div>
                            <i data-lucide="chevron-down" class="w-3 h-3 text-gray-400 hidden sm:block"></i>
                        </button>
                    </div>
                </div>
            </header>

            <main class="flex-1 overflow-y-auto p-8">
                <div class="max-w-7xl mx-auto">
                    <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                        <div>
                            <h1 class="text-2xl font-bold text-slate-800">My Area Properties</h1>
                            <p class="text-sm text-slate-500 mt-1">Manage all properties under your jurisdiction.</p>
                        </div>
                        <!-- Actions -->
                         <div class="flex gap-2">
                             <button onclick="exportToExcel()" class="bg-green-600 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-green-700 transition-colors flex items-center shadow-sm">
                                <i data-lucide="sheet" class="w-4 h-4 mr-2"></i> Export Excel
                             </button>
                         </div>
                    </div>

                    <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
                        <div class="overflow-x-auto">
                            <table class="w-full border-collapse excel-table" id="propertiesTable">
                                <thead>
                                    <tr>
                                        <th>Images</th> <!-- Image Column -->
                                        <th>Property Name</th>
                                        <th>Address</th>
                                        <th>Location Code</th>
                                        <th>Owner Name</th> <!-- Explicit Owner Name Column -->
                                        <th>Status</th>
                                        <th class="text-right">Actions</th>
                                        <th class="text-center w-16">Delete</th> <!-- Trash Column -->
                                    </tr>
                                </thead>
                                <tbody id="areaPropertiesTableBody">
                                    <tr><td colspan="8" class="text-center py-8 text-gray-500">Loading properties...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Image Gallery Modal -->
    <div id="imageModal" class="fixed inset-0 bg-black/90 hidden items-center justify-center z-50 backdrop-blur-sm z-[60]" onclick="closeImageModal()">
        <div class="relative w-full max-w-4xl p-4" onclick="event.stopPropagation()">
            <button onclick="closeImageModal()" class="absolute -top-10 right-0 text-white hover:text-gray-300"><i data-lucide="x" class="w-8 h-8"></i></button>
            <div id="galleryGrid" class="grid grid-cols-2 md:grid-cols-3 gap-4 max-h-[80vh] overflow-y-auto">
                <!-- Images will be injected here -->
            </div>
        </div>
    </div>

    <script>
        lucide.createIcons();
        let myAreaCode = '';
        let currentPropertiesData = [];

        // Auth Check - prefer manager_user then fall back to user
        document.addEventListener('DOMContentLoaded', () => {
            const user = JSON.parse(sessionStorage.getItem('manager_user') || sessionStorage.getItem('user') || localStorage.getItem('manager_user') || localStorage.getItem('user') || 'null');
            
            let myAreaCode = ''; 
            let myArea = ''; 
            let isAreaManager = false;
            let displayArea = '';

            if (user && user.role === 'areamanager') {
                isAreaManager = true;
                document.getElementById('headerName').innerText = user.name;
                displayArea = user.areaName || user.area || user.city || 'All Areas';
                document.getElementById('userAreaBadge').innerText = displayArea;
                myAreaCode = user.areaCode || '';
                myArea = '';
                loadAreaProperties(myAreaCode, myArea, isAreaManager);
            } else if (user && user.role === 'employee') {
                isAreaManager = false;
                document.getElementById('headerName').innerText = user.name;
                // Use location field if available, otherwise fallback to areaName > area > team
                displayArea = user.location || user.areaName || user.area || user.team || 'Team Member';
                document.getElementById('userAreaBadge').innerText = displayArea;
                myArea = user.location || user.area || user.areaName || user.team || '';
                myAreaCode = user.areaCode || '';
                loadAreaProperties(myAreaCode, myArea, isAreaManager);
            } else {
                console.log("Demo mode - defaulting to all properties");
                myAreaCode = 'KO';
                displayArea = "Koramangala (KO)";
                document.getElementById('userAreaBadge').innerText = displayArea;
                loadAreaProperties(myAreaCode, myArea, false);
            }
        });

        async function loadAreaProperties(areaCode, areaName, isAreaManager) {
                // Try backend first (if available) to fetch properties for this area
                try {
                    if (areaCode) {
                        const res = await fetch(`${API_URL}/api/properties?locationCode=${encodeURIComponent(areaCode)}`);
                        if (res.ok) {
                            const json = await res.json();
                            const props = (json.properties || json || []).map(p => ({
                                id: p._id || p.id,
                                title: p.title || p.name,
                                locationCode: p.locationCode || p.location,
                                propertyArea: p.area || areaName,
                                ownerName: (p.owner && p.owner.name) || p.ownerName || p.ownerLoginId || 'Owner',
                                phone: p.owner && p.owner.phone || '',
                                address: p.address || '-',
                                photos: p.photos || [],
                                status: p.status || 'inactive'
                            }));
                            renderFilteredProperties(props, areaCode, areaName, isAreaManager);
                            return;
                        }
                    }
                } catch (e) {
                    console.warn('Backend properties fetch failed, falling back to local visits', e.message);
                }

                // Fallback: Read from roomhy_visits
                const visits = JSON.parse(localStorage.getItem('roomhy_visits') || '[]');
                const approvedProps = visits
                    .filter(v => v.status === 'approved')
                    .map(v => ({
                        id: v._id,
                        title: v.propertyInfo.name,
                        locationCode: v.propertyInfo.locationCode,
                        propertyArea: v.propertyArea || areaName,
                        ownerName: v.propertyInfo.ownerName || 'Generated Owner',
                        phone: v.propertyInfo.contactPhone,
                        address: v.propertyInfo.address || '-',
                        photos: v.photos || [],
                        imageBase64: v.imageBase64,
                        status: 'active'
                    }));
                renderFilteredProperties(approvedProps, areaCode, areaName, isAreaManager);
        }

        function renderFilteredProperties(props, areaCode, areaName, isAreaManager) {
            const tbody = document.getElementById('areaPropertiesTableBody');
            tbody.innerHTML = '';

            // Filter by area: employees see only their area, area managers see all
            let myProps = props;
            if (!isAreaManager && areaName) {
                myProps = props.filter(p => p.propertyArea === areaName);
            } else if (areaCode) {
                // Backward compatibility: filter by area code if area manager has one
                myProps = props.filter(p => (p.locationCode || '').toUpperCase() === areaCode);
            }

            if (myProps.length === 0) {
                const msg = areaName ? `No properties found for ${areaName}.` : (areaCode ? `No properties found for ${areaCode}.` : 'No properties found.');
                tbody.innerHTML = `<tr><td colspan="8" class="text-center py-8 text-gray-500">${msg}</td></tr>`;
                return;
            }

            currentPropertiesData = []; // Reset for export

            myProps.forEach(p => {
                currentPropertiesData.push({
                    "Property Name": p.title,
                    "Address": p.address,
                    "Location Code": p.locationCode,
                    "Owner Name": p.ownerName,
                    "Owner Phone": p.phone,
                    "Status": "Active"
                });

                let thumbnail = '<div class="w-10 h-10 bg-gray-100 rounded flex items-center justify-center text-xs text-gray-400 mx-auto">No Img</div>';
                let photos = p.photos || [];
                if(p.imageBase64) photos.unshift(p.imageBase64);

                if(photos.length > 0) {
                    thumbnail = `
                        <div class="relative group cursor-pointer w-10 h-10 mx-auto" onclick='openGallery(${JSON.stringify(photos)})'>
                            <img src="${photos[0]}" class="w-full h-full rounded object-cover border border-gray-200 shadow-sm">
                            <div class="absolute inset-0 bg-black/50 rounded flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                                <span class="text-white text-[9px] font-bold">+${photos.length}</span>
                            </div>
                        </div>`;
                }

                tbody.innerHTML += `
                    <tr class="hover:bg-gray-50 border-b border-gray-100" id="row-${p.id}">
                        <td class="text-center align-middle">${thumbnail}</td>
                        <td class="font-medium text-slate-800">${p.title}</td>
                        <td class="text-sm text-gray-600 max-w-xs truncate" title="${p.address}">${p.address}</td>
                        <td><span class="bg-blue-50 text-blue-700 px-2 py-1 rounded text-xs font-mono">${p.locationCode}</span></td>
                        <td class="text-sm text-gray-800 font-medium">
                            ${p.ownerName} 
                            <span class="block text-xs text-gray-500 font-normal">${p.phone || '-'}</span>
                        </td>
                        <td><span class="px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800">Active</span></td>
                        <td class="text-right"><button class="text-purple-600 hover:text-purple-800 text-sm font-medium">Manage</button></td>
                        <td class="text-center">
                            <button onclick="deleteProperty('${p.id}')" class="text-red-500 hover:bg-red-50 p-2 rounded transition" title="Delete Property">
                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });
            lucide.createIcons();
        }

        function deleteProperty(id) {
            if(!confirm("Are you sure you want to delete this property? This will remove the visit record.")) return;

            let visits = JSON.parse(localStorage.getItem('roomhy_visits') || '[]');
            const newVisits = visits.filter(v => v._id !== id);
            if (window.safeStorage && typeof window.safeStorage.setVisits === 'function') {
                window.safeStorage.setVisits(newVisits);
            } else {
                try { localStorage.setItem('roomhy_visits', JSON.stringify(newVisits)); } catch(e) { console.error('Failed saving visits:', e); }
            }
            
            const row = document.getElementById(`row-${id}`);
            if(row) row.remove();
            
            alert("Property deleted.");
            loadAreaProperties();
        }

        function exportToExcel() {
            if(currentPropertiesData.length === 0) {
                alert("No data to export.");
                return;
            }
            const ws = XLSX.utils.json_to_sheet(currentPropertiesData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Area_Properties");
            const date = new Date().toISOString().split('T')[0];
            XLSX.writeFile(wb, `Roomhy_Area_Props_${myAreaCode}_${date}.xlsx`);
        }

        function openGallery(photos) {
            const grid = document.getElementById('galleryGrid');
            grid.innerHTML = '';
            photos.forEach(src => {
                grid.innerHTML += `<img src="${src}" class="w-full h-48 object-cover rounded-lg border border-gray-600 shadow-lg">`;
            });
            document.getElementById('imageModal').classList.remove('hidden');
            document.getElementById('imageModal').classList.add('flex');
        }

        function closeImageModal() {
            document.getElementById('imageModal').classList.add('hidden');
            document.getElementById('imageModal').classList.remove('flex');
        }
    </script>
</body>
</html>
