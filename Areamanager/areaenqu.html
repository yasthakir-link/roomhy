<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Roomhy - My Assigned Property Enquiries</title>
    <script>
        const API_URL = 'https://roomhy-backend-wqwo.onrender.com';
    </script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        
        /* --- Sidebar Styling (Dark Theme) --- */
        .sidebar {
            background-color: #111827;
            color: #9ca3af;
        }
        .sidebar-link {
            color: #9ca3af;
            font-weight: 500;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            padding: 0.75rem 1.5rem;
            font-size: 0.9rem;
            border-left: 3px solid transparent;
            cursor: pointer;
        }
        .sidebar-link:hover {
            color: #f3f4f6; 
            background-color: #1f2937;
        }
        .sidebar-link.active {
            background-color: #1f2937;
            color: #ffffff;
            border-left-color: #a855f7;
        }

        /* Table Styling */
        .data-table th {
            background-color: #f9fafb;
            color: #6b7280;
            font-weight: 600;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            border-bottom: 1px solid #e5e7eb;
            padding: 0.75rem 1.5rem;
            text-align: left;
        }
        .data-table td {
            border-bottom: 1px solid #e5e7eb;
            padding: 1rem 1.5rem;
            font-size: 0.875rem;
            color: #1f2937;
        }
        .data-table tr:hover td {
            background-color: #f9fafb;
        }
        
        /* Custom Scrollbar */
        .custom-scrollbar::-webkit-scrollbar {
            width: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: #cbd5e1;
            border-radius: 4px;
        }
    </style>
</head>
<body class="text-slate-800">
    <div class="flex h-screen overflow-hidden">
        <!-- Sidebar -->
        <aside class="sidebar w-72 flex-shrink-0 hidden md:flex flex-col z-20 overflow-y-auto custom-scrollbar">
            <div class="h-16 flex items-center px-6 border-b border-gray-800 sticky top-0 bg-[#111827] z-10">
                <div class="flex items-center gap-3">
                    <div class="bg-blue-600 p-1.5 rounded-lg"><i data-lucide="building-2" class="w-5 h-5 text-white"></i></div>
                    <div><h1 class="text-xl font-bold text-white">RoomHy</h1><span class="text-[10px] text-gray-500">AREA MANAGER</span></div>
                </div>
            </div>
            <nav class="flex-1 py-6 space-y-1">
                <div class="px-6 pb-2 text-xs font-semibold text-gray-500 uppercase tracking-wider">Dashboard</div>
                <a href="#" class="sidebar-link"><i data-lucide="layout-dashboard" class="w-5 h-5 mr-3"></i> Overview</a>
                <div class="mt-6 px-6 pb-2 text-xs font-semibold text-gray-500 uppercase tracking-wider">Operations</div>
                <a href="#" class="sidebar-link active"><i data-lucide="inbox" class="w-5 h-5 mr-3"></i> Assigned Enquiries</a>
                <a href="#" class="sidebar-link"><i data-lucide="check-circle" class="w-5 h-5 mr-3"></i> Completed</a>
                <a href="#" class="sidebar-link"><i data-lucide="map-pin" class="w-5 h-5 mr-3"></i> My Area</a>
            </nav>
        </aside>

        <!-- Main Content -->
        <div class="flex-1 flex flex-col overflow-hidden bg-[#f3f4f6]">
            <!-- Top Header -->
            <header class="bg-white h-16 flex items-center justify-between px-6 shadow-sm z-10">
                <div class="flex items-center">
                    <button id="mobile-menu-open" class="md:hidden mr-4 text-slate-500"><i data-lucide="menu" class="w-6 h-6"></i></button>
                    <div class="flex items-center text-sm">
                        <span class="text-slate-500 font-medium">Area Manager</span>
                        <i data-lucide="chevron-right" class="w-4 h-4 mx-2 text-slate-400"></i>
                        <span class="text-slate-800 font-semibold">Assigned Property Enquiries</span>
                    </div>
                </div>
                <div class="flex items-center gap-4">
                    <button class="text-slate-400 hover:text-slate-600"><i data-lucide="bell" class="w-5 h-5"></i></button>
                </div>
            </header>

            <!-- Scrollable Content -->
            <main class="flex-1 overflow-y-auto p-6 md:p-8">
                <div class="max-w-7xl mx-auto">
                    
                    <!-- Page Header -->
                    <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-6">
                        <div>
                            <h1 class="text-2xl font-bold text-slate-800">My Assigned Property Enquiries</h1>
                            <p class="text-sm text-slate-500 mt-1">Properties assigned to you for verification and follow-up.</p>
                        </div>
                    </div>

                    <!-- Stats -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
                        <div class="bg-white p-4 rounded-lg border border-gray-200">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm text-gray-600">Total Assigned</p>
                                    <p class="text-2xl font-bold text-slate-800" id="total-assigned">0</p>
                                </div>
                                <i data-lucide="inbox" class="w-8 h-8 text-blue-500"></i>
                            </div>
                        </div>
                        <div class="bg-white p-4 rounded-lg border border-gray-200">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm text-gray-600">Pending Review</p>
                                    <p class="text-2xl font-bold text-yellow-600" id="pending-review">0</p>
                                </div>
                                <i data-lucide="clock" class="w-8 h-8 text-yellow-500"></i>
                            </div>
                        </div>
                        <div class="bg-white p-4 rounded-lg border border-gray-200">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm text-gray-600">Completed</p>
                                    <p class="text-2xl font-bold text-green-600" id="completed">0</p>
                                </div>
                                <i data-lucide="check-circle" class="w-8 h-8 text-green-500"></i>
                            </div>
                        </div>
                    </div>

                    <!-- Filters -->
                    <div class="bg-white p-4 rounded-lg border border-gray-200 mb-6">
                        <div class="flex flex-col md:flex-row gap-4">
                            <div class="flex-1">
                                <input type="text" id="search-input" placeholder="Search by property name, owner..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                            <select id="status-filter" class="px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="">All Status</option>
                                <option value="pending">Pending Review</option>
                                <option value="completed">Completed</option>
                            </select>
                        </div>
                    </div>

                    <!-- Table -->
                    <div class="bg-white rounded-lg border border-gray-200 overflow-hidden">
                        <div class="overflow-x-auto">
                            <table class="w-full data-table">
                                <thead>
                                    <tr>
                                        <th>Property</th>
                                        <th>Owner</th>
                                        <th>Locality</th>
                                        <th>Type</th>
                                        <th>Price</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="enquiries-tbody">
                                    <tr>
                                        <td colspan="7" class="text-center py-8 text-gray-500">
                                            <p class="text-sm">Loading enquiries...</p>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Details Modal -->
    <div id="details-modal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-lg max-w-2xl w-full max-h-96 overflow-y-auto">
            <div class="border-b border-gray-200 p-4 flex items-center justify-between sticky top-0 bg-white">
                <h2 class="text-lg font-semibold">Enquiry Details</h2>
                <button onclick="closeDetailsModal()" class="text-gray-400 hover:text-gray-600">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            <div id="details-content" class="p-6"></div>
        </div>
    </div>

    <!-- Status Update Modal -->
    <div id="status-modal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-lg max-w-md w-full">
            <div class="border-b border-gray-200 p-4 flex items-center justify-between">
                <h2 class="text-lg font-semibold">Update Status</h2>
                <button onclick="closeStatusModal()" class="text-gray-400 hover:text-gray-600">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            <div class="p-6">
                <input type="hidden" id="modal-enquiry-id">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Update Status</label>
                    <select id="status-select" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="pending">Pending Review</option>
                        <option value="completed">Completed</option>
                    </select>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Notes</label>
                    <textarea id="notes-input" rows="3" placeholder="Add any notes..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                </div>
                <div class="flex gap-3">
                    <button onclick="closeStatusModal()" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg text-gray-700 font-medium hover:bg-gray-50">Cancel</button>
                    <button onclick="updateStatus()" class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700">Update</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        lucide.createIcons();

        let assignedEnquiries = [];
        let filteredEnquiries = [];
        const managerId = localStorage.getItem('manager_id') || '1'; // Default to manager 1

        // Load enquiries assigned to this manager
        function loadEnquiries() {
            assignedEnquiries = JSON.parse(localStorage.getItem('roomhy_area_enquiries_' + managerId) || '[]');
            updateStats();
            filterEnquiries();
        }

        // Update statistics
        function updateStats() {
            const total = assignedEnquiries.length;
            const pending = assignedEnquiries.filter(e => e.status !== 'completed').length;
            const completed = assignedEnquiries.filter(e => e.status === 'completed').length;

            document.getElementById('total-assigned').textContent = total;
            document.getElementById('pending-review').textContent = pending;
            document.getElementById('completed').textContent = completed;
        }

        // Filter enquiries
        function filterEnquiries() {
            const searchTerm = document.getElementById('search-input').value.toLowerCase();
            const statusFilter = document.getElementById('status-filter').value;

            filteredEnquiries = assignedEnquiries.filter(e => {
                const matchSearch = !searchTerm || 
                    e.property_name.toLowerCase().includes(searchTerm) ||
                    e.owner_name.toLowerCase().includes(searchTerm);
                
                const matchStatus = !statusFilter || e.status === statusFilter;

                return matchSearch && matchStatus;
            });

            renderEnquiries();
        }

        // Render enquiries in table
        function renderEnquiries() {
            const tbody = document.getElementById('enquiries-tbody');
            
            if (filteredEnquiries.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center py-8 text-gray-500"><p class="text-sm">No enquiries found.</p></td></tr>';
                return;
            }

            tbody.innerHTML = filteredEnquiries.map(e => `
                <tr>
                    <td><strong>${e.property_name}</strong></td>
                    <td>${e.owner_name}</td>
                    <td>${e.locality}</td>
                    <td>
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${
                            e.property_type === 'pg' ? 'bg-blue-100 text-blue-800' :
                            e.property_type === 'hostel' ? 'bg-green-100 text-green-800' :
                            'bg-purple-100 text-purple-800'
                        }">
                            ${e.property_type.toUpperCase()}
                        </span>
                    </td>
                    <td><strong>₹${e.rent.toLocaleString()}</strong>/month</td>
                    <td>
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${
                            e.status === 'completed' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'
                        }">
                            ${e.status === 'completed' ? 'Completed' : 'Pending Review'}
                        </span>
                    </td>
                    <td>
                        <div class="flex gap-2">
                            <button onclick="viewDetails('${e.id}')" class="text-blue-600 hover:text-blue-800 p-1" title="View Details">
                                <i data-lucide="eye" class="w-4 h-4"></i>
                            </button>
                            <button onclick="openStatusModal('${e.id}')" class="text-purple-600 hover:text-purple-800 p-1" title="Update Status">
                                <i data-lucide="edit" class="w-4 h-4"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
            
            lucide.createIcons();
        }

        // View details
        function viewDetails(id) {
            const enquiry = assignedEnquiries.find(e => e.id === id);
            if (!enquiry) return;

            const modal = document.getElementById('details-modal');
            const content = document.getElementById('details-content');

            content.innerHTML = `
                <div class="space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <p class="text-xs text-gray-600">Property Name</p>
                            <p class="font-semibold">${enquiry.property_name}</p>
                        </div>
                        <div>
                            <p class="text-xs text-gray-600">Type</p>
                            <p class="font-semibold">${enquiry.property_type.toUpperCase()}</p>
                        </div>
                        <div>
                            <p class="text-xs text-gray-600">Owner Name</p>
                            <p class="font-semibold">${enquiry.owner_name}</p>
                        </div>
                        <div>
                            <p class="text-xs text-gray-600">Owner Email</p>
                            <p class="font-semibold text-sm">${enquiry.owner_email}</p>
                        </div>
                        <div>
                            <p class="text-xs text-gray-600">Owner Phone</p>
                            <p class="font-semibold">${enquiry.owner_phone}</p>
                        </div>
                        <div>
                            <p class="text-xs text-gray-600">Submitted Date</p>
                            <p class="font-semibold">${new Date(enquiry.submitted_date).toLocaleString()}</p>
                        </div>
                    </div>
                    <hr>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <p class="text-xs text-gray-600">Locality</p>
                            <p class="font-semibold">${enquiry.locality}</p>
                        </div>
                        <div class="col-span-2">
                            <p class="text-xs text-gray-600">Full Address</p>
                            <p class="font-semibold">${enquiry.address}, ${enquiry.pincode}</p>
                        </div>
                        <div>
                            <p class="text-xs text-gray-600">Gender Suitability</p>
                            <p class="font-semibold capitalize">${enquiry.gender_suitability}</p>
                        </div>
                        <div>
                            <p class="text-xs text-gray-600">Starting Price</p>
                            <p class="font-semibold">₹${enquiry.rent.toLocaleString()}/month</p>
                        </div>
                    </div>
                    <hr>
                    <div>
                        <p class="text-xs text-gray-600">Amenities</p>
                        <div class="flex flex-wrap gap-2 mt-2">
                            ${enquiry.amenities.map(a => `<span class="bg-blue-100 text-blue-800 px-2 py-1 rounded text-xs">${a}</span>`).join('')}
                        </div>
                    </div>
                    ${enquiry.description ? `
                        <div>
                            <p class="text-xs text-gray-600">Description</p>
                            <p class="text-sm">${enquiry.description}</p>
                        </div>
                    ` : ''}
                </div>
            `;
            
            modal.classList.remove('hidden');
        }

        function closeDetailsModal() {
            document.getElementById('details-modal').classList.add('hidden');
        }

        // Status update functions
        function openStatusModal(id) {
            const enquiry = assignedEnquiries.find(e => e.id === id);
            document.getElementById('modal-enquiry-id').value = id;
            document.getElementById('status-select').value = enquiry.status || 'pending';
            document.getElementById('notes-input').value = enquiry.notes || '';
            document.getElementById('status-modal').classList.remove('hidden');
        }

        function closeStatusModal() {
            document.getElementById('status-modal').classList.add('hidden');
        }

        function updateStatus() {
            const id = document.getElementById('modal-enquiry-id').value;
            const status = document.getElementById('status-select').value;
            const notes = document.getElementById('notes-input').value;

            const enquiry = assignedEnquiries.find(e => e.id === id);
            if (enquiry) {
                enquiry.status = status;
                enquiry.notes = notes;
                enquiry.last_updated = new Date().toISOString();

                localStorage.setItem('roomhy_area_enquiries_' + managerId, JSON.stringify(assignedEnquiries));
                closeStatusModal();
                updateStats();
                filterEnquiries();
                alert('Status updated successfully!');
            }
        }

        // Event listeners
        document.getElementById('search-input').addEventListener('input', filterEnquiries);
        document.getElementById('status-filter').addEventListener('change', filterEnquiries);

        // Initial load
        loadEnquiries();
    </script>
</body>
</html>
