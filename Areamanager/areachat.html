<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Area Manager - Support Chat</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { font-family: 'Inter', sans-serif; }
        .message-own { @apply bg-orange-100 border-l-4 border-orange-500 ml-auto mr-0 max-w-xs; }
        .message-other { @apply bg-gray-100 border-l-4 border-gray-400 ml-0 mr-auto max-w-xs; }
    </style>
</head>
<body class="bg-gray-50">
    <div class="flex h-screen">
        <!-- Sidebar -->
        <div class="w-64 bg-white border-r border-gray-200 flex flex-col">
            <div class="p-6 border-b border-gray-200">
                <h1 class="text-xl font-bold text-orange-600">üõ°Ô∏è Support Chat</h1>
            </div>
            
            <!-- New Chat Button -->
            <div class="px-4 py-3 border-b border-gray-200">
                <button onclick="openNewChatModal()" class="w-full px-4 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700 text-sm font-medium">
                    + New Support Request
                </button>
            </div>

            <!-- Support Requests List -->
            <div class="flex-1 overflow-y-auto p-4">
                <h3 class="text-sm font-semibold text-gray-700 mb-4">Support Requests</h3>
                <div id="requestsList" class="space-y-2">
                    <div class="p-3 bg-gray-100 rounded text-center text-gray-500 text-sm">Loading...</div>
                </div>
            </div>

            <!-- Logout -->
            <div class="p-4 border-t border-gray-200">
                <button onclick="logout()" class="w-full px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 text-sm font-medium">
                    Logout
                </button>
            </div>
        </div>

        <!-- Main Chat Area -->
        <div class="flex-1 flex flex-col bg-white">
            <!-- Header -->
            <div id="chatHeader" class="h-16 bg-orange-50 border-b border-gray-200 flex items-center justify-between px-6">
                <div>
                    <h2 id="chatTitle" class="font-bold text-gray-800">Select a support request</h2>
                    <p id="chatSubtitle" class="text-xs text-gray-500 mt-1"></p>
                    <p id="chatId" class="text-xs text-orange-600 font-mono mt-0.5"></p>
                </div>
            </div>

            <!-- Messages -->
            <div id="messagesArea" class="flex-1 overflow-y-auto p-6 space-y-4">
                <div class="text-center text-gray-400 mt-20">
                    <i data-lucide="lifebelt" class="w-16 h-16 mx-auto mb-4 opacity-30"></i>
                    <p>Select a support request to begin</p>
                </div>
            </div>

            <!-- Input Area -->
            <div id="inputArea" class="hidden border-t border-gray-200 bg-gray-50 p-6">
                <div class="flex gap-3">
                    <input type="text" id="messageInput" placeholder="Type your response..." 
                        class="flex-1 px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500"
                        onkeypress="handleKeyPress(event)">
                    <button onclick="sendMessage()" class="px-6 py-3 bg-orange-600 text-white rounded-lg hover:bg-orange-700 font-medium">
                        Send
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- New Chat Modal -->
    <div id="newChatModal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-lg max-w-md w-full max-h-96 overflow-hidden flex flex-col">
            <div class="p-6 border-b border-gray-200 flex justify-between items-center">
                <h3 class="text-lg font-bold text-gray-800">Start New Support Chat</h3>
                <button onclick="closeNewChatModal()" class="text-gray-500 hover:text-gray-700">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            <div id="availableIdsList" class="flex-1 overflow-y-auto p-4 space-y-2">
                <div class="text-center text-gray-500 py-8">Loading available contacts...</div>
            </div>
        </div>
    </div>
        const API_URL = 'https://roomhy-backend-wqwo.onrender.com';
        let socket = null;
        let loginId = null;
        let currentChat = null;
        let allSupportRequests = [];
        document.addEventListener('DOMContentLoaded', async () => {
            const user = JSON.parse(localStorage.getItem('manager_user') || 'null');
            if (!user || !user.loginId) {
                window.location.href = '/propertyowner/ownerlogin.html';
                return;
            }

            loginId = user.loginId;
            console.log('‚úì Area Manager logged in:', loginId);

            initSocket();
            loadSupportRequests();
            lucide.createIcons();
        });

        // Initialize Socket.IO
        function initSocket() {
            socket = io(API_URL);

            socket.on('connect', () => {
                console.log('‚úì Connected to chat');
                socket.emit('join_room', {
                    login_id: loginId,
                    role: 'areamanager',
                    name: 'Support Manager'
                });
            });

            socket.on('receive_message', (msg) => {
                if (currentChat && msg.sender_login_id === currentChat.login_id) {
                    displayMessage(msg, false);
                    loadSupportRequests(); // Refresh list
                }
            });

            socket.on('error', (data) => {
                console.error('Socket error:', data);
            });
        }

        // Load support requests - show all owners
        function loadSupportRequests() {
            let allOwners = [];

            // Load from rooms data - extract unique owners
            const rooms = JSON.parse(localStorage.getItem('roomhy_rooms') || '[]');
            rooms.forEach(room => {
                if (room.owner_id && room.owner_name) {
                    const existing = allOwners.find(o => o.login_id === room.owner_id);
                    if (!existing) {
                        allOwners.push({
                            login_id: room.owner_id,
                            name: room.owner_name,
                            type: 'owner'
                        });
                    }
                }
            });

            // Load from bookings data - extract unique owners
            const bookings = JSON.parse(localStorage.getItem('roomhy_bookings') || '[]');
            if (Array.isArray(bookings)) {
                bookings.forEach(booking => {
                    if (booking.owner_id && booking.owner_name) {
                        const existing = allOwners.find(o => o.login_id === booking.owner_id);
                        if (!existing) {
                            allOwners.push({
                                login_id: booking.owner_id,
                                name: booking.owner_name,
                                type: 'owner'
                            });
                        }
                    }
                });
            }

            // Also load any stored support requests
            const supportRequests = JSON.parse(localStorage.getItem('roomhy_support_requests') || '[]');
            allSupportRequests = supportRequests.concat(allOwners);

            // Deduplicate
            const seen = new Set();
            allSupportRequests = allSupportRequests.filter(req => {
                if (seen.has(req.login_id)) return false;
                seen.add(req.login_id);
                return true;
            });

            const list = document.getElementById('requestsList');
            if (allSupportRequests.length === 0) {
                list.innerHTML = '<div class="p-3 text-center text-gray-500 text-sm">No support requests. Add one above.</div>';
                return;
            }

            list.innerHTML = allSupportRequests.map(req => `
                <div class="request-item p-3 bg-white border border-gray-200 rounded-lg cursor-pointer hover:bg-orange-50 transition ${currentChat?.login_id === req.login_id ? 'bg-orange-100 border-orange-300' : ''}"
                    onclick="selectChat('${req.login_id}', '${req.name}', '${req.type || 'owner'}')">
                    <p class="font-medium text-gray-800 text-sm">${req.name}</p>
                    <p class="text-xs text-gray-500 mt-1">${req.type === 'tenant' ? 'üë§ Tenant' : 'üè† Owner'}</p>
                </div>
            `).join('');
        }

        // Select a support request
        async function selectChat(login_id, name, type) {
            currentChat = { login_id, name, type };
            
            document.getElementById('chatTitle').textContent = name;
            document.getElementById('chatSubtitle').textContent = type === 'owner' ? 'Property Owner' : 'Tenant';
            document.getElementById('chatId').textContent = 'ID: ' + login_id;
            document.getElementById('messagesArea').innerHTML = '';
            document.getElementById('inputArea').classList.remove('hidden');

            // Load message history
            try {
                const response = await fetch(`${API_URL}/api/chat/messages/${login_id}`);
                let messages = [];
                
                if (response.ok) {
                    messages = await response.json();
                } else if (response.status === 404) {
                    // No messages yet - this is normal for new chats
                    console.log(`üìù New chat - no message history yet for ${login_id}`);
                } else {
                    console.error(`API Error: ${response.status} ${response.statusText}`);
                }

                if (messages.length === 0) {
                    document.getElementById('messagesArea').innerHTML = '<p class="text-center text-gray-400 mt-8">No messages yet</p>';
                } else {
                    messages.forEach(msg => displayMessage(msg, msg.sender_login_id === loginId));
                }
            } catch (error) {
                console.error('Error loading messages:', error);
                document.getElementById('messagesArea').innerHTML = '<p class="text-center text-gray-400 mt-8">Ready to chat!</p>';
            }

            // Update active state
            document.querySelectorAll('.request-item').forEach(item => {
                item.classList.remove('bg-orange-100', 'border-orange-300');
            });
            event?.target?.closest('.request-item')?.classList.add('bg-orange-100', 'border-orange-300');
        }

        // Send message
        function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();

            if (!message || !currentChat) {
                alert('Select a request and enter a message');
                return;
            }

            socket.emit('send_message', {
                to_login_id: currentChat.login_id,
                message: message
            });

            input.value = '';
            input.focus();
        }

        // Display message
        function displayMessage(msg, isOwn) {
            const area = document.getElementById('messagesArea');
            const div = document.createElement('div');
            
            div.className = `flex ${isOwn ? 'justify-end' : 'justify-start'} mb-3`;
            div.innerHTML = `
                <div class="message-item ${isOwn ? 'message-own' : 'message-other'} p-4 rounded-lg">
                    <p class="text-xs font-semibold text-gray-600 mb-1">${msg.sender_name}</p>
                    <p class="text-gray-800 text-sm break-words">${escapeHtml(msg.message)}</p>
                    <p class="text-xs text-gray-500 mt-2">${new Date(msg.created_at).toLocaleTimeString()}</p>
                </div>
            `;
            
            area.appendChild(div);
            area.scrollTop = area.scrollHeight;
        }

        // Utilities
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        function logout() {
            localStorage.removeItem('manager_user');
            window.location.href = '/propertyowner/ownerlogin.html';
        }

        // New Chat Modal - Show Available IDs as Clickable Buttons
        function openNewChatModal() {
            // Collect all available IDs
            const availableIds = [];
            
            // Get IDs from rooms (owners)
            const rooms = JSON.parse(localStorage.getItem('roomhy_rooms') || '[]');
            rooms.forEach(room => {
                if (room.owner_id && room.owner_name) {
                    const existing = availableIds.find(a => a.id === room.owner_id);
                    if (!existing) {
                        availableIds.push({
                            id: room.owner_id,
                            name: room.owner_name,
                            type: 'owner',
                            label: room.owner_name
                        });
                    }
                }
                if (room.beds) {
                    room.beds.forEach(bed => {
                        if (bed.tenantId && bed.tenantName) {
                            const tid = `tenant_${room.id}_${bed.tenantId}`;
                            const existing = availableIds.find(a => a.id === tid);
                            if (!existing) {
                                availableIds.push({
                                    id: tid,
                                    name: bed.tenantName,
                                    type: 'tenant',
                                    label: `${bed.tenantName} (Room ${room.number || room.name})`
                                });
                            }
                        }
                    });
                }
            });

            // Get IDs from bookings
            const bookings = JSON.parse(localStorage.getItem('roomhy_bookings') || '[]');
            if (Array.isArray(bookings)) {
                bookings.forEach(booking => {
                    if (booking.tenant_email && booking.tenant_name) {
                        const webId = `web_user_${booking.tenant_email.split('@')[0].toLowerCase().replace(/[^a-z0-9]/g, '_')}`;
                        const existing = availableIds.find(a => a.id === webId);
                        if (!existing) {
                            availableIds.push({
                                id: webId,
                                name: booking.tenant_name,
                                type: 'website',
                                label: `${booking.tenant_name} (${booking.tenant_email})`
                            });
                        }
                    }
                });
            }

            // Render modal
            const list = document.getElementById('availableIdsList');
            if (availableIds.length === 0) {
                list.innerHTML = '<div class="text-center text-gray-500 py-8">No contacts available. Use "+ New Support Request" button to add manually.</div>';
            } else {
                list.innerHTML = availableIds.map(contact => `
                    <button onclick="selectChat('${contact.id}', '${contact.name}', '${contact.type}'); closeNewChatModal();"
                        class="w-full p-3 text-left bg-white border border-gray-200 rounded-lg hover:bg-orange-50 hover:border-orange-300 transition">
                        <p class="font-medium text-gray-800 text-sm">${contact.name}</p>
                        <p class="text-xs text-gray-500 mt-1">ID: ${contact.id}</p>
                        <p class="text-xs text-gray-400 mt-1">${contact.type === 'owner' ? 'üè† Owner' : 'üë§ Tenant'}</p>
                    </button>
                `).join('');
            }

            document.getElementById('newChatModal').classList.remove('hidden');
        }

        function closeNewChatModal() {
            document.getElementById('newChatModal').classList.add('hidden');
        }
    </script>
</body>
</html>
